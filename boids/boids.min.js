const CAMERA_ROTATION_SPEED=.05,CAMERA_FOLLOW_SPEED=.4,CAMERA_SCALE_SPEED=.02,CAMERA_MINIMAL_SCALE=.5,CAMERA_MAXIMAL_SCALE=1,CAMERA_MAXIMAL_SCALE_HANDLEVEL=35;var Client=e=>{var t={keyToConstructor:{},spoolKeyToConstructor:{SPL_POINT:{const:Point},SPL_LINE:{const:Line},SPL_RECT:{const:Rectangle}},onMouseEvent:e=>{},onKeyEvent:e=>{},lastTime:0,frameCounter:0,chunkSize:1e3,FPS:60,pureLocalClient:!1,updateOnLoop:!1,serverSideLoading:!1,clientSideLoading:!1,...e};return t.frameTime=1e3/t.FPS,t.clientId=void 0,t.clientObject=void 0,t.width=window.innerWidth,t.height=window.innerHeight,t.gameArea=GameArea(t.width,t.height),t.camera=Camera({width:t.width,height:t.height,canvasWidth:t.width,canvasHeight:t.height}),t.handler=ClientHandler(t.chunkSize,t,t.pureLocalClient),t.uiHandler=SpoolUIHandler(),t.objectServer=ClientObjectServer(t),t.socketInit=(()=>{t.pureLocalClient&&console.warn("You've set the pureLocalClient flag to true, but are initializing sockets."),t.socket=io(),t.socket.on(MessageCodes.SM_PACK_INIT,e=>{for(key in e.resetHandler&&(t.handler.reset(),t.clientObject=void 0),e)if("resetHandler"!=key){var o=void 0;if(key in t.keyToConstructor?o=t.keyToConstructor[key]:key in t.spoolKeyToConstructor&&(o=t.spoolKeyToConstructor[key]),o)for(var r=0;r<e[key].length;r++){o.const||console.warn(`Spool: ${key} has invalid constructor function`);var n=o.const({...o.defs,...e[key][r]});n||console.error(`Object ${key} doesn't return anything, check if constructor returns self.`),n.clientInstance=t,t.handler.add(n)}else console.error(`Object ${key} doesn't have a constructor`)}t.firstInit||(t.onFirstLoad&&t.onFirstLoad(t),t.firstInit=!0)}),t.socket.on(MessageCodes.SM_RESET,e=>{t.client.handler.reset()}),t.socket.on(MessageCodes.ASIGN_CLIENT_ID,e=>{t.clientId=e.clientId,t.clientObjectFingerprint=e.clientObject}),t.socket.on(MessageCodes.SERVER_LOADING,e=>{console.log(e),t.serverSideLoading=e.loading,t.serverSideLoadingData=e}),t.socket.on(MessageCodes.SM_PACK_UPDATE,e=>{t.handler.update(e),t.camera.update(),t.clientId&&!t.clientObject&&(t.clientObject=t.handler.getObject(t.clientObjectFingerprint.objectType,t.clientObjectFingerprint.id),t.camera.followObject=t.clientObject,t.onClientObjectAssigned&&t.onClientObjectAssigned(t.clientObject))}),t.socket.on(MessageCodes.SM_PACK_REMOVE,e=>{console.log(),t.handler.removeBulk(e)}),t.objectServer.init(t.socket)}),t.emit=((e,o)=>{t.socket.emit(e,o)}),t.startGameLoop=(()=>{t.lastMillisTimer=Date.now(),t.lastMillis=Date.now(),t.lastFrameTime=Date.now(),t.loop()}),t.render=(()=>{try{t.background&&t.background(t.gameArea.ctx,t.camera),t.preHandler&&t.preHandler(t.gameArea.ctx,t.camera),t.handler.render(t.gameArea.ctx,t.camera),t.postHandler&&t.postHandler(t.gameArea.ctx,t.camera),t.uiHandler&&t.uiHandler.render(t.gameArea.ctx),t.postUi&&t.postUi(t.gameArea.ctx,t.camera)}catch(e){console.error(e.stack)}}),t.loop=(()=>{let e=Date.now();e-t.lastFrameTime>=t.frameTime&&(t.lastFrameTime,t.lastFrameTime=e,t.gameArea.clear(),t.loopUpdateCall&&(t.handler.update(),t.camera.update()),t.render(),Date.now()-t.lastMillisTimer>=1e3?(t.frameCounter=0,t.lastMillisTimer=Date.now()):t.frameCounter+=1),setTimeout(t.loop)}),t.initResizeListener=(()=>{window.onresize=(e=>{t.width=window.innerWidth,t.height=window.innerHeight,t.gameArea.resize(t.width,t.height),t.camera.width=t.width,t.camera.height=t.height})}),t},GameArea=(e=500,t=500)=>{var o={};return o.canvas=document.createElement("CANVAS"),o.resize=((e,t)=>{o.width=e,o.height=t,o.canvas.width=e,o.canvas.height=t}),o.resize(e,t),document.body.appendChild(o.canvas),o.canvas.oncontextmenu=function(e){e.preventDefault()},o.ctx=o.canvas.getContext("2d"),SpoolRenderer.ctx=o.ctx,SpoolRenderer.camera=o.camera,o.clear=(()=>{o.ctx.clearRect(0,0,o.canvas.width,o.canvas.height),o.renderBackground()}),o.renderBackground=(()=>{o.ctx.beginPath(),o.ctx.rect(0,0,o.canvas.width,o.canvas.height),o.ctx.fillStyle="white",o.ctx.fill()}),o},TextureManager=(e,t)=>{var o={spriteSheetInitObject:e,objectSheetInitObject:t,spriteSheets:{},objectSheets:{},onLoad:null,loadCounter:0,targetLoad:0,chunkBlankSize:500,chunkBlankImage:null,load:()=>{o.textures={};var e=Object.keys(o.spriteSheetInitObject);o.targetLoad=e.length,e.forEach(e=>{var t=new Image;t.onload=(()=>{var r,n=(r=document.createElement("canvas")).getContext("2d"),a=o.spriteSheetInitObject[e].r?o.spriteSheetInitObject[e].r:1,i=o.spriteSheetInitObject[e].c?o.spriteSheetInitObject[e].c:1,l=t.width/i,s=t.height/a;r.width=l,r.height=s;for(var c=[],h=[],d=0;d<a;d++)for(var u=0;u<i;u++){n.clearRect(0,0,l,s),n.imageSmoothingEnabled=!1,n.drawImage(t,u*l,d*s,l,s,0,0,l,s);var p=new Image;p.src=r.toDataURL("image/png"),c.push(p);for(var g=new Image,y=n.getImageData(0,0,r.width,r.height),m=y.data,v=[],x=r.height-1;x>-1;x--){for(var b=[],f=0;f<r.width;f++)b.push(0,0,0,m[x*r.width*4+4*f+3]/2);v.push(...b)}for(var S=0,M=m.length;S<M;S++)m[S]=v[S];n.putImageData(y,0,0),g.src=r.toDataURL("image/png"),h.push(g)}o.spriteSheets[e]={title:e,textureMap:t,rows:a,columns:i,sprites:c,shadowSprites:h},o.loadCounter+=1,o.loadCounter>=o.targetLoad&&o.onLoad&&o.prepareChunkImage(),n=(r=document.createElement("canvas")).getContext("2d")}),t.src=o.spriteSheetInitObject[e].src})},getSubSpriteSheet:(e,t,r,n,a)=>{var i=n-t+1,l=a-r+1,s=[],c=[],h=o.spriteSheets[e];if(!h)return console.error(`${e} is not in the texture manager`),null;for(var d=r;d<=a;d++)for(var u=t;u<=n;u++){var p=d*h.columns+u;s.push(h.sprites[p]),c.push(h.shadowSprites[p])}return{textureMap:h.textureMap,rows:l,columns:i,sprites:s,shadowSprites:c}},getSprite:(e,t=0,r=0)=>o.spriteSheets[e]?o.spriteSheets[e].sprites[r*o.spriteSheets[e].columns+t]:(console.error(`@TextureManager: ${e} is not in spritesheets`),null),getSprites:e=>o.spriteSheets[e]?o.spriteSheets[e].sprites:(console.error(`@TextureManager: ${e} is not in spritesheets`),null),prepareChunkImage:()=>{var e=document.createElement("canvas");e.getContext("2d"),e.width=o.chunkBlankSize,e.height=o.chunkBlankSize;var t=new Image;t.src=e.toDataURL("image/png"),o.chunkBlankImage=t,o.prepareObjectSheets()},prepareObjectSheets:()=>{o.objectSheetInitObject||console.error("Spool: Invalid objectSheetInitObject");var e=Object.keys(o.objectSheetInitObject);o.targetLoad=e.length,e.forEach(e=>{var r=t[e],n=o.spriteSheets[r.src],a=SpoolMath.numberDefined(r.x)?r.x:0,i=SpoolMath.numberDefined(r.y)?r.y:0,l=SpoolMath.numberDefined(r.xx)?r.xx:n.columns-1,s=SpoolMath.numberDefined(r.yy)?r.yy:n.rows-1,c=l-a+1,h=s-i+1;r.variantBox&&(c=r.variantBox.c,h=r.variantBox.r);for(var d=[],u=i;u<=s;u+=h)for(var p=a;p<=l;p+=c){var g=o.getSubSpriteSheet(r.src,p,u,p+c-1,u+h-1);g.title=e,d.push(g)}o.objectSheets[e]=d}),o.onLoad()},textureObj:e=>{var t=o.objectSheets[e.objectType];if(t){tid=e.textureId?e.textureId:0;var r=t[SpoolMath.randomInt(0,t.length-1)];e.sprite=r.sprites[tid%r.sprites.length],e.shadowSprite=r.shadowSprites[tid%r.sprites.length],e.texture=r}else"SPL_CHUNK"==e.objectType&&(e.sprite=o.chunkBlankImage)},resizeSprite:(e,t,o,r)=>{var n=document.createElement("canvas"),a=n.getContext("2d");n.width=t,n.height=o,a.imageSmoothingEnabled=!1,a.drawImage(e,0,0,t,o);var i=new Image;i.src=n.toDataURL("image/png"),i.onload=(()=>{r(i)})},resizeSprites:(e,t,o,r)=>{t&&o||console.warn("@textureManager resizedSprite: Width and height error");for(var n=0,a=[],i=e.length;i--;)a.push(1);var l=0,s=document.createElement("canvas"),c=s.getContext("2d");s.width=t,s.height=o,e.forEach(i=>{c.clearRect(0,0,t,o),c.imageSmoothingEnabled=!1,c.drawImage(i,0,0,t,o);var h=new Image;h.posInList=n,h.src=s.toDataURL("image/png"),h.onload=(t=>{a[t.target.posInList]=h,(l+=1)==e.length&&r(a)}),n++})},bakeIn:(e,t,o,r,n=null)=>{var a=document.createElement("canvas"),i=a.getContext("2d");a.width=e.width,a.height=e.height,i.imageSmoothingEnabled=!1,i.drawImage(e,0,0),i.drawImage(t,o.x,o.y,o.width,o.height);var l=new Image;l.src=a.toDataURL("image/png"),l.onload=(()=>{r(l,n)})},bakeBatch:(e,t,o,r)=>{var n=document.createElement("canvas"),a=n.getContext("2d");n.width=e.width,n.height=e.height,a.imageSmoothingEnabled=!1,a.drawImage(e,0,0),t.forEach(e=>{a.drawImage(e.bakedTexture,e.dBounds.x,e.dBounds.y,e.dBounds.width,e.dBounds.height)});var i=new Image;i.src=n.toDataURL("image/png"),i.onload=(()=>{o(i,r)})}};return o};cameraContainsEntity=((e,t)=>{let o=({x:x,y:y,width:width,height:height}=e.transformBounds(t.x,t.y,2*t.radius,2*t.radius));return 0<=o.x+o.width/2&&o.x-o.width/2<=e.width*e.scale&&0<=o.y+o.height/2&&o.y-o.height/2<=e.height*e.scale});var Grid=()=>{var e={rowGap:200,columnGap:200,render:(t,o)=>{for(var r=o.x-o.width*CAMERA.scale,n=o.y-o.width*CAMERA.scale;r<(o.x+o.width)/CAMERA.scale;){var a=o.y-o.width,i=o.y+o.width,l=r+-o.x%e.columnGap,s=r+-o.x%e.columnGap;let n=({x:x,y:y}=o.transformPoint(l,a));l=n.x,a=n.y;let c=({x:x,y:y}=o.transformPoint(s,i));s=c.x,i=c.y,t.beginPath(),t.moveTo(l,a),t.strokeStyle="gray",t.lineWidth=1,t.lineTo(s,i),t.stroke(),r+=e.columnGap}for(;n<(o.y+o.width)/CAMERA.scale;){var c=n+-o.y%e.rowGap,h=n+-o.y%e.rowGap,d=o.x-o.width,u=o.x+o.width;let r=({x:x,y:y}=o.transformPoint(d,c));d=r.x,c=r.y;let a=({x:x,y:y}=o.transformPoint(u,h));u=a.x,h=a.y,t.beginPath(),t.moveTo(d,c),t.strokeStyle="gray",t.lineTo(u,h),t.stroke(),n+=e.rowGap}}};return e},ObjectRadar=(e,t,o,r)=>{var n={handler:e,camera:t,objectType:o,radius:r,render:e=>{if(t.followObject&&n.objectType in n.handler.objects){var r=n.handler.objects[o];for(id in r){if(id==t.followObject.id)continue;var a=r[id];if(cameraContainsEntity(t,a))continue;var i=2*Math.PI-SpoolMath.objGlobalAngle(t.followObject,a)+t.rotation;e.fillStyle=a.color;let o=({x:x,y:y}=SpoolMath.polarPoint(t.width/2*t.scale,t.height/2*t.scale,200,i));var l=o.x,s=o.y;let n=({x:x,y:y}=SpoolMath.polarPoint(o.x,o.y,20,i+3*Math.PI/4)),c=({x:x,y:y}=SpoolMath.polarPoint(l,s,20,i+5*Math.PI/4));e.beginPath(),e.moveTo(o.x,o.y),e.lineTo(n.x,n.y),e.lineTo(c.x,c.y),e.closePath(),e.fill()}}}};return n},ClientObjectServer=(e,t=[])=>{var o={client:e,objects:{},init:()=>{o.client.socket.on(MessageCodes.OS_SEND_OBJ,e=>{o.add(e)})},load:e=>{o.client.socket.emit(MessageCodes.OS_GET_OBJ,e)},getObject:e=>{var t=e.objectType,r=e.id,n=o.objects[t];if(n){var a=n[r];if(a)return a}return null},add:e=>{e.objectType in o.objects||(o.objects[e.objectType]={}),o.objects[e.objectType][e.id]?Object.assign(o.objects[e.objectType][e.id],e):o.objects[e.objectType][e.id]=e},remove:(e,t)=>{e in o.objects&&delete o.objects[e][t]}};return o},ClientHandler=(e,t,o=!1)=>{var r=Handler({client:t,chunkSize:e,chunkConstructor:ClientChunk}),n={add:r.add};return o||(r.update=(e=>{for(key in e)if(r.objects[key])for(var t=0;t<e[key].length;t++){var o=e[key][t];if(r.objects[key][o.id]){var n={...o};delete n.id,r.objects[key][o.id].update(n),r.updateObjectsChunk(r.objects[key][o.id])}}})),r.onChunkCreated=(e=>{r.textureManager&&r.textureManager.textureObj(e)}),r.render=((e,t)=>{var o=Math.floor((t.x-t.width/2-100)/r.chunkSize),n=Math.floor((t.y-t.height/2-100)/r.chunkSize),a=Math.floor((t.x+t.width/2+100)/r.chunkSize),i=Math.floor((t.y+t.height/2+100)/r.chunkSize),l=r.getChunks(o,n,a,i),s={},c={};for(chunkKey in l){var h=l[chunkKey],d=h.objects;if(h.sprite){var u=t.transformBounds(h.x*r.chunkSize,(h.y+1)*r.chunkSize,r.chunkSize,r.chunkSize);e.drawImage(h.sprite,u.x,u.y,u.width,u.height)}for(key in d)for(id in d[key]){var p=h.objects[key][id];if(p.bakeIn){if(!p.bakedIn||!p.bakedIn.includes(h.key)){var g=p.getRenderBounds(),y=h.sprite.width/r.chunkSize,m=h.sprite.height/r.chunkSize,v={bakedTexture:p.sprite,dBounds:{x:(g.x-h.x*r.chunkSize)*y,y:(r.chunkSize-(g.y-h.y*r.chunkSize)-g.height)*m,width:g.width*y,height:g.height*m},attributes:{obj:p,chunk:h},callback:(e,t,o)=>{e.attributes.chunk.sprite=t,e.attributes.obj.bakedIn=!0}},x=h.key;x in c||(c[x]={}),p.layer in c[x]||(c[x][p.layer]=[]),c[x][p.layer].push(v)}}else p.layer in s?s[p.layer][id]=p:s[p.layer]={id:p}}}for(key in c)if(key in r.chunks){var b=[],f=[];Object.keys(c[key]).sort((e,t)=>parseInt(e)-parseInt(t)).forEach(e=>{c[key][e].forEach(e=>{b.push({bakedTexture:e.bakedTexture,dBounds:e.dBounds}),f.push(e.attributes.obj)})}),callback=((e,t)=>{r.chunks[t.key].sprite=e,f.forEach(e=>{e.bakedIn?e.bakedIn.push(t.key):e.bakedIn=[t.key]})}),r.textureManager.bakeBatch(r.chunks[key].sprite,b,callback,{key:key})}else console.warn("invalid chunk added to baking:",key);Object.keys(s).sort((e,t)=>parseInt(e)-parseInt(t)).forEach(o=>{Object.keys(s[o]).sort((e,t)=>s[o][t].y-s[o][e].y).forEach(r=>{s[o][r].render(e,t)})})}),r.preBake=(()=>{var e=r.chunks,t={};for(chunkKey in e){var o=e[chunkKey],n=o.objects;for(key in n)for(id in n[key]){var a=o.objects[key][id];if(r.updateObjectsChunk(a),a.bakeIn&&(!a.bakedIn||!a.bakedIn.includes(o.key))){var i=a.getRenderBounds(),l=o.sprite.width/r.chunkSize,s=o.sprite.height/r.chunkSize,c={bakedTexture:a.sprite,dBounds:{x:(i.x-o.x*r.chunkSize)*l,y:(r.chunkSize-(i.y-o.y*r.chunkSize)-i.height)*s,width:i.width*l,height:i.height*s},callback:(e,t)=>{t.chunk.sprite=e,t.obj.bakedIn=!0},attributes:{obj:a,chunk:o}},h=o.key;h in t||(t[h]={}),a.layer in t[h]||(t[h][a.layer]=[]),t[h][a.layer].push(c)}}}for(key in t)if(key in r.chunks){var d=[],u=[];Object.keys(t[key]).sort((e,t)=>parseInt(e)-parseInt(t)).forEach(e=>{t[key][e].forEach(e=>{d.push({bakedTexture:e.bakedTexture,dBounds:e.dBounds}),u.push(e.attributes.obj)})}),callback=((e,t)=>{r.chunks[t.key].sprite=e,t.waitingList.forEach(e=>{e.bakedIn?e.bakedIn.push(t.key):e.bakedIn=[t.key]})}),r.textureManager.bakeBatch(r.chunks[key].sprite,d,callback,{key:key,waitingList:u})}else console.warn("invalid chunk added to baking")}),r.add=(e=>{n.add(e),r.textureManager&&r.textureManager.textureObj(e)}),r.removeBulk=(e=>{for(key in e)if(key in r.objects)for(var t=0;t<e[key].length;t++)e[key][t]in r.objects[key]&&r.remove(r.objects[key][e[key][t]])}),r.reset=(()=>{var o={objects:{},objectsById:{},chunks:{},client:t,chunkSize:e};Object.keys(o).forEach(e=>{delete r.key}),Object.assign(r,o)}),r},ClientChunk=(e,t)=>Chunk({objectType:"SPL_CHUNK",...e},t),Camera=(e={})=>{var t={x:0,y:0,rotation:0,width:0,height:0,canvasWidth:0,canvasHeight:0,scaleX:1,scaleY:1,followSpeed:.4,rotationSpeed:.05,followObject:null,offsetX:0,offsetY:0,...e,update:()=>{t.followObject?(t.lerpRotation&&(t.rotation=SpoolMath.lerpRotation(t.rotation,t.followObject.rotation-Math.PI/2,t.rotationSpeed)),t.lerpSpeedToScale&&t.followObject.velocity&&t.followObject.velocity,t.width=t.canvasWidth/t.scaleX,t.height=t.canvasHeight/t.scaleY,t.lerp&&(t.x=SpoolMath.lerp(t.x,t.followObject.x+t.offsetX,t.followSpeed),t.y=SpoolMath.lerp(t.y,t.followObject.y+t.offsetY,t.followSpeed))):t.followObject&&(t.x=t.followObject.x+t.offsetX,t.y=t.followObject.y+t.offsetY),t.onUpdate&&t.onUpdate(t)},transformBounds:(e,o,r,n)=>{let a=({x:e,y:o}=t.transformPoint(e,o));return{x:a.x,y:a.y,width:r*t.scaleX,height:n*t.scaleY}},transformPoint:(e,o)=>{var r=Math.sin(t.rotation),n=Math.cos(t.rotation);return{x:t.scaleX*((e-t.x)*n-(-o+t.y)*r+t.width/2),y:t.scaleY*((e-t.x)*r+(-o+t.y)*n+t.height/2)}},transformDimension:e=>t.scaleX*e,clickTransfer:(e,o)=>{var r=SpoolMath.distance(e,o,t.width/2,t.height/2),n=t.rotation+Math.atan2(o-t.height/2,e-t.width/2);return{x:t.x+Math.cos(n)*r,y:t.y+Math.sin(n)*r}},inverseTransformPoint:(e,o)=>{var r=Math.sin(t.rotation),n=Math.cos(t.rotation),a=t.y-(-r*(e/t.scaleX-t.width/2)+n*(o/t.scaleY-t.height/2));return{x:n*(e/t.scaleX-t.width/2)+r*(o/t.scaleY-t.height/2)+t.x,y:a}},setFollowObject:e=>{e&&(t.followObject=e,t.angle=e.angle)}};return t},ClientEntity=(e,t=null)=>{var o={x:0,y:0,rotation:0,radius:10,color:"red",layer:10,animationCounter:0,animationTime:0,animationFrame:0,animationSize:0,...e};if(t)var r=t(o);else r=o;return r.update=(e=>{Object.assign(r,e)}),r.render=((e,t)=>{r.renderOval(e,t)}),r.renderOval=((e,t,o=r.color)=>{e.fillStyle=o;var n=t.transformBounds(r.x,r.y,r.width,r.height);SpoolRenderer.fillInscribedOval(SpoolRect(n.x-n.width/2,n.y-n.height/2,n.width,n.height))}),r.renderNtagon=((e,t,o,n,a=0,i=r.color)=>{e.fillStyle=i,e.beginPath();var l=t.transformBounds(r.x,r.y,n,n),s=l.width;e.moveTo(l.x-s*Math.cos(a),l.y-s*Math.sin(a));for(var c=1;c<o;c++)angle=a+2*Math.PI/o*c,e.lineTo(l.x-s*Math.cos(angle),l.y-s*Math.sin(angle));e.closePath(),e.fill()}),r.renderRectangle=((e,t,o=r.color)=>{var n=t.transformBounds(r.x,r.y,r.width,r.height);e.beginPath(),e.lineWidth="1",e.rect(Math.floor(n.x-n.width/2),Math.floor(n.y-n.height/2),n.width,n.height),e.fillStyle=o,e.fill()}),r.renderSprite=((e,t,o=r.sprite,n=null)=>{if(o){var a;if(n)a=n;else{var i=r.width,l=r.height,s=r.x,c=r.y;r.clientWidth&&(i=r.clientWidth),r.clientHeight&&(l=r.clientHeight);var h=t.transformBounds(s,c,i,l),d=r.width/2,u=r.height/2;r.clientOffsetX&&(d=r.clientOffsetX),r.clientOffsetY&&(u=r.clientOffsetY);var p=t.transformBounds(s,c,d,u);e.imageSmoothingEnabled=!1,a={x:h.x-p.width,y:h.y-p.height,width:h.width,height:h.height}}return e.drawImage(o,a.x,a.y,a.width,a.height),r.showBounds&&r.renderRectangle(e,t,r.color),a}return r.renderRectangle(e,t,"violet"),null}),r.renderRotatedSprite=((e,t,o,r,n,a,i)=>{e.save();var l=t.transformPoint(o,r);e.translate(l.x,l.y),e.rotate(n),e.drawImage(a,i.x,i.y,i.width,i.height),e.restore()}),r.getMovementAnimationSpriteIndex=((e=r.moving,t=r.movementAngle)=>{var o=r.texture.rows-1;if(e){var n=t;n<0&&(n+=2*Math.PI),(n=n/Math.PI/2+1/o/2)<0&&(n+=1),n%=1;var a=Math.floor(n*o)%o+1}else a=0;return a*r.texture.columns+r.animationFrame}),r.renderMovementAnimation=((e,t,o=null)=>{if(o)var n=o;else n=r.getMovementAnimationSpriteIndex();return r.animationCounter==r.animationTime?(r.texture&&(r.animationFrame+=1,r.animationFrame==r.texture.columns&&(r.animationFrame=0)),r.animationCounter=0):r.animationCounter+=1,[r.renderSprite(e,t,r.texture.sprites[n]),n]}),r.getRenderBounds=((e=null)=>{if(e){s=r.width,c=r.height;var t=r.x,o=r.y;r.clientWidth&&(s=r.clientWidth),r.clientHeight&&(c=r.clientHeight),l=e.transformBounds(t,o,s,c),a=r.width/2,i=r.height/2,r.clientOffsetX&&(a=r.clientOffsetX),r.clientOffsetY&&(i=r.clientOffsetY);var n=e.transformBounds(t,o,a,i);return ctx.imageSmoothingEnabled=!1,finalBounds={x:l.x-n.width,y:l.y-n.height,width:l.width,height:l.height},finalBounds}var a=r.width/2,i=r.height/2;r.clientOffsetX&&(a=r.clientOffsetX),r.clientOffsetY&&(i=r.clientOffsetY);var l,s=r.width,c=r.height;return r.clientWidth&&(s=r.clientWidth),r.clientHeight&&(c=r.clientHeight),{x:r.x-a,y:r.y-i,width:s,height:c}}),r},RectangleEntity=e=>{var t=ClientEntity(e);return t.render=((e,o)=>{t.renderRectangle(e,o)}),t},SpriteEntity=e=>{var t=ClientEntity(e);return t.render=((e,o)=>{t.renderSprite(e,o)}),t},MovementAnimationEntity=e=>{var t=ClientEntity({...e,animationTime:5});return t.render=((e,o)=>{t.renderMovementAnimation(e,o)}),t},Point=e=>{var t={x:0,y:0,xx:0,yy:0,color:"green",...e,update:e=>{Object.assign(t,e)},render:(e,o)=>{e.fillStyle=t.color,e.beginPath();let{x:r,y:n,width:a}=o.transformBounds(t.x,t.y,3,3);e.arc(r,n,a,0,360),e.stroke()}};return t},Line=e=>{var t=Entity({x:0,y:0,xx:0,yy:0,color:"green",...e});return t.render=((e,o)=>{let r=o.transformPoint(t.x,t.y);var n=o.transformPoint(t.xx,t.yy);e.strokeStyle=t.color,e.beginPath(),e.moveTo(r.x,r.y),e.lineTo(n.x,n.y),e.stroke()}),t},Rectangle=e=>{var t={x:0,y:0,xx:0,yy:0,color:"green",...e,update:e=>{Object.assign(t,e)},render:(e,o)=>{let r=o.transformPoint(t.x,t.y);var n=o.transformPoint(t.xx,t.yy);e.beginPath(),e.lineWidth="1",e.rect(r.x,r.y,n.x-r.x,n.y-r.y),t.fill?(e.fillStyle=t.color,e.fill()):(e.strokeStyle=t.color,e.stroke())}};return t},KeyboardListener=(e,t)=>{var o={client:e,keyListeners:{65:{inputMessage:MessageCodes.KI_MOV_LEFT,parameter:"pressedLeft"},87:{inputMessage:MessageCodes.KI_MOV_UP,parameter:"pressedUp"},68:{inputMessage:MessageCodes.KI_MOV_RIGHT,parameter:"pressedRight"},83:{inputMessage:MessageCodes.KI_MOV_DOWN,parameter:"pressedDown"}},additionalKeyListeners:{},activeTypes:["keydown","keyup"],...t};return o.handleKeyDown=o.activeTypes.includes("keydown"),o.handleKeyUp=o.activeTypes.includes("keyup"),Object.assign(o.keyListeners,o.additionalKeyListeners),o.onEvent=((e,t)=>{e.keyCode in o.keyListeners&&(listener=o.keyListeners[e.keyCode],o.client.pureLocalClient?o.client.clientObject&&(o.client.clientObject[listener.parameter]=t):o.client.socket.emit(MessageCodes.SM_KEY_PRESS,{inputId:listener.inputMessage,value:t}))}),o.initListener=(()=>{document.onkeydown=(e=>{o.handleKeyDown&&o.onEvent(e,!0),o.onKeyDown&&o.onKeyDown(e)}),document.onkeyup=(e=>{o.handleKeyUp&&o.onEvent(e,!1),o.onKeyUp&&o.onKeyUp(e)})}),o},MouseListener=(e,t)=>{var o={client:e,mouseCoordTransformation:null,activeButtons:[0,2],activeTypes:["mousedown","mouseup"],...t,onMouseButtonEvent:(t,r,n)=>{o.client.uiHandler.mouseEvent(t)||(o.gamePlaneMouseButtonEvent(t,r,n),o.client.onMouseEvent(t,e))},gamePlaneMouseButtonEvent:(t,r,n)=>{if(o.activeButtons.includes(t.button)&&o.activeTypes.includes(t.type)){var a="mousedown"==t.type||"mouseup"!=t.type&&null;if(null===a)return void console.error("@MouseListener, event value is null");o.client.pureLocalClient?e.clientObject.mouseEventInWorld&&e.clientObject.mouseEventInWorld(r,n,a):o.client.socket.emit(MessageCodes.SM_MOUSE_INPUT,{x:r,y:n,value:a,type:t.type})}},initListener:()=>{document.onmousedown=(e=>{var t=e.clientX,r=e.clientY;if(o.mouseCoordTransformation){var n=o.mouseCoordTransformation(t,r);t=n.x,r=n.y}o.onMouseDown&&o.onMouseDown(e,t,r),o.onMouseButtonEvent(e,t,r)}),document.onmouseup=(e=>{var t=e.clientX,r=e.clientY;if(o.mouseCoordTransformation){var n=o.mouseCoordTransformation(t,r);t=n.x,r=n.y}o.onMouseUp&&o.onMouseUp(e,t,r),o.onMouseButtonEvent(e,t,r)}),document.onmousemove=(e=>{o.client.onMouseMove&&o.client.onMouseMove(e),o.client.uiHandler.mouseMove(e)})}};return o};const FileReader={readImage:(e,t,o=4)=>{var r=new Image;r.onload=(()=>{var e=document.createElement("canvas");e.width=r.width,e.height=r.height;var n=e.getContext("2d");n.drawImage(r,0,0,r.width,r.height);var a=n.getImageData(0,0,r.width,r.height);t({data:a.data,width:a.width,height:a.height,pixelSize:o})}),r.src=e}};if(void 0===SpoolMath){try{SpoolMath=require("./spoolmath.js").SpoolMath}catch(e){console.warn("SpoolMath require importing failed, require is most likely not present, make sure you are importing SpoolMath in another way")}SpoolMath||console.error("SpoolMath library not present, make sure it is included")}if(void 0===SpoolUtils){try{SpoolUtils=require("./spoolutils.js").SpoolUtils}catch(e){console.warn("SpoolUtils require importing failed, require is most likely not present, make sure you are importing SpoolMath in another way")}SpoolUtils||console.error("SpoolUtils library not present, make sure it is included")}if(void 0===FileReader){try{FileReader=require("../spoolfilereader.js").FileReader}catch(e){console.warn("FileReader require importing failed, require is most likely not present, make sure you are importing SpoolMath in another way")}FileReader||console.error("FileReader library not present, make sure it is included")}try{var Perlin=require("perlin-noise")}catch(e){console.warn("Perlin noise is not available without require (server side)")}var Chunk=(e,t)=>{var o={x:0,y:0,width:0,height:0,handler:t,objects:{},...e,add:e=>{e.objectType in o.objects||(o.objects[e.objectType]={}),o.objects[e.objectType][e.id]=e},removeSignature:(e,t)=>{e in o.objects&&delete o.objects[e][t]},remove:e=>{o.removeSignature(e.objectType,e.id)},getClosestObject:(e,t,r)=>{var n=null;for(key in o.objects)if(!r||!r.whitelist||r.whitelist.includes(key))for(id in o.objects[key]){var a=o.objects[key][id],i=SpoolMath.distance(e,t,a.x,a.y);(!n||i<n.distance)&&(n={object:a,distance:i})}return n}};return o},Handler=(e={})=>{var t={objectsById:{},objects:{},chunks:{},staticKeys:[],preManagers:[],managers:[],chunkSize:300,chunkConstructor:Chunk,...e,resetObjects:()=>{Object.assign(t,{objectsById:{},objects:{},chunks:{}})},updateObjectsChunk:e=>{var o=!1,r=Math.floor((e.x-e.width/2)/t.chunkSize),n=Math.floor((e.y-e.height/2)/t.chunkSize),a=Math.floor((e.x+e.width/2)/t.chunkSize),i=Math.floor((e.y+e.height/2)/t.chunkSize);if(e.chunks)if(0==e.chunks.length)o=!0;else{if(r==e.chunksX&&n==e.chunksY&&a==e.chunksXX&&i==e.chunksYY)return;o=!0,e.chunks.forEach(t=>{t.remove(e)})}else o=!0;if(o&&(e.chunksX=r,e.chunksY=n,e.chunksXX=a,e.chunksYY=i,e.chunks=[],o))for(var l=r;l<a+1;l++)for(var s=n;s<i+1;s++){var c=`[${l};${s}]`,h=void 0;c in t.chunks?h=t.chunks[c]:(h=t.chunkConstructor({x:l,y:s,width:t.chunkSize,height:t.chunkSize,key:c,color:SpoolMath.randomHsvColor(.5,.8)},t),t.chunks[c]=h,t.onChunkCreated&&t.onChunkCreated(h)),h.add(e),e.chunks.push(h),e.chunkColor=h.color}},update:()=>{for(key in t.objects)if(!t.staticKeys.includes(key)){var e=t.objects[key];for(objKey in e){var o=e[objKey];if(!o.static){for(var r=0;r<t.preManagers.length;r++)t.preManagers[r].update(o);for(o.update(),t.updateObjectsChunk(o),r=0;r<t.managers.length;r++)t.managers[r].update(o)}}}for(r=0;r<t.managers.length;r++)t.managers[r].handlerUpdate&&t.managers[r].handlerUpdate()},add:e=>{e.objectType in t.objects||(t.objects[e.objectType]={}),t.objects[e.objectType][e.id]=e,t.objectsById[e.id]=e,t.updateObjectsChunk(e)},removeSignature:(e,o)=>{e in t.objects&&(t.objects[e][o]&&t.objects[e][o].chunks&&t.objects[e][o].chunks.forEach(r=>{r.remove(t.objects[e][o])}),delete t.objects[e][o]),delete t.objectsById[o]},remove:e=>{t.removeSignature(e.objectType,e.id)},emptyObjectType:e=>{if(e in t.objects){var o=t.objects[e];Object.keys(o).forEach(o=>{t.remove(e,o)})}},getObject:(e,o)=>t.objects[e]&&t.objects[e][o]?t.objects[e][o]:null,getClosestObject:(e,o,r)=>{var n=Math.floor(e/t.chunkSize),a=Math.floor(o/t.chunkSize),i=null;if(t.getChunks(n,a,n,a).forEach(t=>{var n=t.getClosestObject(e,o,r);n&&(!i||n.distance<i.distance)&&(i=n)}),!i)for(key in t.chunks){var l=t.chunks[key].getClosestObject(e,o,r);l&&(!i||l.distance<i.distance)&&(i=l)}return i},addManager:e=>{t.managers.push(e)},addPreManager:e=>{t.preManagers.push(e)},getChunks:(e,o,r,n)=>{result=[];for(var a=e;a<=r;a++)for(var i=o;i<=n;i++){var l=`[${a};${i}]`;l in t.chunks&&result.push(t.chunks[l])}return result}};return t},CollisionManager=(e,t)=>{var o={handler:t,...e};return o.colPairs.forEach(e=>{e.a.forEach(t=>{e.b.forEach(r=>{o.colPairs.push({a:t,b:r,func:e.func,exception:e.exception,solid:void 0===e.solid||e.solid,solidException:e.solidException})})})}),o.getNeededChunks=(e=>{if(e.x>e.px)var t=e.px-e.width/2,r=e.x+e.width/2;else t=e.x-e.width/2,r=e.px+e.width/2;if(e.y>e.py)var n=e.py-e.height/2,a=e.y+e.height/2;else n=e.y-e.height/2,a=e.py+e.height/2;return o.handler.getChunks(Math.floor(t/o.handler.chunkSize),Math.floor(n/o.handler.chunkSize),Math.floor(r/o.handler.chunkSize),Math.floor(a/o.handler.chunkSize))}),o.update=(e=>{var r=e.objectType;if(r in t.objects)for(var n=0;n<o.colPairs.length;n++){var a=o.colPairs[n].a,i=o.colPairs[n].harsh;if(r==a)for(var l=o.colPairs[n].b,s=o.getNeededChunks(e),c=0;c<s.length;c++){var h=s[c];if(l in h.objects)for(bKey in h.objects[l]){var d=e,u=h.objects[l][bKey];if(!(d.objectType==u.objectType&&d.id==u.id||o.colPairs[n].exception&&o.colPairs[n].exception(d,u))){if("oval"==d.bodyType&&"oval"==u.bodyType)var p=o.objectOvalCollision;else p=o.objectRectCollision;var g=p(d,u,i);g&&g.result&&(o.colPairs[n].solid&&g.point&&(o.colPairs[n].solidException&&o.colPairs[n].solidException(d,u)||(d.x=Math.round(g.point.x),d.y=Math.round(g.point.y))),o.colPairs[n].func&&o.colPairs[n].func(d,u,g))}}}}}),o.objectOvalCollision=((e,t)=>{if(aradius=Math.max(e.width,e.height)/2,bradius=Math.max(t.width,t.height)/2,SpoolMath.distance(e.x,e.y,t.x,t.y)<aradius+bradius){var o,r=parseInt(e.px),n=parseInt(e.py),a=parseInt(e.x),i=parseInt(e.y),l=bradius+aradius,s=parseInt(t.x),c=parseInt(t.y),h=0;if(r!=a){var d=(i-n)/(a-r),u=n-r*d,p=u-c,g=d*d+1,y=p*p+s*s-l*l,m=(-(f=2*d*p-2*s)+(S=Math.sqrt(Math.pow(f,2)-4*g*y)))/(2*g),v=(-f-S)/(2*g),x=d*m+u,b=d*v+u;SpoolMath.distance(m,x,r,n)<SpoolMath.distance(v,b,r,n)?(o=m,h=x):(o=v,h=b)}else{var f,S,M=r;g=1,y=c*c+s*s-l*l+M*M-2*s*M,x=(-(f=-2*c)+(S=Math.sqrt(f*f-4*g*y)))/(2*g),b=(-f-S)/(2*g),SpoolMath.distance(M,x,r,n)<SpoolMath.distance(M,b,r,n)?(o=M,h=x):(o=M,h=b)}return{result:!0,x:o,y:h}}return null}),o.objMovementLine=(e=>({x:e.px,y:e.py,xx:e.x,yy:e.y})),o.objectRectCollision=((e,t,r=!1)=>{var n=parseInt(t.x-t.width/2-e.width/2),a=parseInt(t.y-t.height/2-e.height/2),i=parseInt(t.x+t.width/2+e.width/2),l=parseInt(t.y+t.height/2+e.height/2),s=o.objMovementLine(e),c={result:n<e.x&&e.x<i&&a<e.y&&e.y<l};if(Math.abs(e.x-t.x)>=Math.abs(e.px-t.x)&&Math.abs(e.y-t.y)>=Math.abs(e.py-t.y))return c;var h=[],d=[{x:n,y:a,xx:n,yy:l},{x:i,y:a,xx:i,yy:l},{x:n,y:l,xx:i,yy:l},{x:n,y:a,xx:i,yy:a}],u=["right","left","bottom","top"],p=[t.leftColIgnore,t.rightColIgnore,t.topColIgnore,t.bottomColIgnore],g=0;d.forEach(e=>{if(p[g])h.push(null);else{var t=o.lineIntersection(e,s);t&&(t.direction=u[g]),h.push(t)}g++});var y=null,m=null,v=null;return g=0,h.forEach(t=>{if(t){var o=SpoolMath.distance(e.px,e.py,t.x,t.y);(!m||o<m)&&(v=g,m=o,y=t)}g++}),y?(v<=1?y.y=e.y:y.x=e.x,c.point={x:y.x,y:y.y},c.direction=y.direction,c):(r&&(c.point={x:e.px,y:e.py}),c)}),o.lineIntersection=((e,t)=>{var o=e.x,r=e.xx,n=e.y,a=e.yy,i=t.x,l=t.xx,s=t.y,c=t.yy,h=(o-r)*(s-c)-(n-a)*(i-l);if(0==h)return null;var d=((o*a-n*r)*(i-l)-(o-r)*(i*c-s*l))/h,u=((o*a-n*r)*(s-c)-(n-a)*(i*c-s*l))/h;return SpoolMath.inInterval(d,o,r,2)&&SpoolMath.inInterval(d,i,l,2)&&SpoolMath.inInterval(u,n,a,2)&&SpoolMath.inInterval(u,s,c,2)?{x:d,y:u}:null}),o},OuterWorldManager=(e,t)=>{var o={handler:e,validObjects:t,update:e=>{if(o.validObjects.includes(e.objectType)&&e.objectType in o.handler.objects){var t=SpoolMath.distance(e.x,e.y,0,0);t>OUTER_EDGE?e.setAcc("outer-world",t/500,SpoolMath.globalAngle(e.x,e.y,0,0)):e.setAcc("outer-world",0,0)}}};return o},GravityManager=(e,t)=>{var o={handler:t,gravityType:"homogenous",G:2,colPairs:[],...e,update:e=>{"homogenous"==o.gravityType?o.homGravity(e):o.vecGravity(e)},vecGravity:e=>{var r=e.objectType,n=e.accelerations.gravity?e.accelerations.gravity.angle:0;if(e.setAcc("gravity",0,n),!e.ground&&!e.gravityLock&&r in t.objects)for(var a=0;a<o.colPairs.length;a++)if(r==o.colPairs[a].a){var i=o.colPairs[a].b;if(i in t.objects)for(bKey in t.objects[i]){var l=e,s=t.objects[i][bKey];SpoolMath.objDistance(l,s)<bradius*GRAVITY_RADIUS_COEF&&l.addToAcc("gravity",o.objectGravity(l,s),SpoolMath.objGlobalAngle(l,s))}}e.rotation=e.accelerations.gravity.angle+Math.PI},objectGravity:(e,t)=>{var r=o.G*e.mass*t.mass/Math.pow(SpoolMath.objDistance(e,t),GRAVITY_RADIUS_POW);return gravity=r/e.mass},homGravity:e=>{e.gravityIgnore||e.setAcc("gravity",o.G,Math.PI/2*3)}};return o},SpoolTimer=(e,t,o=null)=>{var r={startTime:Date.now(),duration:e,event:t,object:o,active:!0,timeLeft:0,update:()=>{r.timeLeft=r.startTime+r.duration-Date.now(),r.timeLeft<0&&r.active&&(r.event(o),r.active=!1)},stop:()=>{r.active=!1}};return r},ObjectSpawner=(e,t,o={})=>{var r={keyToConstAndDefs:t,handler:e,...o,zones:{},zoneCounters:{},currentZoneMap:null,gx:10,gy:10,mapPxWidth:0,mapPxHeight:0,colTexturingMap:[[!0,!0,!0,!0],[!0,!1,!0,!1],[!1,!0,!1,!0],[!1,!0,!0,!0],[!0,!0,!1,!1],[!1,!0,!1,!1],[!1,!0,!0,!1],[!0,!1,!0,!0],[!0,!1,!1,!1],[!1,!1,!1,!1],[!1,!1,!0,!1],[!0,!0,!1,!0],[!0,!1,!1,!0],[!1,!1,!1,!0],[!1,!1,!0,!0],[!0,!0,!0,!1]],reset:()=>{Object.assign(r,{zones:{},zoneCounters:{}})},spawn:(e,o,n)=>{if(e in r.keyToConstAndDefs){var a=t[e],i=a.const({...a.defs,x:o,y:n});return r.handler.add(i),i}},spawnInRadius:(e,o,n,a=0,i=0)=>{if(e in r.keyToConstAndDefs)for(var l=t[e],s=0;s<o;s++){var c=Math.random()*Math.PI*2,h=Math.random()*n,d=a+h*Math.cos(c),u=i+h*Math.sin(c),p=l.const({...l.defs,x:d,y:u});r.handler.add(p)}},spawnInRectangle:(e,o,n,a,i,l)=>{if(e in r.keyToConstAndDefs)for(var s=t[e],c=0;c<o;c++){var h=n+i*Math.random(),d=a+l*Math.random(),u=s.const({...s.defs,x:h,y:d});r.handler.add(u)}},zoneStep:(e,t,o,n)=>{if(r.currentZoneMap[t][e]){var a=r.currentZoneMap[t][e];a.key==o.key&&a.color==o.color&&(r.zoneMap[t][e][o.key]=n,r.zones[o.key]||(r.zones[o.key]={}),r.zones[o.key][n]||(r.zones[o.key][n]=[]),r.zones[o.key][n].push([e,t]),r.currentZoneMap[t][e]=null,r.zoneStep(e-1,t,o,n),r.zoneStep(e+1,t,o,n),r.zoneStep(e,t-1,o,n),r.zoneStep(e,t+1,o,n))}},addZonesFromImageArray:(e,t,o)=>{r.addZones(e[0],t,()=>{var n=e.slice(1);0==n.length?o():r.addZonesArray(n,t,o)})},addZonesFromImage:(e,t,o)=>{FileReader.readImage(e,e=>{var n=[],a=e.data;if(!r.zoneMap){for(var i=[],l=0;l<e.height;l++){for(var s=[],c=0;c<e.width;c++)s.push({});i.push(s)}r.zoneMap=i}for(l=0;l<e.height;l++){var h=[];for(c=0;c<e.width;c++){var d=(l*e.width+c)*e.pixelSize,u=a[d],p=a[d+1],g=a[d+2],y=t[SpoolMath.rgbToHex(u,p,g)];y?h.push({key:y,color:SpoolMath.rgbToHex(u,p,g)}):h.push(null)}n.push(h)}r.mapPxWidth=e.width,r.mapPxHeight=e.height;var m=r.zoneCounters;for(r.currentZoneMap=n,l=0;l<r.currentZoneMap.length;l++)for(c=0;c<r.currentZoneMap[l].length;c++){var v=r.currentZoneMap[l][c];v&&(v.key in m||(m[v.key]=0),r.zoneStep(c,l,v,m[v.key]),m[v.key]+=1)}r.zoneCounters=m,o&&o()})},spawnFromKeyArray:(e,o=r.gx,n=r.gy,a=null)=>{for(var i=0;i<e.length;i++)for(var l=0;l<e[i].length;l++)if(e[i][l]){var s=t[e[i][l]];if(s){var c={};s.dependantConst&&(c=s.dependantConst(r,a?a[i][l]:null));var h=s.const({...s.defs,x:parseInt((l-e[i].length/2)*o),y:parseInt((-i+e.length/2)*n),gridX:l,gridY:i,...c}),d=[e[i][l]];if(s.gridColRemovalSiblings&&(d=[e[i][l],...s.gridColRemovalSiblings]),h.gridColRemoval){l>0&&d.includes(e[i][l-1])&&(h.leftColIgnore=!0),l<e[i].length-1&&d.includes(e[i][l+1])&&(h.rightColIgnore=!0),i>0&&d.includes(e[i-1][l])&&(h.topColIgnore=!0),i<e.length-1&&d.includes(e[i+1][l])&&(h.bottomColIgnore=!0);var u=r.getColTextureId([!h.leftColIgnore,!h.topColIgnore,!h.rightColIgnore,!h.bottomColIgnore]);h.textureId=u,h.onGridColRemoval&&h.onGridColRemoval()}r.zoneMap&&Object.keys(r.zoneMap[i][l]).forEach(e=>{h.zones[e]=r.zoneMap[i][l][e]}),r.handler.add(h)}}},getColTextureId:e=>{for(var t=0;t<r.colTexturingMap.length;t++){for(var o=r.colTexturingMap[t],n=!1,a=0;a<e.length;a++)if(o[a]!==e[a]){n=!0;break}if(!n)return t}return 0},spawnFromIndexMap:(e,t=r.gx,o,n=" ",a="\r\n")=>{FileReader.readFile(e,e=>{var i=[],l=Object.keys(r.keyToConstAndDefs);e.split(a).forEach(e=>{var t=e.split(n);xPointer=0;var o=[];t.forEach(e=>{r.keyToConstAndDefs[l[parseInt(e)-1]]?o.push(l[parseInt(e)-1]):o.push(null)}),i.push(o)}),r.spawnFromKeyArray(i,t,o)})},spawnFromImageMap:(e,t,o,n=r.gx,a=r.gy)=>{FileReader.readImage(e,e=>{for(var i=[],l=(Object.keys(r.keyToConstAndDefs),e.data),s=t["non-black"],c=[],h=0;h<e.height;h++){for(var d=[],u=[],p=0;p<e.width;p++){var g=(h*e.width+p)*e.pixelSize,y=l[g],m=l[g+1],v=l[g+2],x=SpoolMath.rgbToHex(y,m,v),b=t[x];!s||b||0==y&&0==m&&0==v||(b=s),b?d.push(b):d.push(null),u.push([y,m,v,x])}i.push(d),c.push(u)}r.spawnFromKeyArray(i,n,a,c),o&&o()})},spawnRPGWorld:(e,t,o=r.gx,n=r.gy)=>{r.spawnFromImageMap(e.ground,t,o,n),r.spawnFromImageMap(e.objects,t,o,n)},spawnInZone:(e,o,n,a=null)=>{if(e in r.keyToConstAndDefs){var i=t[e];if(r.zones[n])for(var l=0;l<o;l++){var s=a;if(void 0==s||null==s){var c=Object.keys(r.zones[n]);s=c[Math.round(Math.random()*(c.length-1))]}var h=r.zones[n][s];if(h){var d=h[Math.round(Math.random()*(h.length-1))],u=(d[0]-r.mapPxWidth/2)*r.gx+Math.round(Math.random()*r.gx),p=(-d[1]+r.mapPxWidth/2)*r.gy+Math.round(Math.random()*r.gy),g=i.const({...i.defs,x:u,y:p});r.handler.add(g)}}}else console.log("@ObjectSpawner: Object key is not in known by object spawner: "+e)},getRandomPositionInZone:(e,t=null)=>{var o=t;if(!o){var n=Object.keys(r.zones[e]);o=n[Math.round(Math.random()*(n.length-1))]}var a=r.zones[e][o];if(a){var i=a[Math.round(Math.random()*(a.length-1))];return{x:(i[0]-r.mapPxWidth/2)*r.gx+Math.round(Math.random()*r.gx),y:(-i[1]+r.mapPxHeight/2)*r.gy+Math.round(Math.random()*r.gy)}}return null}};return r},Entity=(e={},t=null)=>{var o={asyncUpdatePackage:{},asyncUpdateNeeded:!1,x:0,y:0,velX:0,velY:0,calculatedVelX:0,calculatedVelY:0,movementAngle:0,rotation:0,accelerations:{},velocities:{},chunks:[],chunksX:0,chunksY:0,chunksXX:0,chunksYY:0,color:"red",zones:{},...GravityParameters,...CollisionParameters,...OvalBodyParameters,id:Math.random(),objectType:"BLANK_ENTITY",...e};if(t)var r=t(o);else r=o;return r.getEntityId=(()=>objectType+":"+id),r.update=(()=>{var e=!1;return r.updateVel(),(e|=r.updatePos())?r.updatePack():null}),r.initPack=(()=>{var e={};return void 0!==r.textureId&&(e.textureId=r.textureId),{...r.updatePack(),objectType:r.objectType,width:r.width,height:r.height,bodyType:r.bodyType,color:r.color,...e}}),r.updatePack=(()=>({x:r.x,y:r.y,color:r.color,rotation:r.rotation,id:r.id,movementAngle:r.movementAngle,moving:r.moving,...r.asyncUpdatePackage})),r.authorizedUpdatePack=(()=>null),r.setAsyncUpdateValue=((e,t)=>{r.asyncUpdatePackage[e]=t,r.asyncUpdateNeeded=!0}),r.addAsyncUpdatePackage=(e=>{Object.assign(r.asyncUpdatePackage,e),r.asyncUpdateNeeded=!0}),r.updatePos=(()=>{for(velKey in r.px=r.x,r.py=r.y,r.x+=r.velX,r.y+=r.velY,r.calculatedVelX=0,r.calculatedVelY=0,r.velocities){var e=r.velocities[velKey],t=SpoolMath.coordVelsFromVel(e.vel,e.angle);r.x+=t.x,r.y+=t.y,r.calculatedVelX+=t.x,r.calculatedVelY+=t.y}return r.px!=r.x||r.py!=r.y?(r.movementAngle=SpoolMath.globalAngle(r.px,r.py,r.x,r.y),r.moving=!0,!0):(r.moving=!1,!0)}),r.impulse=((e,t)=>{var o=SpoolMath.coordVelsFromVel(e,t);r.velX+=o.x,r.velY+=o.y}),r.vectorImpulse=((e,t)=>{r.velX+=e,r.velY+=t}),r.updateVel=(()=>{for(acckey in r.accelerations){var e=r.accelerations[acckey],t=SpoolMath.coordVelsFromVel(e.acc,e.angle);r.velX+=t.x,r.velY+=t.y}}),r.setAcc=((e,t,o)=>{r.accelerations[e]={acc:t,angle:o}}),r.addToAcc=((e,t,o)=>{var n={...r.accelerations[e]},a=n.acc*Math.cos(n.angle)+t*Math.cos(o),i=n.acc*Math.sin(n.angle)+t*Math.sin(o);newAcc=Math.sqrt(a*a+i*i),newAngle=Math.atan2(i,a),r.setAcc(e,newAcc,newAngle)}),r.removeAcc=(e=>{delete r.accelerations[e]}),r.setVel=((e,t,o)=>{r.velocities[e]={vel:t,angle:o}}),r.setVelVector=((e,t)=>{r.velocities[e]={vel:SpoolMath.distance(0,0,t[0],t[1]),angle:SpoolMath.globalAngle(0,0,t[0],t[1])}}),r.removeVel=(e=>{delete r.velocities[e]}),r.addToHandler=(e=>{e.add(r)}),r.vectorFromVel=(()=>({angle:Math.atan2(r.velY,r.velX),value:SpoolMath.distance(r.velX,r.velY,0,0)})),r.vectorFromVels=((e,t)=>({angle:Math.atan2(t,e),value:SpoolMath.distance(e,t,0,0)})),r},InputManager=()=>{},KeyInputParameters={pressedLeft:!1,pressedUp:!1,pressedRight:!1,pressedDown:!1},GravityParameters={mass:1,gravityLock:!1},CollisionParameters={px:0,py:0},OvalBodyParameters={bodyType:"oval",width:10,height:10},RectangleBodyParameters={bodyType:"rect",width:10,height:10};try{module.exports={Handler:Handler,Chunk:Chunk,CollisionManager:CollisionManager,GravityManager:GravityManager,OuterWorldManager:OuterWorldManager,InputManager:InputManager,ObjectSpawner:ObjectSpawner,Entity:Entity,KeyInputParameters:KeyInputParameters,GravityParameters:GravityParameters,CollisionParameters:CollisionParameters,OvalBodyParameters:OvalBodyParameters,RectangleBodyParameters:RectangleBodyParameters,SpoolTimer:SpoolTimer,SpoolMath:SpoolMath,SpoolUtils:SpoolUtils,Perlin:Perlin}}catch(e){"undefined"==typeof module?console.log("Modules are not present, you are probably on client, make sure this script is included before the files that require it"):console.error(e)}const SpoolMath={coordVelsFromVel:(e,t)=>({x:Math.cos(t)*e,y:Math.sin(t)*e}),globalAngle:(e,t,o,r)=>Math.atan2(r-t,o-e),objGlobalAngle:(e,t)=>this.globalAngle(e.x,e.y,t.x,t.y),angleDistance:(e,t)=>{var o=(t-e)%(2*Math.PI);return o>0?o>Math.PI?-(2*Math.PI-o):o:o<-Math.PI?-(-2*Math.PI-o):o},distance:(e,t,o,r)=>Math.sqrt(Math.pow(o-e,2)+Math.pow(r-t,2)),objDistance:(e,t)=>Math.sqrt(Math.pow(e.x-t.x,2)+Math.pow(e.y-t.y,2)),polarPoint:(e,t,o,r)=>({x:e+o*Math.cos(r),y:t+o*Math.sin(r)}),rotatePoint:(e,t,o,r,n)=>{var a=Math.sin(n),i=Math.cos(n);return{x:(e-=o)*i-(t-=r)*a+o,y:e*a+t*i+r}},rotatePoints:(e,t,o,r)=>{for(var n=Math.sin(r),a=Math.cos(r),i=[],l=0;l<e.length;l++){var s=e[l][0]-t,c=e[l][1]-o;i.push([s*a-c*n+t,s*n+c*a+o])}return i},transformPoints:(e,t,o)=>{for(var r=[],n=0;n<e.length;n++)r.push([e[n][0]+t,e[n][1]+o]);return r},randomColor:(e,t)=>`rgb(${Math.floor(Math.random()*(t-e)+e)},${Math.floor(Math.random()*(t-e)+e)},${Math.floor(Math.random()*(t-e)+e)})`,randomHsvColor:(e,t)=>SpoolMath.HSVtoColor(Math.random(),e,t),HSVtoColor:(e,t,o)=>{let{r:r,g:n,b:a}=SpoolMath.HSVtoRGB(e,t,o);return`rgb(${r}, ${n}, ${a})`},HSVtoRGB:(e,t=null,o=null)=>{var r,n,a,i,l,s,c,h;switch(!e||t||o||(t=e.s,o=e.v,e=e.h),s=o*(1-t),c=o*(1-(l=6*e-(i=Math.floor(6*e)))*t),h=o*(1-(1-l)*t),i%6){case 0:r=o,n=h,a=s;break;case 1:r=c,n=o,a=s;break;case 2:r=s,n=o,a=h;break;case 3:r=s,n=c,a=o;break;case 4:r=h,n=s,a=o;break;case 5:r=o,n=s,a=c}return{r:Math.round(255*r),g:Math.round(255*n),b:Math.round(255*a)}},lerp:(e,t,o)=>e+(t-e)*(o=o>1?1:o<0?0:o),lerpRotation:(e,t,o)=>e+(((t-e)%(2*Math.PI)+Math.PI/180*540)%(2*Math.PI)-Math.PI)*o%(2*Math.PI),randomInt:(e,t)=>e+Math.round(Math.random()*(t-e)),randomChoice:e=>0==e.length?null:e[SpoolMath.randomInt(0,e.length-1)],toHex:e=>{var t=Number(e).toString(16);return t.length<2&&(t="0"+t),t},rgbToHex:(e,t,o)=>SpoolMath.toHex(e)+SpoolMath.toHex(t)+SpoolMath.toHex(o),divideColor:(e,t)=>{elements=e.substring(4).split(",");for(var o=0;o<elements.length;o++)elements[o]=parseInt(parseInt(elements[o])/t);return SpoolMath.rgbToHex(elements[0],elements[1],elements[2])},inInterval:(e,t,o,r=0)=>{if(t<o)var n=t,a=o;else n=o,a=t;return n-r<=e&&e<=a+r},numberDefined:e=>void 0!==e&&null!==e,getYFromCircle:(e,t)=>{if(e<=t&&e>=-t)var o=Math.sqrt(Math.pow(t,2)-Math.pow(e,2));return-o},getYFromMovedCircle:(e,t,o,r)=>(movY=SpoolMath.getYFromCircle(o,r)+t,movX=o+e,pos=[movX,movY],pos),getAngleFromCircle:(e,t)=>Math.acos(t/e)-Math.PI/2,rectangleMouseCollision:(e,t,o,r,n,a)=>n>=e&&n<=e+o&&a<=t&&a>=t-r,rotatePoint:(e,t,o,r,n)=>{var a=SpoolMath.distance(e,t,o,r),i=SpoolMath.globalAngle(e,-t,o,-r)-n,l=Math.cos(i)*a+e,s=-Math.sin(i)*a+t;return pos=[l,s],pos},getUnitVector:e=>[Math.cos(e),Math.sin(e)],scaleVector:(e,t)=>e.map(e=>e*t),addVectors:(e,t)=>{res=[];for(var o=0;o<e.length;o++)res.push(e[o]+t[o]);return res},averageVectors:e=>{if(0==e.length)return null;temp=e[0];for(var t=1;t<e.length;t++)temp=SpoolMath.addVectors(temp,e[t]);return SpoolMath.scaleVector(temp,1/e.length)},average:e=>{if(0==e.length)return 0;for(var t=0,o=0;o<e.length;o++)t+=e[o];return t/e.length},weightedAverage:(e,t)=>{for(var o=0,r=0,n=0;n<e.length;n++)o+=e[n]*t[n],r+=t[n];return 0==r?0:o/r},sigmoid:e=>1/(1+Math.exp(-e))};var SpoolRect=(e,t,o,r)=>({x:e,y:t,width:o,height:r,cx:e+o/2,cy:t+r/2,contains:(n,a)=>e<=n&&n<=e+o&&t<=a&&a<=t+r});try{module.exports={SpoolMath:SpoolMath,SpoolRect:SpoolRect}}catch(e){"undefined"==typeof module?console.log("Modules are not present, you are probably on client, make sure this script is included before the files that require it"):console.error(e)}var MessageCodes={SM_RESET:"reset",SM_PACK_INIT:"init-pack",SM_PACK_UPDATE:"update-pack",SM_PACK_REMOVE:"remove-pack",OS_GET_OBJ:"get-obj",OS_SEND_OBJ:"send-obj",ASIGN_CLIENT_ID:"asign-id",SM_KEY_PRESS:"key-press",SM_MOUSE_INPUT:"mouse-clicked",KI_MOV_LEFT:"MOV_LEFT",KI_MOV_RIGHT:"MOV_RIGHT",KI_MOV_UP:"KI_MOV_UP",KI_MOV_DOWN:"KI_MOV_DOWN",SERVER_LOADING:"SERVER_LOADING"};try{module.exports={...MessageCodes}}catch(e){console.warn("Module exporting is not present. If you are in client make sure you include files correctly in you index file.")}var SpoolRenderer={ctx:null,camera:null,setColor:e=>{SpoolRenderer.ctx.fillStyle=e},setFont:(e,t)=>{SpoolRenderer.ctx.font=`${t}px ${e}`},drawInscribedOval:e=>{SpoolRenderer.ctx.beginPath(),SpoolRenderer.ctx.ellipse(e.cx,e.cy,e.width/2,e.height/2,0,0,360),SpoolRenderer.ctx.stroke()},fillInscribedOval:e=>{SpoolRenderer.ctx.beginPath(),SpoolRenderer.ctx.ellipse(e.cx,e.cy,e.width/2,e.height/2,0,0,360),SpoolRenderer.ctx.fill()},drawLine:(e,t,o,r)=>{SpoolRenderer.ctx.beginPath(),SpoolRenderer.ctx.moveTo(e,t),SpoolRenderer.ctx.lineTo(o,r),SpoolRenderer.ctx.stroke()},fillInscribedOvalPercentFull:(e,t)=>{if(SpoolRenderer.ctx.beginPath(),t>.5){var o=t-.5,r=Math.asin(2*o);SpoolRenderer.ctx.ellipse(e.cx,e.cy,e.width/2,e.height/2,0,-r,Math.PI+r)}else r=Math.asin(2*(.5-t)),SpoolRenderer.ctx.ellipse(e.cx,e.cy,e.width/2,e.height/2,0,r,Math.PI-r);SpoolRenderer.ctx.fill()},drawOval:(e,t,o)=>{SpoolRenderer.ctx.beginPath(),SpoolRenderer.ctx.arc(e,t,o,0,360),SpoolRenderer.ctx.stroke()},fillOval:(e,t,o)=>{SpoolRenderer.ctx.beginPath(),SpoolRenderer.ctx.arc(e,t,o,0,360),SpoolRenderer.ctx.fill()},linePolygon:e=>{SpoolRenderer.ctx.beginPath(),SpoolRenderer.ctx.moveTo(e[0][0],e[0][1]);for(var t=1;t<e.length;t++)SpoolRenderer.ctx.lineTo(e[t][0],e[t][1]);SpoolRenderer.ctx.closePath()},fillPolygon:e=>{SpoolRenderer.linePolygon(e),SpoolRenderer.ctx.fill()},renderRotatedSprite:(e,t,o,r,n)=>{SpoolRenderer.ctx.save(),SpoolRenderer.ctx.translate(o,r),SpoolRenderer.ctx.rotate(-t),SpoolRenderer.ctx.drawImage(e,n.x,n.y,n.width,n.height),SpoolRenderer.ctx.restore()},drawRect:(e,t,o,r)=>{SpoolRenderer.ctx.drawRect(e,t,o,r)},fillRect:(e,t,o,r)=>{SpoolRenderer.ctx.fillRect(e,t,o,r)},fillSplRect:e=>{SpoolRenderer.ctx.fillRect(e.x,e.y,e.width,e.height)},fillRoundRect(e,t,o,r,n,a=0,i=!0,l=!1){if(void 0===a&&(a=5),"number"==typeof a)a={tl:a,tr:a,br:a,bl:a};else{var s={tl:0,tr:0,br:0,bl:0};for(var c in s)a[c]=a[c]||s[c]}e.beginPath(),e.moveTo(t+a.tl,o),e.lineTo(t+r-a.tr,o),e.quadraticCurveTo(t+r,o,t+r,o+a.tr),e.lineTo(t+r,o+n-a.br),e.quadraticCurveTo(t+r,o+n,t+r-a.br,o+n),e.lineTo(t+a.bl,o+n),e.quadraticCurveTo(t,o+n,t,o+n-a.bl),e.lineTo(t,o+a.tl),e.quadraticCurveTo(t,o,t+a.tl,o),e.closePath(),i&&e.fill(),l&&e.stroke()},multiLineText:(e,t,o,r=.33,n=null)=>{var a=[];e.split("\n").forEach(e=>{var t=e.split(" "),r="";SpoolRenderer.ctx.textAlign="center",t.forEach((e,t)=>{SpoolRenderer.ctx.measureText(r+e).width>=o?(a.push(r.trim()),r=e):r+=" "+e}),r&&a.push(r.trim())});var i=parseInt(SpoolRenderer.ctx.font)+3;a.forEach((e,o)=>{var l=t.x+t.width/2,s=t.y+t.height/2-(a.length-1)/2*i+o*i+i*r;n&&(SpoolRenderer.ctx.lineWidth=n,SpoolRenderer.ctx.strokeText(e,l,s)),SpoolRenderer.ctx.fillText(e,l,s)})},simpleText:(e,t,o,r=null)=>{r&&(SpoolRenderer.ctx.lineWidth=r,SpoolRenderer.ctx.strokeText(e,t,o)),SpoolRenderer.ctx.fillText(e,t,o)}};console.log("loaded");var SpoolUIElement=e=>{var t={elements:{},layerKeys:[],x:0,y:0,width:0,height:0,layer:10,visible:!0,bgColor:null,fgColor:null,strokeColor:null,textMargin:10,id:Math.random(),lineHeight:10,bindedMouseEvent:null,mouseUp:!1,mouseDown:!0,...e};return t.left=t.x,t.top=t.y,t.right=t.x+t.width,t.bottom=t.y+t.height,t.update=(()=>{}),t.render=(e=>{t.renderBounds(e),t.renderSprite(e),t.renderText(e),t.layerKeys.forEach(o=>{o.ids.forEach(r=>{t.elements[o.key][r].update(),t.elements[o.key][r].visible&&t.elements[o.key][r].render(e)})})}),t.renderBounds=(e=>{t.radius?(t.bgColor&&(e.fillStyle=t.bgColor),t.strokeColor&&(e.strokeStyle=t.strokeColor),drawRoundRect(e,t.x,t.y,t.width,t.height,t.radius,t.bgColor,t.strokeColor)):(e.beginPath(),e.lineWidth="1",e.rect(t.x,t.y,t.width,t.height),t.bgColor&&(1!=t.bgOpacity?(e.globalAlpha=t.bgOpacity,e.fillStyle=t.bgColor,e.fill(),e.globalAlpha=1):(e.fillStyle=t.bgColor,e.fill())))}),t.renderText=(e=>{if(t.text)if(t.disabled?e.fillStyle="gray":t.fgColor?e.fillStyle=fgColor:e.fillStyle="white",t.font&&(e.font=t.font),e.textAlign="center",t.multiLine){if(!t.linesSplit||!t.textLines||t.linesSplit!=t.text){var o="",r=[];t.text.split(" ").forEach((n,a)=>{e.measureText(o+n).width>=t.width-2*t.textMargin?(r.push(o),o=n):o+=" "+n}),o&&r.push(o),t.lineHeight=parseInt(e.font)+3,t.textLines=r}t.textLines.forEach((o,r)=>{e.fillText(o,t.x+t.width/2,t.y+t.height/2-t.textLines.length/2*t.lineHeight+r*t.lineHeight)}),t.linesSplit=t.text}else e.fillText(t.text,t.x+t.width/2,t.y+t.height/2)}),t.renderSprite=((e,o=t.sprite,r=1)=>{o&&e.drawImage(o,t.x+t.width/2-t.width/2*r,t.y+t.height/2-t.height/2*r,t.width*r,t.height*r)}),t.mouseEvent=((e,o=t.mouseUp,r=t.mouseDown)=>{var n=!1;return!t.disabled&&(t.layerKeys.forEach(o=>{o.ids.forEach(r=>{t.elements[o.key][r].visible&&(n|=t.elements[o.key][r].mouseEvent(e))})}),n||(recognizedEvent="mouseup"==e.type&&o||"mousedown"==e.type&&r,!(!t.bindedMouseEvent||!recognizedEvent)&&(t.x<=e.x&&e.x<=t.x+t.width&&t.y<=e.y&&e.y<=t.y+t.width&&!1!==(n=t.bindedMouseEvent(e,t)))))}),t.mouseMove=(e=>{t.mx=e.clientX,t.my=e.clientY;var o=!1,r=!1;t.layerKeys.forEach(o=>{o.ids.forEach(n=>{t.elements[o.key][n].visible&&(r|=t.elements[o.key][n].mouseMove(e))})});var n=t.mouseOn,a=t.mouseIn;return r?(n=!1,a=!0,o=!1):(t.x<=e.x&&e.x<=t.x+t.width&&t.y<=e.y&&e.y<=t.y+t.width&&(o=!0),n=o,a=o),n!=t.mouseOn&&(n&&t.onMouseEnter?t.onMouseEnter(e,t):!n&&t.onMouseLeave&&t.onMouseLeave(e,t),t.mouseOn=n),t.mouseOn=a,o}),t.add=(e=>{t.elements[e.layer]||(t.elements[e.layer]={}),t.elements[e.layer][e.id]=e,t.refreshKeys()}),t.remove=(e=>{delete t.elements[e],t.refreshKeys()}),t.forEachElement=(e=>{t.layerKeys.forEach(o=>{o.ids.forEach(r=>{e(t.elements[o.key][r])})})}),t.removeAll=(()=>{t.elements={},t.layerKeys=[]}),t.refreshKeys=(()=>{var e=Object.keys(t.elements).sort((e,t)=>parseInt(e)-parseInt(t));t.layerKeys=[],e.forEach(e=>{t.layerKeys.push({key:e,ids:Object.keys(t.elements[e])})})}),t.alignItems=((e,o,r)=>{var n=null,a=null,i=null,l=null;t.layerKeys.forEach(e=>{e.ids.forEach(o=>{var r=t.elements[e.key][o];(!n||r.x<n)&&(n=r.x),(!i||r.y<i)&&(i=r.y),(!a||r.x+r.width>a)&&(a=r.x+r.width),(!l||r.y+r.height>l)&&(l=r.y+r.height)})});var s=o-(n+a)/2,c=r-(i+l)/2;console.log(s,c),t.layerKeys.forEach(e=>{e.ids.forEach(o=>{t.elements[e.key][o].x+=s,t.elements[e.key][o].y+=c})})}),t.getElementBounds=(()=>{var e=null,o=null,r=null,n=null;return t.layerKeys.forEach(a=>{a.ids.forEach(i=>{var l=t.elements[a.key][i];(!e||l.x<e)&&(e=l.x),(!r||l.y<r)&&(r=l.y),(!o||l.x+l.width>o)&&(o=l.x+l.width),(!n||l.y+l.height>n)&&(n=l.y+l.height)})}),{x:e,y:r,width:o-e,height:n-r,left:e,right:o,top:r,bottom:n}}),t.pack=(()=>{var e=t.getElementBounds();t.x=e.x,t.y=e.y,t.width=e.width,t.height=e.height}),t},SpoolUIHandler=e=>SpoolUIElement({initObject:e}),SpoolUIButton=e=>SpoolUIElement({...e}),SpoolUIButtonList=(e,t,o=SpoolUIButton)=>{var r=SpoolUIElement({rows:1,columns:1,margin:10,buttonWidth:50,buttonHeight:50,offsetX:.5,offsetY:.5,...e});r.width=(r.margin+r.buttonWidth)*r.columns,r.height=(r.margin+r.buttonHeight)*r.rows;var n=r.x-r.width*r.offsetX,a=r.y-r.height*r.offsetY,i=0;return r.left=n,r.up=a,r.right=n+r.width,r.bottom=a+r.height,r.buttons=[],t.forEach(e=>{var t=o({x:n+i%r.columns*(r.buttonWidth+r.margin),y:a+Math.floor(i/r.columns)*(r.buttonWidth+r.margin),width:r.buttonWidth,height:r.buttonHeight,...e});i+=1,r.buttons.push(t),r.add(t)}),r},LoadingUI=(e,t)=>{var o=SpoolUIElement({client:e,x:e.gameArea.width-60,y:e.gameArea.height-60,width:50,height:50,overlay:!1,overlayColor:"white",...t});return o.animationFrame=0,o.bounds=SpoolRect(o.x,o.y,o.width,o.height),o.render=(t=>{o.animationFrame+=1,(o.client.serverSideLoading||o.client.clientSideLoading)&&(o.overlay&&(SpoolRenderer.setColor(o.overlayColor),SpoolRenderer.fillRect(0,0,o.client.gameArea.width,o.client.gameArea.height),SpoolRenderer.setColor("black"),SpoolRenderer.setFont("Arial",50),e.serverSideLoadingData&&e.serverSideLoadingData.message?(t.textAlign="center",SpoolRenderer.simpleText(e.serverSideLoadingData.message,o.client.gameArea.width/2,o.client.gameArea.height/2),t.textAlign="right",SpoolRenderer.simpleText("Loading",o.bounds.cx-2*o.bounds.width,o.bounds.cy)):(t.textAlign="center",SpoolRenderer.simpleText("Loading",o.client.gameArea.width/2,o.client.gameArea.height/2))),SpoolRenderer.setColor("black"),SpoolRenderer.drawInscribedOval("black"),SpoolRenderer.fillInscribedOvalPercentFull(o.bounds,o.animationFrame/30),o.animationFrame>30&&(o.animationFrame=0))}),o};const SpoolUtils={forEachInObject:(e,t)=>{Object.keys(e).forEach(o=>{t(e[o],o)})},shuffle:e=>{e.sort(()=>Math.random()-.5)},subarray:(e,t,o)=>o<=t?[]:e.filter((e,r)=>r>=t&&r<o)};try{module.exports={SpoolUtils:SpoolUtils}}catch(e){"undefined"==typeof module?console.log("Modules are not present, you are probably on client, make sure this script is included before the files that require it"):console.error(e)}var client=Client({keyToConstructor:null,loopUpdateCall:!0,FPS:60,pureLocalClient:!0}),RENDER_LINES=!1,Boid=(e={})=>{var t=Entity({width:12,height:10,radius:10,objectType:"BOID",rotation:Math.PI/2,color:SpoolMath.randomHsvColor(.5,.8),...e},ClientEntity),o={update:t.update};return t.render=((e,o)=>{var r=o.transformBounds(t.x,t.y,t.width,t.height),n=[[-r.width/2,-r.height/2],[-r.width/2,r.height/2],[r.width/2,0]],a=SpoolMath.rotatePoints(n,0,0,-t.rotation),i=SpoolMath.transformPoints(a,r.x,r.y);SpoolRenderer.setColor("black"),SpoolRenderer.fillPolygon(i)}),t.update=((e,r)=>{var n=SpoolMath.getUnitVector(t.rotation);t.setVelVector("movement",SpoolMath.scaleVector(n,3)),o.update()}),t},BoidManager=(e,t)=>{var o={handler:t,vision:80,obstacleVision:60,cohesionCoef:.4,alignmentCoef:.7,avoidanceCoef:.3,boidWeight:.6,maxSteering:1,obstacleWeight:8,...e,avoid:(e,t,r,n,a)=>{var i=e.x,l=e.y,s=SpoolMath.globalAngle(i,l,t,r),c=SpoolMath.angleDistance(e.rotation,s);s=0;return{steering:-(s=c>0?Math.PI-c:-Math.PI-c)*o.avoidanceCoef,weight:a*(1-n)}},cohesion:(e,t)=>{var r=SpoolMath.averageVectors(t);if(!r)return{steering:0,weight:0};var n=SpoolMath.globalAngle(e.x,e.y,r[0],r[1]);return{steering:SpoolMath.angleDistance(e.rotation,n),weight:o.cohesionCoef}},alignment:(e,t)=>{return 0==t.length?{steering:0,weight:0}:{steering:SpoolMath.angleDistance(e.rotation,SpoolMath.average(t)),weight:o.alignmentCoef}},update:e=>{if("BOID"==e.objectType){for(var r=[],n=[],a=[],i=[],l=[[-o.handler.client.width/2,-o.handler.client.height/2],[-o.handler.client.width/2,+o.handler.client.height/2],[+o.handler.client.width/2,-o.handler.client.height/2],[+o.handler.client.width/2,+o.handler.client.height/2],[-o.handler.client.width/2,e.y],[+o.handler.client.width/2,e.y],[e.x,-o.handler.client.height/2],[e.x,+o.handler.client.height/2]],s=0;s<l.length;s++){var c=l[s];(u=SpoolMath.distance(e.x,e.y,c[0],c[1]))<1.2*o.vision&&a.push([c[0],c[1],u/(1.2*o.vision),4])}for(type in t.objects)for(key in t.objects[type]){var h=e,d=t.objects[type][key];if(h!=d){var u=SpoolMath.objDistance(h,d);if((u=Math.max(0,u-d.width/2-h.width/2))<o.vision&&"BOID"==d.objectType&&(i.push(d.rotation),r.push([d.x,d.y])),u<o.obstacleVision){var p=[d.x,d.y,u/o.obstacleVision,"BOID"==d.objectType?o.boidWeight:o.obstacleWeight];n.push(p)}}}var g=n.concat(a);RENDER_LINES&&g.forEach(e=>{});var y=[],m=[];g.forEach(t=>{var r=o.avoid(e,t[0],t[1],t[2],t[3]);if(y.push(r.steering),m.push(r.weight),RENDER_LINES){var n=SpoolRenderer.camera.transformPoint(e.x,e.y),a=SpoolRenderer.camera.transformPoint(t[0],t[1]);SpoolRenderer.ctx.lineWidth=2,SpoolRenderer.ctx.strokeStyle=`rgba(0, 0, 0, ${1-t[2]})`,SpoolRenderer.drawLine(n.x,n.y,a.x,a.y)}}),cohesionSteering=o.cohesion(e,r),alignmentSteering=o.alignment(e,i),y.push(cohesionSteering.steering),m.push(cohesionSteering.weight),y.push(alignmentSteering.steering),m.push(alignmentSteering.weight),e.rotation+=(SpoolMath.sigmoid(SpoolMath.weightedAverage(y,m))-.5)*o.maxSteering}}};return o},boidManager=BoidManager({},client.handler);client.handler.addManager(boidManager);var BouncingManager=(e,t)=>{var o={handler:t,...e,update:e=>{if("BOID"==e.objectType){var t=o.handler.client.width,r=o.handler.client.height,n=e.calculatedVelX,a=e.calculatedVelY;e.y<-r/2&&(e.y=-r-e.y,e.setVelVector("movement",e.vectorFromVels(n,-a)),e.rotation=Math.atan2(-a,n)),e.y>r/2&&(e.y=r-e.y,e.setVelVector("movement",e.vectorFromVels(n,-a)),e.rotation=Math.atan2(-a,n)),e.x<-t/2&&(e.x=-t-e.x,e.setVelVector("movement",e.vectorFromVels(-n,a)),e.rotation=Math.atan2(a,-n)),e.x>t/2&&(e.x=t-e.x,e.setVelVector("movement",e.vectorFromVels(-n,a)),e.rotation=Math.atan2(a,-n))}}};return o};client.handler.addManager(BouncingManager({},client.handler));var Ball=(e={})=>{return Entity({width:200,height:200,radius:100,objectType:"BALL",color:"black",...e},ClientEntity)},Player=(e={})=>{var t=Entity({maxAcc:10,x:0,y:0,width:100,height:100,radius:50,objectType:"PLAYER",rotation:Math.PI/2,color:"black",...e},ClientEntity),o={update:t.update,updatePack:t.updatePack,render:t.render};return t.updateInputVel=(()=>{t.standStill?t.setVelVector("movement",[0,0]):(xVelocity=0,yVelocity=0,(t.pressedLeft||t.pressedRight||t.pressedUp||t.pressedDown)&&(t.pressedLeft&&(xVelocity-=t.maxAcc),t.pressedRight&&(xVelocity+=t.maxAcc),t.pressedUp&&(yVelocity+=t.maxAcc),t.pressedDown&&(yVelocity-=t.maxAcc)),t.setVelVector("movement",[xVelocity,yVelocity]))}),t.mouseEventInWorld=((e,t)=>{client.handler.add(Boid({x:e,y:t}))}),t.update=(()=>{t.updateInputVel(),o.update()}),t.render=((e,t)=>{o.render(e,t)}),t};keysToConstructors={player:{const:Player},boid:{const:Boid},ball:{const:Ball}};var objectSpawner=ObjectSpawner(client.handler,keysToConstructors),player=Player({x:0,y:0});client.handler.add(player),client.clientObject=player,client.camera.lerp=!0,keyListener=KeyboardListener(client),keyListener.initListener(),keyListener.onKeyDown=(e=>{32==e.keyCode&&(RENDER_LINES=!RENDER_LINES)}),mouseListener=MouseListener(client,{activeTypes:["mousedown"]}),mouseListener.mouseCoordTransformation=client.camera.inverseTransformPoint,mouseListener.initListener(),mouseListener.onMouseEvent=(e=>{console.log(e)}),objectSpawner.spawnInRectangle("boid",100,-client.width/2,-client.height/2,client.width,client.height);var ball=objectSpawner.spawn("ball",-client.width/4,0);ball=objectSpawner.spawn("ball",+client.width/4,0);SpoolRenderer.camera=client.camera,client.startGameLoop();