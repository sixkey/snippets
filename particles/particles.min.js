function assert(e,t){if(!e)throw new Error(t)}function arraysEqual(e,t){if(e===t)return!0;if(null==e||null==t)return!1;if(e.length!==t.length)return!1;for(var s=0;s<e.length;++s)if(e[s]!==t[s])return!1;return!0}function ABList(e,t){this.allow=e?new Set(e):null,this.block=t?new Set(t):null}ABList.prototype.allowed=function(e){return(!this.block||!this.block.has(e))&&(!this.allow||this.allow.has(e))};const SPMath={polarPoint:(e,t,s)=>SPTensors.vector([e.x+t*Math.cos(s),e.y+t*Math.sin(s)]),polarPoints:(e,t,s=1,n=0,o=0)=>{for(var r=[],i=0;i<e;i++){var a=SPMath.polarPoint(t,s,(i-(e-1)/2)*o+n);r.push(a)}return r},rotatePoint:(e,t,s)=>{var n=Math.sin(s),o=Math.cos(s),r=SPTensors.sub(e,t);return SPTensors.vector([r.x*o+r.y*n+t.x,r.x*n-r.y*o+t.y])},rotatePoints:(e,t,s)=>e.map(e=>rotatePoint(e,t,s)),rotatePolygon:(e,t,s)=>{let n=e.copy(),o=n.shape[0];for(let e=0;e<o;e++){var r=n.subTensor([e]),i=SPMath.rotatePoint(r,t,s);n.set(2*e,i.x),n.set(2*e+1,i.y)}return n},transformPoints:(e,t)=>e.map(e=>SPTensors.add(e,t)),distance:function(e,t){return Math.sqrt(Math.pow(e.x-t.x,2)+Math.pow(e.y-t.y,2))},angleDistance:function(e,t){var s=(t-e)%(2*Math.PI);return s>0?s>Math.PI?-(2*Math.PI-s):s:s<-Math.PI?-(-2*Math.PI-s):s},point:function(e,t){return SPTensors.vector([e,t])},rect:function(e,t,s,n){return SPTensors.vector([e,t,s,n])},getRect:function(e,t){var s=Math.min(e.x,t.x),n=Math.min(e.y,t.y),o=Math.abs(e.x-t.x),r=Math.abs(e.y-t.y);return SPTensors.vector([s,n,o,r])},rectToPolygon:function(e){return SPTensors.tensor([4,2],[e.x,e.y,e.x+e.width,e.y,e.x+e.width,e.y+e.height,e.x,e.y+e.height])},rectContains:(e,t)=>e.x<t.x&&t.x<e.x+e.width&&e.y<t.y&&t.y<e.y+e.height,rectCollision:(e,t)=>{let s=SPTensors.vector([e.x-t.width/2,e.y-t.height/2,e.width+t.width,e.height+t.height]),n=SPTensors.vector([t.x+t.width/2,t.y+t.height/2]);return SPMath.rectContains(s,n)},lineIntersection:(e,t)=>{var s=e.x,n=e.xx,o=e.y,r=e.yy,i=t.x,a=t.xx,h=t.y,c=t.yy,p=(s-n)*(h-c)-(o-r)*(i-a);if(0==p)return null;var u=((s*r-o*n)*(i-a)-(s-n)*(i*c-h*a))/p,l=((s*r-o*n)*(h-c)-(o-r)*(i*c-h*a))/p;return SPMath.inRange(u,s,n,2)&&SPMath.inRange(u,i,a,2)&&SPMath.inRange(l,o,r,2)&&SPMath.inRange(l,h,c,2)?SPTensors.vector([u,l]):null},polygoneLineIntersection:(e,t)=>{for(var s=t.shape[0],n=[],o=0;o<t.shape[0];o++){var r=t.subTensor([o]),i=t.subTensor([(o+1)%s]),a=SPTensors.link([r,i],[2,2]),h=SPMath.lineIntersection(e,a);h&&n.push(h)}return n},unitVector:e=>SPTensors.vector([Math.cos(e),Math.sin(e)]),range:function*(e=0,t=100,s=1){let n=0;for(let o=e;o<t;o+=s)n++,yield o;return n},inRange:(e,t,s,n=0)=>{if(t<s)var o=t,r=s;else o=s,r=t;return o-n<=e&&e<=r+n},clamp:(e,t,s)=>Math.max(Math.min(e,s),t),randRange:(e,t)=>Math.random()*(t-e)+e,randPointInRect:e=>SPTensors.vector([e.x+SPMath.randRange(0,e.width),e.y+SPMath.randRange(0,e.height)]),sigmoid:e=>1/(1+Math.exp(-e)),posmod:(e,t)=>(e%t+t)%t,posmodRange:(e,t,s)=>t+SPMath.posmod(e-t,s-t)},basicAliases={x:0,y:1,z:2,w:3,xx:2,yy:3,a:0,b:1,c:2,d:3,width:2,height:3};function TensorBase(e){this.shape=e,this.size=SPTensors.getSize(e),this.dimension=SPTensors.getDimensions(e)}function Tensor(e,t=null,s=(()=>0)){if(TensorBase.call(this,e),this.type="fixed",this.levelSizes=SPTensors.getLevelSizes(e),t){if(t.length!=this.size)throw new Error(`The size of values (${t.length}) doesn't match the shape of the tensor (${e})`);this.values=t}else this.values=Array.from({length:this.size},s)}function VariableTensor(e,t,s=(()=>0)){if(TensorBase.call(this,e),this.type="variable",this.indexes=SPTensors.getIndexesMap(e)[0],t){if(t.length!=this.size)throw new Error(`The size of values (${t.length}) doesn't match the shape of the tensor (${e})`);this.values=t}else this.values=Array.from({length:this.size},s)}TensorBase.prototype.getIndex=function(e){return this.getIndexAndShape(e).index},TensorBase.prototype.getValue=function(e){const t=this.getIndex(e);return this.get(t)},TensorBase.prototype.getValues=function(){res=[];for(var e=0;e<this.size;e++)res.push(this.get(e));return res},TensorBase.prototype.T=function(){if(2!=this.dimension)throw`You can only transpose 2-d tensor, not ${this.dimension}-d`;var e=[this.shape[1],this.shape[0]],t=new SubTensor(self,e);return t.get=(e=>{var t=Math.floor(e/this.shape[0]),s=e%this.shape[0];return this.get(s*this.shape[1]+t)}),t},TensorBase.prototype.copy=function(e=((e,t)=>e)){return SPTensors.copy(this,e)},TensorBase.prototype.apply=function(e=((e,t)=>e)){return SPTensors.apply(this,e)},TensorBase.prototype.add=function(e){return"number"==typeof e?this.apply(t=>t+e):this.apply((t,s)=>t+e.get(s))},TensorBase.prototype.sub=function(e){return"number"==typeof e?this.apply(t=>t-e):this.apply((t,s)=>t-e.get(s))},TensorBase.prototype.mult=function(e){return"number"==typeof e?this.apply(t=>t*e):this.apply((t,s)=>t*e.get(s))},TensorBase.prototype.toString=function(){return SPTensors.toString(this)},TensorBase.prototype.reshape=function(e){if(SPTensors.getSize(e)!=this.size)throw new Error(`You can't reshape ${this.size} values into ${e.toString()}`);return this.shape=e,this.dimension=SPTensors.getDimensions(e),this},TensorBase.prototype.subTensor=function(e){if(this.shape.length-e.length<0)throw`${e.length} coords for ${s.length} array`;let{index:t,shape:s}=this.getIndexAndShape(e);return new SubTensor(this,s,t,t+SPTensors.getSize(this.shape))},Object.keys(basicAliases).forEach(function(e){Object.defineProperty(TensorBase.prototype,e,{get:function(){return this.get(basicAliases[e])},set:function(t){return this.set(basicAliases[e],t)}})}),Tensor.prototype=Object.create(TensorBase.prototype),Tensor.prototype.get=function(e){return this.values[e]},Tensor.prototype.getValues=function(){return this.values},Tensor.prototype.set=function(e,t){return this.values[e]=t,this.values[e]},Tensor.prototype.getIndexAndShape=function(e){return SPTensors.getIndexAndShape(this.shape,e,this.levelSizes)},VariableTensor.prototype=Object.create(TensorBase.prototype),VariableTensor.prototype.get=function(e){return this.values[e]},VariableTensor.prototype.set=function(e,t){return this.values[e]=t},VariableTensor.prototype.getIndexAndShape=function(e){return SPTensors.getVariableIndexAndShape(this.shape,e,this.indexes)},VariableTensor.prototype.subTensor=function(e){let{index:t,shape:s}=this.getIndexAndShape(e);return new SubTensor(this,s,t,t+SPTensors.getSize(this.shape))},VariableTensor.prototype.toString=function(){for(var e="",t=0;t<this.shape.length;t++)e+=this.subTensor([t]).toString()+"\n";return e};const isVariable=e=>e.length>0&&e[0].constructor===Array;function SubTensor(e,t,s=null,n=null){TensorBase.call(this,t),this.parent=e,this.start=s,this.end=n,this.type="sub",null===this.start&&(this.start=0),null===this.end&&(this.end=SPTensors.getSize(t)),isVariable(t)?(this.indexes=SPTensors.getIndexesMap(this.shape)[0],this.getIndexAndShape=VariableTensor.prototype.getVariableIndexAndShape):(this.levelSizes=SPTensors.getLevelSizes(this.shape),this.getIndexAndShape=Tensor.prototype.getVariableIndexAndShape)}function LinkTensor(e,t){TensorBase.call(this,t),this.sizes=e.map(e=>e.size),this.tensors=e,this.tensorsNumber=e.length,this.levelSizes=SPTensors.getLevelSizes(t),this.type="link"}SubTensor.prototype=Object.create(TensorBase.prototype),SubTensor.prototype.get=function(e){return this.parent.get(e+this.start)},SubTensor.prototype.set=function(e,t){return this.parent.set(e+this.start,t)},SubTensor.prototype.subTensor=function(e){if(this.shape.length-e.length<0)throw`${e.length} coords for ${s.length} array`;let{index:t,shape:s}=this.getIndex(e);var n=SPTensors.getSize(s);return new SubTensor(this.parent,s,t+start,t+start+n)},SubTensor.prototype.toString=function(){return new Tensor(this.shape,null,(e,t)=>this.get(t)).toString()},LinkTensor.prototype=Object.create(TensorBase.prototype),LinkTensor.prototype.getRelevantTensor=function(e){for(var t=0,s=0;s+this.sizes[t]<=e;)if(t+=1,s+=this.sizes[t],assert(t<this.tensorsNumber,"Index out of range"))return;return{ten:this.tensors[t],off:e-s}},LinkTensor.prototype.get=function(e){let{ten:t,off:s}=this.getRelevantTensor(e);return t.get(s)},LinkTensor.prototype.set=function(e,t){let{ten:s,off:n}=this.getRelevantTensor(e);return s.set(n)},LinkTensor.prototype.getIndexAndShape=function(e){return SPTensors.getIndexAndShape(this.shape,e,this.levelSizes)};var operations=["apply",""],SPTensors={apply:(e,t=((e,t)=>e))=>{assert(e.set&&e.get,"Not a valid tensor");for(var s=0;s<e.size;s++)e.set(s,t(e.get(s),s));return e},copy:(e,t=(e=>e))=>{assert(e.shape&&e.get,"Not a valid tensor");for(var s=e.getValues(),n=[],o=0;o<s.length;o++)n.push(t(s[o],o));return new(SPTensors.constructorForShape(e.shape))(e.shape,n)},tensor:(e,t,s)=>(assert(e),new(SPTensors.constructorForShape(e))(e,t,s)),vector:e=>new Tensor([e.length],e),const:(e,t)=>SPTensors.tensor(e,null,()=>{}),zeros:e=>SPTensors.const(e),ones:e=>SPTensors.const(e,1),constLike:(e,t=0)=>SPTensors.copy(e,()=>t),zerosLike:e=>SPTensors.constLike(a),onesLike:e=>SPTensors.constLike(a,1),random:(e,t=0,s=1)=>new(SPTensors.constructorForShape(e))(e,null,()=>SPMath.randRange(t,s)),randomIn:e=>{for(var t=[],s=e.getValues(),n=0;n<size;n++)t.push(SPMath.randRange(0,s[n]));return SPTensors.tensor(e.shape,t)},randomLike:(e,t=0,s=1)=>SPTensors.copy(e,()=>SPMath.randRange(t,s)),range:(e,t=1)=>new(SPTensors.constructorForShape(e))(e,null,(e,s)=>s*t),elementWiseOperation:(e,t,s,n=!1)=>{var o=e.getValues();if(n)return SPTensors.tensor(e.shape,o.map((e,n)=>s(e,t.get(n%t.size))));assert(arraysEqual(e.shape,t.shape),`The shapes of the tensors don't match: ${e.shape} != ${t.shape}`);for(var r=t.getValues(),i=[],a=0;a<o.length;a++)i.push(s(o[a],r[a]));return SPTensors.tensor(e.shape,i)},add:(e,t,s=!1)=>"number"==typeof t?SPTensors.copy(e,e=>e+t):SPTensors.elementWiseOperation(e,t,(e,t)=>e+t,s),sub:(e,t,s=!1)=>"number"==typeof t?SPTensors.copy(e,e=>e-t):SPTensors.elementWiseOperation(e,t,(e,t)=>e-t,s),mult:(e,t,s=!1)=>"number"==typeof t?SPTensors.copy(e,e=>e*t):SPTensors.elementWiseOperation(e,t,(e,t)=>e*t,s),div:(e,t,s=!1)=>"number"==typeof t?SPTensors.copy(e,e=>e*t):SPTensors.elementWiseOperation(e,t,(e,t)=>e/t,s),dot:(e,t,s=[],n=[])=>{if(2!=e.dimension&&2!=t.dimension)throw new Error(`Dot product supports only 2-d tensor dot your (${e.dimension}-d . ${t.dimension}-d)`);aValues=e.values,bValues=t.values;let o=e.getIndexAndShape(s),r=o.index,i=o.shape;var a=i[0],h=i[1];let c=t.getIndexAndShape(n),p=c.index,u=c.shape;var l=u[0],d=u[1];if(h!=l)throw`Shapes of the tensors are not compatible for dot ${i} ${u}`;for(var y=[a,d],m=[],f=0;f<a;f++)for(var S=0;S<d;S++){for(var g=0,v=0;v<h;v++)g+=aValues[r+f*h+v]*bValues[p+v*d+S];m.push(g)}return new Tensor(y,m)},concat:(e,t)=>{let s=e.map(e=>e.getValues());return s=s.flat(1),void 0===t?new VariableTensor(e.map(e=>e.shape),[].concat(...e.map(e=>e.values))):new Tensor(t,s)},link:(e,t)=>new LinkTensor(e,t),constructorForShape:e=>{var t=Tensor;return e.length>0&&e[0].constructor===Array&&(t=VariableTensor),t},getIndexAndShape:(e,t,s=null)=>{var n=0;s||(s=SPTensors.getLevelSizes(e)),t.forEach((t,o)=>{if(!SPMath.inRange(t,0,e[o]))throw new Error(`${t} at in depth ${o} is out of range shape - [${e}]`);n+=t*s[1+o]});var o=e.slice(t.length);return{index:n,shape:o}},getVariableIndexAndShape:(e,t,n=null)=>{null===n&&(n=SPTensors.getIndexesMap(s)[0]);for(var o=n,r=e,i={index:o[0],shape:r},a=0;a<t.length;a++){var h=t[a];if(o=o[h],r=r[h],o.constructor!==Array)return(i=SPTensors.getIndexAndShape(r,t.slice(a+1))).index+=o,i;i={index:o[0],shape:r}}return i},getLevelSizes:e=>{for(var t=[1],s=1,n=e.length,o=0;o<n;o++)s*=e[n-o-1],t.push(s);return t.reverse(),t},getSize:e=>0==e.length?1:e[0].constructor===Array?e.map(e=>SPTensors.getSize(e)).reduce((e,t)=>e+t):e.reduce((e,t)=>e*t),getIndexesMap:(e,t=0)=>[e.map(e=>{if(e[0].constructor===Array){var s=SPTensors.getIndexesMap(e,t);return t+=s[1],s[0]}return index=t,t+=e.reduce((e,t)=>e*t),index}),t],getDimensions:e=>e.length,toFixedSize:(e,t=6)=>{for(var s=e.toString();(s.length+1)%t!=0;)s+=" ";return s},toString:(e,t=0,s=0,n="")=>{var o="",r=e.shape.length-s;if(1==r){o+=n;for(var i=0;i<e.shape[e.shape.length-1];i++){var a=6,h=", ";e.dimension<2&&(a=1),i==e.shape[e.shape.length-1]-1&&(a=1,h=""),o+=SPTensors.toFixedSize(e.get(i+t)+h,a)}}else{for(2!=r&&(o+=n+"[\n"),i=0;i<e.shape[s];i++){var c=t+i*e.shape.slice(s+1).reduce((e,t)=>e*t),p=2==r&&0==i?n+"[ ":n+"  ",u=2==r&&i==e.shape[s]-1?"":"\n";o+=SPTensors.toString(e,c,s+1,p)+u}o+=2!=r?n+"]":" ]"}return 1==e.dimension?`[${o}]`:o}};try{modules.export={SPTensors:SPTensors,SPMath:SPMath}}catch(e){"undefined"==typeof module?console.log("Modules are not present, you are probably on client, make sure this script is included before the files that require it"):console.error(e)}function Coordinator(){this.entities=new Array(2e4),this.systems=[],this.currentId=0,this.returnedIdStack=[],this.usedIds=new Set}function Entity(){this.id=-1,this.signature=new Set}function Component(e,t){this.name=e,this.values=t}function defineComponent(e,t){let s=function(...s){Component.call(this,e,t(...s))};return s.prototype=Object.create(Component.prototype),s}function constructObject(...e){let t=new Entity;return e.forEach(e=>{e.addTo(t)}),t}function System(e,t){e||console.warn(`Your system with signature:${t.toString()} has invalid coordinator: ${e}`),this.coordinator=e,this.signature=t?new Set(t):null,this.entities=new Set}function defineSystem(e,t,s=(()=>({}))){let n=function(t,...n){System.call(this,t,e);var o=s(...n);assert("object"==typeof o,"Invalid system constructor, constructor needs to return object"),Object.assign(this,o)};return(n.prototype=Object.create(System.prototype)).update=t,n}function Clock(e,t){this.frameTime=1e3/e,this.onTick=t,this.offset=0}function BrowserClock(e){this.onTick=e,this.frameTime=1e3/60,this.lastFrameTime=0,this.tickCounter=0}function SimpleTimer(e=0){this.start=Date.now(),this.length=e}function PeriodicLogger(e){this.broswerClock=e}Coordinator.prototype.addSystem=function(e){this.systems.push(e)},Coordinator.prototype.add=function(e){var t;t=this.returnedIdStack.length>0?this.returnedIdStack.pop():this.currentId++,e.id=t,this.usedIds.add(t),this.entities[t]=e,this.systems.forEach(t=>{t.add(e)})},Coordinator.prototype.remove=function(e){this.entities[e.id]=null,this.returnedIdStack.push(e.id),this.currentId,this.usedIds.delete(e.id),this.systems.forEach(t=>{t.remove(e)})},Coordinator.prototype.removeId=function(e){this.remove(this.entities[e])},Coordinator.prototype.removeAll=function(){for(;this.usedIds.size>0;)this.removeId(this.usedIds.values().next().value)},Coordinator.prototype.update=function(e){this.systems.forEach(t=>{t.update(e)})},Entity.prototype.addComponent=function(e,t){return this[e]=t,this.signature.add(e),this},Entity.prototype.addTo=function(e){return e.add(this),this},Component.prototype.addTo=function(e){e.addComponent(this.name,this.values)},System.prototype.add=function(e){if(this.signature){for(let t of this.signature)if(!e.signature.has(t))return;this.entities.add(e.id)}},System.prototype.remove=function(e){this.entities.delete(e.id)},System.prototype.getEntities=function*(){for(let e of this.entities)yield this.coordinator.entities[e]},System.prototype.addTo=function(e){return e.addSystem(this),this},System.prototype.update=function(){},Clock.prototype.start=function(){this.lastMillisTimer=Date.now(),this.lastMillis=Date.now(),this.lastFrameTime=Date.now(),this.loop()},Clock.prototype.loop=function(){let e=Date.now();if(e-this.lastFrameTime>=this.frameTime-this.offset){var t=e-this.lastFrameTime;this.onTick(t/this.frameTime),this.lastFrameTime=e,(t=Date.now()-this.lastMillisTimer)>=1e3?(console.log("FPS:"+this.frameCounter),this.frameCounter=0,this.lastMillisTimer=Date.now()):this.frameCounter+=1,this.offset=Date.now()-e}setTimeout(()=>{this.loop()})},BrowserClock.prototype.start=function(){window.requestAnimationFrame(e=>{this.update(e)})},BrowserClock.prototype.update=function(e){let t=e-this.lastFrameTime;this.onTick(t/this.frameTime),this.lastFrameTime=e,this.tickCounter=(this.tickCounter+1)%60,window.requestAnimationFrame(e=>{this.update(e)})},SimpleTimer.prototype.delta=function(){return Date.now()-this.start},SimpleTimer.prototype.isDone=function(){return this.delta()>=this.length},SimpleTimer.prototype.lap=function(){return this.start=Date.now(),this.start},PeriodicLogger.prototype.log=function(...e){this.broswerClock.tickCounter%60==0&&console.log(...e)};const Transform=defineComponent("tran",e=>({pos:SPTensors.vector(e),rot:0})),Movement=defineComponent("mov",(e=[0,0],t=[0,0])=>({acc:SPTensors.vector(t),vel:SPTensors.vector(e)})),RigidBody=defineComponent("rig",(e,t="aabb",s=null)=>({rad:SPTensors.vector(e),shape:t,polygon:s?s.copy((t,s)=>t*e[s%2]):null})),Meta=defineComponent("meta",e=>({type:e})),DNNComponent=defineComponent("dnn",(e,t,s,n,o=null)=>({network:new dnn(e,s,t,n,o)})),Genome=defineComponent("genome",e=>({genes:e})),EvolutionComponent=defineComponent("evolution",e=>({spieces:e,dead:!1,fitness:0})),MouseFollow=defineComponent("mfollow",()=>({})),Material=defineComponent("mat",e=>({color:e})),Eyes=defineComponent("eyes",(e,t,s,n=null,o=null)=>({count:e,radius:t,output:null,angle:s,types:new ABList(n,o)}));function posRadToBounds(e,t){return{pos:SPTensors.vector([e.x-t.x,e.y-t.y]),dims:SPTensors.mult(t,2)}}function posRadToRect(e,t){return SPTensors.vector([e.x-t.x,e.y-t.y,2*t.x,2*t.y])}function entityGetBounds(e){return posRadToBounds(e.tran.pos,e.rig.rad)}function ChunkSystem(e){System.call(this,e,["tran","rig","meta"]),this.map={},this.chunkSize=250}function VelocitySystem(e){System.call(this,e,["tran","mov"])}function RenderingSystem(e,t){System.call(this,e,["tran","rig","mat"]),this.renderer=t}function EyeSystem(e,t){System.call(this,e,["tran","meta","eyes"]),this.chunkSystem=t}function MouseFollowerSystem(e,t){System.call(this,e,["tran","mfollow"]),this.mouseListener=t}function AvoiderSystem(e){System.call(this,e,["rigidbody","eye","dnn"])}function WorldFoldingSystem(e,t,s){System.call(this,e,["tran"]),this.onObjectPorted=s,this.bounds=t}function onObjectPorted(e){"boid"==e.objectType&&boidResetFitness(e)}function EvolutionSystem(e,t){System.call(this,e,["genome","evolution"]),this.spieces=t,this.spiecesTypes=Object.keys(t),this.timer=new SimpleTimer(5e3)}function CollisionSystem(e,t,s){System.call(this,e,["tran","rig"]),this.chunkSystem=t,this.onCollision=s}function DraggingSystem(e,t,s){System.call(this,e),this.mouseListener=t,this.renderer=s,this.button=0,this.dragging=!1,this.dragStart=!1}function Renderer2D(e){this.canvas=e,this.ctx=e.ctx}function Canvas(e=null){this.canvas=document.createElement("CANVAS"),this.width=this.canvas.width,this.height=this.canvas.height,this.canvas.oncontextmenu=function(e){e.preventDefault()},this.ctx=this.canvas.getContext("2d"),null===e?document.body.appendChild(this.canvas):document.getElementById(e).appendChild(this.canvas)}function MouseListener(e){this.activeTypes=["mousedown","mouseup"],this.pressedButtons=Array(3).fill(!1),this.m=SPTensors.vector([0,0]),this.dm=SPTensors.vector([0,0]),this.target=e,this.onUpdate=(()=>{})}function Camera(e,t=[0,0],s=0,n=[1,1]){this.screenSize=SPTensors.vector(e),this.pos=SPTensors.vector(t),this.rot=s,this.scale=SPTensors.vector(n)}ChunkSystem.prototype=Object.create(System.prototype),ChunkSystem.prototype.update=function(e){this.map={};for(let e of this.getEntities()){let{pos:n,dims:o}=entityGetBounds(e),{a:r,b:i}=this.getChunkBoundsCoords(n,o);for(var t=r.y;t<=i.y;t++)for(var s=r.x;s<=i.x;s++)void 0===this.map[`${s}-${t}`]&&(this.map[`${s}-${t}`]=new Set),this.map[`${s}-${t}`].add(e.id)}},ChunkSystem.prototype.remove=function(e){this.entities.delete(e.id);let{pos:t,dims:s}=posRadToBounds(e.tran.pos,e.rig.rad),{a:n,b:o}=this.getChunkBoundsCoords(t,s);for(var r=n.y;r<=o.y;r++)for(var i=n.x;i<=o.x;i++)void 0!==this.map[`${i}-${r}`]&&this.map[`${i}-${r}`].delete(e.id)},ChunkSystem.prototype.getChunkBoundsCoords=function(e,t){return{a:SPTensors.copy(e,e=>Math.floor(e/this.chunkSize)),b:SPTensors.copy(SPTensors.add(e,t),e=>Math.floor(e/this.chunkSize))}},ChunkSystem.prototype.getObjectsInRect=function(e,t,s){let n=new Set,{a:o,b:r}=this.getChunkBoundsCoords(e,t),i=SPTensors.link([e,t],[4]);for(var a=o.y;a<=r.y;a++)for(var h=o.x;h<=r.x;h++)void 0!==this.map[`${h}-${a}`]&&this.map[`${h}-${a}`].forEach(e=>{if(this.coordinator.entities[e]){var t=this.coordinator.entities[e];if(!s||s(t)){var o=posRadToBounds(t.tran.pos,t.rig.rad),r=SPTensors.link([o.pos,o.dims],[4]);SPMath.rectCollision(i,r)&&n.add(t)}}});return n},VelocitySystem.prototype=Object.create(System.prototype),VelocitySystem.prototype.update=function(e){for(let t of this.getEntities())t.tran.pos.add(SPTensors.mult(t.mov.vel,e)),t.mov.vel.add(SPTensors.mult(t.mov.acc,e))},RenderingSystem.prototype=Object.create(System.prototype),RenderingSystem.prototype.update=function(e){for(let e of this.getEntities()){this.renderer.setColor(e.mat.color);let t=e.tran.pos,s=e.rig.rad;if(this.transformer&&(t=this.transformer.transformPoint(t),s=this.transformer.transformScale(s)),"aabb"==e.rig.shape)this.renderer.drawRect(SPTensors.sub(t,s),SPTensors.mult(s,2));else if("circle"==e.rig.shape)this.renderer.fillCircle(t,s.x);else if("polygon"==e.rig.shape){let s=SPMath.rotatePolygon(e.rig.polygon,SPTensors.vector([0,0]),e.tran.rot);this.renderer.fillPolygon(SPTensors.add(s,t,!0))}else assert(!1,`${e.rig.shape} is not supported by RenderingSystem`)}},EyeSystem.prototype=Object.create(System.prototype),EyeSystem.prototype.update=function(e){for(let e of this.getEntities()){var t=[],s=e.tran.pos.copy(),n=e.tran.pos.copy();(t=SPMath.polarPoints(e.eyes.count,e.tran.pos,e.eyes.radius,e.tran.rot,e.eyes.angle)).forEach(e=>{(!s.x||e.x<s.x)&&(s.x=e.x),(!s.y||e.y<s.y)&&(s.y=e.y),(!n.x||e.x>n.x)&&(n.x=e.x),(!n.y||e.y>n.y)&&(n.y=e.y)});var o=this.chunkSystem.getObjectsInRect(s,SPTensors.sub(n,s),t=>e.eyes.types.allowed(t.meta.type));e.eyes.output=[],renderer.setColor("rgb(0, 0, 0, 0.5)"),t.forEach((t,s)=>{let n=SPTensors.link([e.tran.pos,t],[2,2]);var r=0;o.forEach(t=>{if(t.id!=e.id){var s=posRadToRect(t.tran.pos,t.rig.rad),o=SPMath.rectToPolygon(s);SPMath.polygoneLineIntersection(n,o).forEach(t=>{var s=1-SPMath.distance(e.tran.pos,t)/e.eyes.radius;s>r&&(r=s)})}}),e.eyes.output.push(r),r>0&&renderer.drawLine(e.tran.pos,t)})}},MouseFollowerSystem.prototype=Object.create(System.prototype),MouseFollowerSystem.prototype.update=function(e){for(let e of this.getEntities())e.tran.pos=mouseListener.m.copy(),chunkSystem.getObjectsInRect(SPTensors.sub(e.tran.pos,e.rig.rad),SPTensors.mult(e.rig.rad,2)).forEach(e=>{e.mat.color="red"})},AvoiderSystem.prototype=Object.create(System.prototype),AvoiderSystem.prototype.update=function(e){for(let e of this.getEntities())if(e.eyeOutput){let t=SPTensors.vector(e.eyeOutput).reshape([1,e.eyeCount]),s=e.dnn.forward(t);e.rot+=s.x/10,e.vel=SPMath.getUnitVector(e.rot).mult(5*s.y)}},WorldFoldingSystem.prototype=Object.create(System.prototype),WorldFoldingSystem.prototype.update=function(e){for(entity of this.getEntities())SPMath.rectContains(this.bounds,entity.tran.pos)||(entity.tran.pos.x=SPMath.posmodRange(entity.tran.pos.x,this.bounds.x,this.bounds.x+this.bounds.width),entity.tran.pos.y=SPMath.posmodRange(entity.tran.pos.y,this.bounds.y,this.bounds.y+this.bounds.height),this.onObjectPorted&&this.onObjectPorted(entity))},EvolutionSystem.prototype=Object.create(System.prototype),Object.defineProperty(EvolutionSystem.prototype,"period",{get:function(){return this.timer.length},set:function(e){return this.timer.length=e,this.timer.lap(),this.timer.length}}),EvolutionSystem.prototype.update=function(e){if(this.timer.isDone()){var t=Array.from(this.getEntities());for(let e of this.spiecesTypes){var s=t.filter(t=>t.evolution.spieces==e);s.sort((e,t)=>t.evolution.fitness-e.evolution.fitness),this.spieces[e].onGenerationEnds(s)}this.timer.lap()}else for(let e of this.getEntities())e.fitness=this.spieces[e.evolution.spieces].fitnessFunction(e)},CollisionSystem.prototype=Object.create(System.prototype),CollisionSystem.prototype.update=function(){for(let s of this.getEntities()){var e=entityGetBounds(s),t=this.chunkSystem.getObjectsInRect(e.pos,e.dims);for(let e of t)s.id!=e.id&&this.onCollision(s,e)}},DraggingSystem.prototype=Object.create(System.prototype),DraggingSystem.prototype.update=function(e){let t=this.mouseListener.pressedButtons[this.button];!this.dragging&&t&&(this.dragging=!0,this.dragStart=this.mouseListener.m.copy()),this.dragging&&t&&this.renderer.drawRect(SPMath.getRect(this.dragStart,this.mouseListener.m)),this.dragging&&!t&&(this.onDragFinished&&this.onDragFinished(SPMath.getRect(this.dragStart,this.mouseListener.m)),this.dragging=!1)},Renderer2D.prototype.setColor=function(e){this.ctx.fillStyle=e,this.ctx.strokeStyle=e},Renderer2D.prototype.drawLine=function(e,t){this.ctx.beginPath(),this.ctx.moveTo(e.x,e.y),this.ctx.lineTo(t.x,t.y),this.ctx.stroke()},Renderer2D.prototype.rectPath=function(e,t){void 0===t?(this.ctx.beginPath(),this.ctx.rect(e.x,e.y,e.width,e.height)):(this.ctx.beginPath(),this.ctx.rect(e.x,e.y,t.x,t.y))},Renderer2D.prototype.drawRect=function(e,t){this.rectPath(e,t),this.ctx.stroke()},Renderer2D.prototype.fillRect=function(e,t){this.rectPath(e,t),this.ctx.fill()},Renderer2D.prototype.circlePath=function(e,t,s=0,n=360){this.ctx.beginPath(),this.ctx.arc(e.x,e.y,t,s,n)},Renderer2D.prototype.drawCircle=function(e,t,s=0,n=360){this.circlePath(e,t,s,n),this.ctx.stroke()},Renderer2D.prototype.fillCircle=function(e,t,s=0,n=360){this.circlePath(e,t,s,n),this.ctx.fill()},Renderer2D.prototype.polygonPath=function(e,t=!0){this.ctx.beginPath();var s=e.subTensor([0]);this.ctx.moveTo(s.x,s.y);let n=e.shape[0];for(var o=1;o<n;o++){var r=e.subTensor([o]);this.ctx.lineTo(r.x,r.y)}t&&this.ctx.closePath()},Renderer2D.prototype.drawPolygon=function(e,t=!0){this.polygonPath(e,t),this.ctx.stroke()},Renderer2D.prototype.fillPolygon=function(e){this.polygonPath(e),this.ctx.fill()},Renderer2D.prototype.drawText=function(e,t){this.ctx.fillText(e,t.x,t.y)},Renderer2D.prototype.drawFunction=function(e,t,s,n,o){for(var r=[],i=null,a=null,h=t;h<s;h+=n){var c=e(h);(!i||c<i)&&(i=c),(!a||c>a)&&(a=c),r.push([h,c])}var p=[],u=r.length,l=o.width/(u-1),d=a-i;for(h=0;h<u;h++){var y=r[h],m=o.x+l*h;c=o.y+(1-(y[1]-i)/d)*o.height,p.push(m),p.push(c)}if(SPMath.inRange(0,i,a)){var f=o.y+(1-(0-i)/d)*o.height;this.drawLine(SPMath.point(o.x,f),SPMath.point(o.x+o.width,f))}this.drawPolygon(new Tensor([u,2],p),!1),this.drawText(a.toFixed(2),SPMath.point(o.x+o.width,o.y)),this.drawText(i.toFixed(2),SPMath.point(o.x+o.width,o.y+o.height)),this.drawText(t.toFixed(2),SPMath.point(o.x,o.y+o.height+20)),this.drawText(s.toFixed(2),SPMath.point(o.x+o.width,o.y+o.height+20))},Canvas.prototype.fullScreen=function(){return this.resize(window.innerWidth,window.innerHeight),this},Canvas.prototype.resize=function(e,t){return this.width=e,this.height=t,this.canvas.width=e,this.canvas.height=t,this},Canvas.prototype.renderBackground=function(){this.ctx.beginPath(),this.ctx.rect(0,0,this.canvas.width,this.canvas.height),this.ctx.fillStyle="white",this.ctx.fill()},Canvas.prototype.clear=function(){this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this.renderBackground()},MouseListener.prototype.initListener=function(){return this.target.onmousedown=(e=>{this.pressedButtons[e.button]=!0,this.onUpdate()}),this.target.onmouseup=(e=>{this.pressedButtons[e.button]=!1,this.onUpdate()}),this.target.onmousemove=(e=>{let t=this.m.x,s=this.m.y;this.m.x=e.clientX,this.m.y=e.clientY,this.dm.x=this.m.x-t,this.dm.y=this.m.y-s,this.onUpdate()}),this},Camera.prototype.transformPoint=function(e){var t=Math.sin(this.rot),s=Math.cos(this.rot);let{x:n,y:o}=e;var r=this.scale.x*((n-this.pos.x)*s-(-o+this.pos.y)*t)+this.screenSize.x/2,i=this.scale.y*((n-this.pos.x)*t+(-o+this.pos.y)*s)+this.screenSize.y/2;return SPTensors.vector([r,i])},Camera.prototype.transformScale=function(e){return SPTensors.mult(e,this.scale)};let coordinator=new Coordinator,browserClock=new BrowserClock(function(e){canvas.clear(),coordinator.update(e)}),periodicLogger=new PeriodicLogger(browserClock),devContainer={n:2,e:40,sigma:80,timeSpeed:20,forceBounds:1},devui=new DevUI("spool-root",devContainer);devui.addRange("n",0,10,.1),devui.addRange("e",0,1e3,20),devui.addRange("sigma",0,200,5),devui.addRange("timeSpeed",0,100,5),devui.addRange("forceBounds",0,20,.1),devui.addButton("restart",e=>{coordinator.removeAll()}),devui.addButton('preset - "Real"',e=>{Object.assign(devContainer,{n:6,e:160,sigma:95,timeSpeed:50,forceBounds:20}),devui.refresh()}),devui.addButton("preset - star",e=>{Object.assign(devContainer,{n:1,e:250,sigma:110,timeSpeed:50,forceBounds:6.3}),devui.refresh()}),devui.addButton("preset - orbits",e=>{Object.assign(devContainer,{n:.3,e:1e3,sigma:135,timeSpeed:30,forceBounds:10}),devui.refresh()});let canvas=new Canvas("spool-root");canvas.fullScreen();let canvasRect=SPTensors.vector([-canvas.width/2,-canvas.height/2,canvas.width,canvas.height]),renderer=new Renderer2D(canvas),camera=new Camera([canvas.width,canvas.height]),renderingSystem=new RenderingSystem(coordinator,renderer);renderingSystem.addTo(coordinator),renderingSystem.transformer=camera;const ParticleComponent=defineComponent("particle",e=>({mass:e}));function forceFunction(e,t,s){const n=Math.log2(1+t+s),o=devContainer.e*n,r=devContainer.sigma*n,i=devContainer.n,a=Math.pow(r/e,i);return SPMath.clamp(4*o*(a*a-a)/300,-devContainer.forceBounds,devContainer.forceBounds)}function particleRadius(e){return Math.sqrt(40*e/Math.PI)}function particleUpdate(e){var t=new Set(this.entities);for(let e of t){var s=this.coordinator.entities[e],n=s.rig.rad,o=s.tran.pos;renderer.setColor(s.particle.fixed?"red":"black");for(let e of this.entities){var r=this.coordinator.entities[e];if(!r.particle.fixed&&r.id!=s.id){var i=r.tran.pos,a=r.rig.rad,h=SPMath.distance(o,i);if(h<n.values[0]+a.values[0]){this.coordinator.remove(s),i.values[0]=(i.values[0]*r.particle.mass+o.values[0]*s.particle.mass)/(r.particle.mass+s.particle.mass),i.values[1]=(i.values[1]*r.particle.mass+o.values[1]*s.particle.mass)/(r.particle.mass+s.particle.mass),r.particle.mass=r.particle.mass+s.particle.mass,a.apply(e=>particleRadius(r.particle.mass));break}var c=(h+forceFunction(h,s.particle.mass,r.particle.mass)*devContainer.timeSpeed/100/Math.log2(r.particle.mass+1))/h;i.values[0]=(i.values[0]-o.values[0])*c+o.values[0],i.values[1]=(i.values[1]-o.values[1])*c+o.values[1]}}}}const ParticleSystem=defineSystem(["tran","rig","particle"],particleUpdate),chunkSystem=new ChunkSystem(coordinator);coordinator.addSystem(chunkSystem);const particleSystem=new ParticleSystem(coordinator);coordinator.addSystem(particleSystem);const spawningRect=SPMath.rect(-1,-1,2,2);function spawnParticle(e=1){let t=particleRadius(e),s=constructObject(new Transform(SPMath.randPointInRect(SPTensors.div(SPTensors.mult(spawningRect,(canvasRect.width+canvasRect.height)/4),camera.scale,!0)).values),new RigidBody([t,t],"circle"),new Material("red"),new ParticleComponent(e),new Meta("particle"));return s.addTo(coordinator),s}const mouseListener=new MouseListener(canvas.canvas).initListener(),CameraMovementSystem=defineSystem(null,function(e){this.mouseListener.pressedButtons[0]?(camera.pos.x+=-this.mouseListener.dm.x/camera.scale.x,camera.pos.y+=this.mouseListener.dm.y/camera.scale.y):this.mouseListener.pressedButtons[2]&&(camera.scale.x*=1+this.mouseListener.dm.y/100,camera.scale.y*=1+this.mouseListener.dm.y/100),this.mouseListener.dm.x=0,this.mouseListener.dm.y=0},e=>({mouseListener:e}));coordinator.addSystem(new CameraMovementSystem(coordinator,mouseListener));const SpawningSystem=defineSystem(null,function(e){this.browserClock.tickCounter%2==0&&spawnParticle()},(e,t)=>({mouseListener:e,browserClock:t}));coordinator.addSystem(new SpawningSystem(coordinator,mouseListener,browserClock));const GraphSystem=defineSystem(null,function(e){this.renderer.drawFunction(e=>forceFunction(e,1,1),0,800,5,SPMath.rect(20,20,200,100))},e=>({renderer:e}));coordinator.addSystem(new GraphSystem(coordinator,renderer)),browserClock.start();