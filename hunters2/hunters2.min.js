function assert(e,t){if(!e)throw new Error(t)}function arraysEqual(e,t){if(e===t)return!0;if(null==e||null==t)return!1;if(e.length!==t.length)return!1;for(var n=0;n<e.length;++n)e[n]!==t[n]&&console.log(n);return!0}function ABList(e,t){this.allow=e?new Set(e):null,this.block=t?new Set(t):null}ABList.prototype.allowed=function(e){return(!this.block||!this.block.has(e))&&(!this.allow||this.allow.has(e))};const SPMath={polarPoint:(e,t,n)=>SPTensors.vector([e.x+t*Math.cos(n),e.y+t*Math.sin(n)]),polarPoints:(e,t,n=1,o=0,s=0)=>{for(var r=[],i=0;i<e;i++){var a=SPMath.polarPoint(t,n,(i-(e-1)/2)*s+o);r.push(a)}return r},rotatePoint:(e,t,n)=>{var o=Math.sin(n),s=Math.cos(n),r=SPTensors.sub(e,t);return SPTensors.vector([r.x*s+r.y*o+t.x,r.x*o-r.y*s+t.y])},rotatePoints:(e,t,n)=>e.map(e=>rotatePoint(e,t,n)),rotatePolygon:(e,t,n)=>{let o=e.copy(),s=o.shape[0];for(let e=0;e<s;e++){var r=o.subTensor([e]),i=SPMath.rotatePoint(r,t,n);o.set(2*e,i.x),o.set(2*e+1,i.y)}return o},transformPoints:(e,t)=>e.map(e=>SPTensors.add(e,t)),distance:function(e,t){return Math.sqrt(Math.pow(e.x-t.x,2)+Math.pow(e.y-t.y,2))},angleDistance:function(e,t){var n=(t-e)%(2*Math.PI);return n>0?n>Math.PI?-(2*Math.PI-n):n:n<-Math.PI?-(-2*Math.PI-n):n},getRect:function(e,t){var n=Math.min(e.x,t.x),o=Math.min(e.y,t.y),s=Math.abs(e.x-t.x),r=Math.abs(e.y-t.y);return SPTensors.vector([n,o,s,r])},rectToPolygon:function(e){return SPTensors.tensor([4,2],[e.x,e.y,e.x+e.width,e.y,e.x+e.width,e.y+e.height,e.x,e.y+e.height])},rectContains:(e,t)=>e.x<t.x&&t.x<e.x+e.width&&e.y<t.y&&t.y<e.y+e.height,rectCollision:(e,t)=>{let n=SPTensors.vector([e.x-t.width/2,e.y-t.height/2,e.width+t.width,e.height+t.height]),o=SPTensors.vector([t.x+t.width/2,t.y+t.height/2]);return SPMath.rectContains(n,o)},lineIntersection:(e,t)=>{var n=e.x,o=e.xx,s=e.y,r=e.yy,i=t.x,a=t.xx,h=t.y,p=t.yy,u=(n-o)*(h-p)-(s-r)*(i-a);if(0==u)return null;var l=((n*r-s*o)*(i-a)-(n-o)*(i*p-h*a))/u,c=((n*r-s*o)*(h-p)-(s-r)*(i*p-h*a))/u;return SPMath.inRange(l,n,o,2)&&SPMath.inRange(l,i,a,2)&&SPMath.inRange(c,s,r,2)&&SPMath.inRange(c,h,p,2)?SPTensors.vector([l,c]):null},polygoneLineIntersection:(e,t)=>{for(var n=t.shape[0],o=[],s=0;s<t.shape[0];s++){var r=t.subTensor([s]),i=t.subTensor([(s+1)%n]),a=SPTensors.link([r,i],[2,2]),h=SPMath.lineIntersection(e,a);h&&o.push(h)}return o},unitVector:e=>SPTensors.vector([Math.cos(e),Math.sin(e)]),range:function*(e=0,t=100,n=1){let o=0;for(let s=e;s<t;s+=n)o++,yield s;return o},inRange:(e,t,n,o=0)=>{if(t<n)var s=t,r=n;else s=n,r=t;return s-o<=e&&e<=r+o},randRange:(e,t)=>Math.random()*(t-e)+e,sigmoid:e=>1/(1+Math.exp(-e)),posmod:(e,t)=>(e%t+t)%t,posmodRange:(e,t,n)=>t+SPMath.posmod(e-t,n-t)},basicAliases={x:0,y:1,z:2,w:3,xx:2,yy:3,a:0,b:1,c:2,d:3,width:2,height:3};function TensorBase(e){this.shape=e,this.size=SPTensors.getSize(e),this.dimension=SPTensors.getDimensions(e)}function Tensor(e,t=null,n=(()=>0)){if(TensorBase.call(this,e),this.type="fixed",this.levelSizes=SPTensors.getLevelSizes(e),t){if(t.length!=this.size)throw new Error(`The size of values (${t.length}) doesn't match the shape of the tensor (${e})`);this.values=t}else this.values=Array.from({length:this.size},n)}function VariableTensor(e,t,n=(()=>0)){if(TensorBase.call(this,e),this.type="variable",this.indexes=SPTensors.getIndexesMap(e)[0],t){if(t.length!=this.size)throw new Error(`The size of values (${t.length}) doesn't match the shape of the tensor (${e})`);this.values=t}else this.values=Array.from({length:this.size},n)}TensorBase.prototype.getIndex=function(e){return this.getIndexAndShape(e).index},TensorBase.prototype.getValue=function(e){const t=this.getIndex(e);return this.get(t)},TensorBase.prototype.getValues=function(){res=[];for(var e=0;e<this.size;e++)res.push(this.get(e));return res},TensorBase.prototype.T=function(){if(2!=this.dimension)throw`You can only transpose 2-d tensor, not ${this.dimension}-d`;var e=[this.shape[1],this.shape[0]],t=new SubTensor(self,e);return t.get=(e=>{var t=Math.floor(e/this.shape[0]),n=e%this.shape[0];return this.get(n*this.shape[1]+t)}),t},TensorBase.prototype.copy=function(e=((e,t)=>e)){return SPTensors.copy(this,e)},TensorBase.prototype.apply=function(e=((e,t)=>e)){return SPTensors.apply(this,e)},TensorBase.prototype.add=function(e){return"number"==typeof e?this.apply(t=>t+e):this.apply((t,n)=>t+e.get(n))},TensorBase.prototype.sub=function(e){return"number"==typeof e?this.apply(t=>t-e):this.apply((t,n)=>t-e.get(n))},TensorBase.prototype.mult=function(e){return"number"==typeof e?this.apply(t=>t*e):this.apply((t,n)=>t*e.get(n))},TensorBase.prototype.toString=function(){return SPTensors.toString(this)},TensorBase.prototype.reshape=function(e){if(SPTensors.getSize(e)!=this.size)throw new Error(`You can't reshape ${this.size} values into ${e.toString()}`);return this.shape=e,this.dimension=SPTensors.getDimensions(e),this},TensorBase.prototype.subTensor=function(e){if(this.shape.length-e.length<0)throw`${e.length} coords for ${n.length} array`;let{index:t,shape:n}=this.getIndexAndShape(e);return new SubTensor(this,n,t,t+SPTensors.getSize(this.shape))},Object.keys(basicAliases).forEach(function(e){Object.defineProperty(TensorBase.prototype,e,{get:function(){return this.get(basicAliases[e])},set:function(t){return this.set(basicAliases[e],t)}})}),Tensor.prototype=Object.create(TensorBase.prototype),Tensor.prototype.get=function(e){return this.values[e]},Tensor.prototype.getValues=function(){return this.values},Tensor.prototype.set=function(e,t){return this.values[e]=t,this.values[e]},Tensor.prototype.getIndexAndShape=function(e){return SPTensors.getIndexAndShape(this.shape,e,this.levelSizes)},VariableTensor.prototype=Object.create(TensorBase.prototype),VariableTensor.prototype.get=function(e){return this.values[e]},VariableTensor.prototype.set=function(e,t){return this.values[e]=t},VariableTensor.prototype.getIndexAndShape=function(e){return SPTensors.getVariableIndexAndShape(this.shape,e,this.indexes)},VariableTensor.prototype.subTensor=function(e){let{index:t,shape:n}=this.getIndexAndShape(e);return new SubTensor(this,n,t,t+SPTensors.getSize(this.shape))},VariableTensor.prototype.toString=function(){for(var e="",t=0;t<this.shape.length;t++)e+=this.subTensor([t]).toString()+"\n";return e};const isVariable=e=>e.length>0&&e[0].constructor===Array;function SubTensor(e,t,n=null,o=null){TensorBase.call(this,t),this.parent=e,this.start=n,this.end=o,this.type="sub",null===this.start&&(this.start=0),null===this.end&&(this.end=SPTensors.getSize(t)),isVariable(t)?(this.indexes=SPTensors.getIndexesMap(this.shape)[0],this.getIndexAndShape=VariableTensor.prototype.getVariableIndexAndShape):(this.levelSizes=SPTensors.getLevelSizes(this.shape),this.getIndexAndShape=Tensor.prototype.getVariableIndexAndShape)}function LinkTensor(e,t){TensorBase.call(this,t),this.sizes=e.map(e=>e.size),this.tensors=e,this.tensorsNumber=e.length,this.levelSizes=SPTensors.getLevelSizes(t),this.type="link"}SubTensor.prototype=Object.create(TensorBase.prototype),SubTensor.prototype.get=function(e){return this.parent.get(e+this.start)},SubTensor.prototype.set=function(e,t){return this.parent.set(e+this.start,t)},SubTensor.prototype.subTensor=function(e){if(this.shape.length-e.length<0)throw`${e.length} coords for ${n.length} array`;let{index:t,shape:n}=this.getIndex(e);var o=SPTensors.getSize(n);return new SubTensor(this.parent,n,t+start,t+start+o)},SubTensor.prototype.toString=function(){return new Tensor(this.shape,null,(e,t)=>this.get(t)).toString()},LinkTensor.prototype=Object.create(TensorBase.prototype),LinkTensor.prototype.getRelevantTensor=function(e){for(var t=0,n=0;n+this.sizes[t]<=e;)if(t+=1,n+=this.sizes[t],assert(t<this.tensorsNumber,"Index out of range"))return;return{ten:this.tensors[t],off:e-n}},LinkTensor.prototype.get=function(e){let{ten:t,off:n}=this.getRelevantTensor(e);return t.get(n)},LinkTensor.prototype.set=function(e,t){let{ten:n,off:o}=this.getRelevantTensor(e);return n.set(o)},LinkTensor.prototype.getIndexAndShape=function(e){return SPTensors.getIndexAndShape(this.shape,e,this.levelSizes)};var operations=["apply",""],SPTensors={apply:(e,t=((e,t)=>e))=>{assert(e.set&&e.get,"Not a valid tensor");for(var n=0;n<e.size;n++)e.set(n,t(e.get(n),n));return e},copy:(e,t=(e=>e))=>{assert(e.shape&&e.get,"Not a valid tensor");for(var n=e.getValues(),o=[],s=0;s<n.length;s++)o.push(t(n[s],s));return new(SPTensors.constructorForShape(e.shape))(e.shape,o)},tensor:(e,t,n)=>(assert(e),new(SPTensors.constructorForShape(e))(e,t,n)),vector:e=>new Tensor([e.length],e),const:(e,t)=>SPTensors.tensor(e,null,()=>{}),zeros:e=>SPTensors.const(e),ones:e=>SPTensors.const(e,1),constLike:(e,t=0)=>SPTensors.copy(e,()=>t),zerosLike:e=>SPTensors.constLike(a),onesLike:e=>SPTensors.constLike(a,1),random:(e,t=0,n=1)=>new(SPTensors.constructorForShape(e))(e,null,()=>SPMath.randRange(t,n)),randomLike:(e,t=0,n=1)=>SPTensors.copy(e,()=>SPMath.randRange(t,n)),range:(e,t=1)=>new(SPTensors.constructorForShape(e))(e,null,(e,n)=>n*t),elementWiseOperation:(e,t,n,o=!1)=>{var s=e.getValues();if(o)return SPTensors.tensor(e.shape,s.map((e,o)=>n(e,t.get(o%t.size))));assert(arraysEqual(e.shape,t.shape),`The shapes of the tensors don't match: ${e.shape} != ${t.shape}`);for(var r=t.getValues(),i=[],a=0;a<s.length;a++)i.push(n(s[a],r[a]));return SPTensors.tensor(e.shape,i)},add:(e,t,n=!1)=>"number"==typeof t?SPTensors.copy(e,e=>e+t):SPTensors.elementWiseOperation(e,t,(e,t)=>e+t,n),sub:(e,t,n=!1)=>"number"==typeof t?SPTensors.copy(e,e=>e-t):SPTensors.elementWiseOperation(e,t,(e,t)=>e-t,n),mult:(e,t)=>"number"==typeof t?SPTensors.copy(e,e=>e*t):SPTensors.elementWiseOperation(e,t,(e,t)=>e*t),dot:(e,t,n=[],o=[])=>{if(2!=e.dimension&&2!=t.dimension)throw new Error(`Dot product supports only 2-d tensor dot your (${e.dimension}-d . ${t.dimension}-d)`);aValues=e.values,bValues=t.values;let s=e.getIndexAndShape(n),r=s.index,i=s.shape;var a=i[0],h=i[1];let p=t.getIndexAndShape(o),u=p.index,l=p.shape;var c=l[0],d=l[1];if(h!=c)throw`Shapes of the tensors are not compatible for dot ${i} ${l}`;for(var y=[a,d],f=[],m=0;m<a;m++)for(var S=0;S<d;S++){for(var g=0,T=0;T<h;T++)g+=aValues[r+m*h+T]*bValues[u+T*d+S];f.push(g)}return new Tensor(y,f)},concat:(e,t)=>{let n=e.map(e=>e.getValues());return n=n.flat(1),void 0===t?new VariableTensor(e.map(e=>e.shape),[].concat(...e.map(e=>e.values))):new Tensor(t,n)},link:(e,t)=>new LinkTensor(e,t),constructorForShape:e=>{var t=Tensor;return e.length>0&&e[0].constructor===Array&&(t=VariableTensor),t},getIndexAndShape:(e,t,n=null)=>{var o=0;n||(n=SPTensors.getLevelSizes(e)),t.forEach((t,s)=>{if(!SPMath.inRange(t,0,e[s]))throw new Error(`${t} at in depth ${s} is out of range shape - [${e}]`);o+=t*n[1+s]});var s=e.slice(t.length);return{index:o,shape:s}},getVariableIndexAndShape:(e,t,n=null)=>{null===n&&(n=SPTensors.getIndexesMap(s)[0]);for(var o=n,r=e,i={index:o[0],shape:r},a=0;a<t.length;a++){var h=t[a];if(o=o[h],r=r[h],o.constructor!==Array)return(i=SPTensors.getIndexAndShape(r,t.slice(a+1))).index+=o,i;i={index:o[0],shape:r}}return i},getLevelSizes:e=>{for(var t=[1],n=1,o=e.length,s=0;s<o;s++)n*=e[o-s-1],t.push(n);return t.reverse(),t},getSize:e=>0==e.length?1:e[0].constructor===Array?e.map(e=>SPTensors.getSize(e)).reduce((e,t)=>e+t):e.reduce((e,t)=>e*t),getIndexesMap:(e,t=0)=>[e.map(e=>{if(e[0].constructor===Array){var n=SPTensors.getIndexesMap(e,t);return t+=n[1],n[0]}return index=t,t+=e.reduce((e,t)=>e*t),index}),t],getDimensions:e=>e.length,toFixedSize:(e,t=6)=>{for(var n=e.toString();(n.length+1)%t!=0;)n+=" ";return n},toString:(e,t=0,n=0,o="")=>{var s="",r=e.shape.length-n;if(1==r){s+=o;for(var i=0;i<e.shape[e.shape.length-1];i++){var a=6,h=", ";e.dimension<2&&(a=1),i==e.shape[e.shape.length-1]-1&&(a=1,h=""),s+=SPTensors.toFixedSize(e.get(i+t)+h,a)}}else{for(2!=r&&(s+=o+"[\n"),i=0;i<e.shape[n];i++){var p=t+i*e.shape.slice(n+1).reduce((e,t)=>e*t),u=2==r&&0==i?o+"[ ":o+"  ",l=2==r&&i==e.shape[n]-1?"":"\n";s+=SPTensors.toString(e,p,n+1,u)+l}s+=2!=r?o+"]":" ]"}return 1==e.dimension?`[${s}]`:s}};try{modules.export={SPTensors:SPTensors,SPMath:SPMath}}catch(e){"undefined"==typeof module?console.log("Modules are not present, you are probably on client, make sure this script is included before the files that require it"):console.error(e)}function Coordinator(){this.entities=new Array(1e3),this.systems=[],this.currentId=0,this.returnedIdStack=[],this.usedIds=new Set}function Entity(){this.id=-1,this.signature=new Set}function Component(e,t){this.name=e,this.values=t}function defineComponent(e,t){let n=function(...n){Component.call(this,e,t(...n))};return n.prototype=Object.create(Component.prototype),n}function constructObject(...e){let t=new Entity;return e.forEach(e=>{e.addTo(t)}),t}function System(e,t){e||console.warn(`Your system with signature:${t.toString()} has invalid coordinator: ${e}`),this.coordinator=e,this.signature=t?new Set(t):null,this.entities=new Set}function defineSystem(e,t,n){let o=function(n,...o){System.call(this,n,e),t.forEach((e,t)=>{this[e]=o[t]})};return(o.prototype=Object.create(System.prototype)).update=n,o}function Clock(e,t){this.frameTime=1e3/e,this.onTick=t,this.offset=0}function BrowserClock(e){this.onTick=e,this.frameTime=1e3/60,this.lastFrameTime=0,this.tickCounter=0}function SimpleTimer(e=0){this.start=Date.now(),this.length=e}function PeriodicLogger(e){this.broswerClock=e}Coordinator.prototype.addSystem=function(e){this.systems.push(e)},Coordinator.prototype.add=function(e){var t;t=this.returnedIdStack.length>0?this.returnedIdStack.pop():this.currentId++,e.id=t,this.usedIds.add(t),this.entities[t]=e,this.systems.forEach(t=>{t.add(e)})},Coordinator.prototype.remove=function(e){this.entities[e.id]=null,this.returnedIdStack.push(e.id),this.currentId,this.usedIds.delete(e.id),this.systems.forEach(t=>{t.remove(e)})},Coordinator.prototype.removeId=function(e){this.remove(this.entities[e])},Coordinator.prototype.removeAll=function(){for(;this.usedIds.size>0;)this.removeId(this.usedIds.values().next().value)},Coordinator.prototype.update=function(e){this.systems.forEach(t=>{t.update(e)})},Entity.prototype.addComponent=function(e,t){return this[e]=t,this.signature.add(e),this},Entity.prototype.addTo=function(e){return e.add(this),this},Component.prototype.addTo=function(e){e.addComponent(this.name,this.values)},System.prototype.add=function(e){if(this.signature){for(let t of this.signature)if(!e.signature.has(t))return;this.entities.add(e.id)}},System.prototype.remove=function(e){this.entities.delete(e.id)},System.prototype.getEntities=function*(){for(let e of this.entities)yield this.coordinator.entities[e]},System.prototype.addTo=function(e){return e.addSystem(this),this},System.prototype.update=function(){},Clock.prototype.start=function(){this.lastMillisTimer=Date.now(),this.lastMillis=Date.now(),this.lastFrameTime=Date.now(),this.loop()},Clock.prototype.loop=function(){let e=Date.now();if(e-this.lastFrameTime>=this.frameTime-this.offset){var t=e-this.lastFrameTime;this.onTick(t/this.frameTime),this.lastFrameTime=e,(t=Date.now()-this.lastMillisTimer)>=1e3?(console.log("FPS:"+this.frameCounter),this.frameCounter=0,this.lastMillisTimer=Date.now()):this.frameCounter+=1,this.offset=Date.now()-e}setTimeout(()=>{this.loop()})},BrowserClock.prototype.start=function(){window.requestAnimationFrame(e=>{this.update(e)})},BrowserClock.prototype.update=function(e){let t=e-this.lastFrameTime;this.onTick(t/this.frameTime),this.lastFrameTime=e,this.tickCounter=(this.tickCounter+1)%60,window.requestAnimationFrame(e=>{this.update(e)})},SimpleTimer.prototype.delta=function(){return Date.now()-this.start},SimpleTimer.prototype.isDone=function(){return this.delta()>=this.length},SimpleTimer.prototype.lap=function(){return this.start=Date.now(),this.start},PeriodicLogger.prototype.log=function(...e){this.broswerClock.tickCounter%60==0&&console.log(...e)};const Transform=defineComponent("tran",e=>({pos:SPTensors.vector(e),rot:0})),Movement=defineComponent("mov",(e=[0,0],t=[0,0])=>({acc:SPTensors.vector(t),vel:SPTensors.vector(e)})),RigidBody=defineComponent("rig",(e,t="aabb",n=null)=>({rad:SPTensors.vector(e),shape:t,polygon:n?n.copy((t,n)=>t*e[n%2]):null})),Meta=defineComponent("meta",e=>({type:e})),DNNComponent=defineComponent("dnn",(e,t,n,o,s=null)=>({network:new dnn(e,n,t,o,s)})),Genome=defineComponent("genome",e=>({genes:e})),EvolutionComponent=defineComponent("evolution",e=>({spieces:e,dead:!1,fitness:0})),MouseFollow=defineComponent("mfollow",()=>({})),Material=defineComponent("mat",e=>({color:e})),Eyes=defineComponent("eyes",(e,t,n,o=null,s=null)=>({count:e,radius:t,output:null,angle:n,types:new ABList(o,s)}));function posRadToBounds(e,t){return{pos:SPTensors.vector([e.x-t.x,e.y-t.y]),dims:SPTensors.mult(t,2)}}function posRadToRect(e,t){return SPTensors.vector([e.x-t.x,e.y-t.y,2*t.x,2*t.y])}function entityGetBounds(e){return posRadToBounds(e.tran.pos,e.rig.rad)}function ChunkSystem(e){System.call(this,e,["tran","rig","meta","mov"]),this.map={},this.chunkSize=250}function VelocitySystem(e){System.call(this,e,["tran","mov"])}function RenderingSystem(e,t){System.call(this,e,["tran","rig","mat"]),this.renderer=t}function EyeSystem(e,t){System.call(this,e,["tran","meta","eyes"]),this.chunkSystem=t}function MouseFollowerSystem(e,t){System.call(this,e,["tran","mfollow"]),this.mouseListener=t}function AvoiderSystem(e){System.call(this,e,["rigidbody","eye","dnn"])}function WorldFoldingSystem(e,t,n){System.call(this,e,["tran"]),this.onObjectPorted=n,this.bounds=t}function onObjectPorted(e){"boid"==e.objectType&&boidResetFitness(e)}function EvolutionSystem(e,t){System.call(this,e,["genome","evolution"]),this.spieces=t,this.spiecesTypes=Object.keys(t),this.timer=new SimpleTimer(5e3)}function CollisionSystem(e,t,n){System.call(this,e,["tran","rig"]),this.chunkSystem=t,this.onCollision=n}function DraggingSystem(e,t,n){System.call(this,e),this.mouseListener=t,this.renderer=n,this.button=0,this.dragging=!1,this.dragStart=!1}function Renderer2D(e){this.canvas=e,this.ctx=e.ctx}function Canvas(e=null){this.canvas=document.createElement("CANVAS"),this.width=this.canvas.width,this.height=this.canvas.height,this.canvas.oncontextmenu=function(e){e.preventDefault()},this.ctx=this.canvas.getContext("2d"),null===e?document.body.appendChild(this.canvas):document.getElementById(e).appendChild(this.canvas)}function MouseListener(){this.activeTypes=["mousedown","mouseup"],this.pressedButtons=Array(3).fill(!1),this.m=SPTensors.vector([0,0]),this.onUpdate=(()=>{})}function dnn(e,t,n,o,s){this.inputSize=e,this.hLayerSize=t,this.hLayerNumber=n,this.outputSize=o;let r=[],i=[];var a=e,h=o;this.size=n+1;for(var p=0;p<n;p++)h=t,r.push([a,h]),i.push([1,h]),a=t;if(h=o,r.push([a,h]),i.push([1,h]),void 0==s)this.weights=SPTensors.random(r,-1,1),this.biases=SPTensors.random(i,-1,1);else{let e=SPTensors.getSize(r);this.weights=new VariableTensor(r,s.slice(0,e)),this.biases=new VariableTensor(i,s.slice(e))}}ChunkSystem.prototype=Object.create(System.prototype),ChunkSystem.prototype.update=function(e){this.map={};for(let e of this.getEntities()){let{pos:o,dims:s}=entityGetBounds(e),{a:r,b:i}=this.getChunkBoundsCoords(o,s);for(var t=r.y;t<=i.y;t++)for(var n=r.x;n<=i.x;n++)void 0===this.map[`${n}-${t}`]&&(this.map[`${n}-${t}`]=new Set),this.map[`${n}-${t}`].add(e.id)}},ChunkSystem.prototype.remove=function(e){this.entities.delete(e.id);let{pos:t,dims:n}=posRadToBounds(e.tran.pos,e.rig.rad),{a:o,b:s}=this.getChunkBoundsCoords(t,n);for(var r=o.y;r<=s.y;r++)for(var i=o.x;i<=s.x;i++)void 0!==this.map[`${i}-${r}`]&&this.map[`${i}-${r}`].delete(e.id)},ChunkSystem.prototype.getChunkBoundsCoords=function(e,t){return{a:SPTensors.copy(e,e=>Math.floor(e/this.chunkSize)),b:SPTensors.copy(SPTensors.add(e,t),e=>Math.floor(e/this.chunkSize))}},ChunkSystem.prototype.getObjectsInRect=function(e,t,n){let o=new Set,{a:s,b:r}=this.getChunkBoundsCoords(e,t),i=SPTensors.link([e,t],[4]);for(var a=s.y;a<=r.y;a++)for(var h=s.x;h<=r.x;h++)void 0!==this.map[`${h}-${a}`]&&this.map[`${h}-${a}`].forEach(e=>{var t=this.coordinator.entities[e];if(!n||n(t)){var s=posRadToBounds(t.tran.pos,t.rig.rad),r=SPTensors.link([s.pos,s.dims],[4]);SPMath.rectCollision(r,i)&&o.add(t)}});return o},VelocitySystem.prototype=Object.create(System.prototype),VelocitySystem.prototype.update=function(e){for(let t of this.getEntities())t.tran.pos.add(SPTensors.mult(t.mov.vel,e)),t.mov.vel.add(SPTensors.mult(t.mov.acc,e))},RenderingSystem.prototype=Object.create(System.prototype),RenderingSystem.prototype.update=function(e){for(let e of this.getEntities())if(this.renderer.setColor(e.mat.color),"aabb"==e.rig.shape)this.renderer.drawRect(SPTensors.sub(e.tran.pos,e.rig.rad),SPTensors.mult(e.rig.rad,2));else if("circle"==e.rig.shape)this.renderer.fillCircle(e.tran.pos,e.rig.rad.x);else if("polygon"==e.rig.shape){let t=SPMath.rotatePolygon(e.rig.polygon,SPTensors.vector([0,0]),e.tran.rot);this.renderer.fillPolygon(SPTensors.add(t,e.tran.pos,!0))}else assert(!1,`${e.rig.shape} is not supported by RenderingSystem`)},EyeSystem.prototype=Object.create(System.prototype),EyeSystem.prototype.update=function(e){for(let e of this.getEntities()){var t=[],n=e.tran.pos.copy(),o=e.tran.pos.copy();(t=SPMath.polarPoints(e.eyes.count,e.tran.pos,e.eyes.radius,e.tran.rot,e.eyes.angle)).forEach(e=>{(!n.x||e.x<n.x)&&(n.x=e.x),(!n.y||e.y<n.y)&&(n.y=e.y),(!o.x||e.x>o.x)&&(o.x=e.x),(!o.y||e.y>o.y)&&(o.y=e.y)});var s=this.chunkSystem.getObjectsInRect(n,SPTensors.sub(o,n),t=>e.eyes.types.allowed(t.meta.type));e.eyes.output=[],renderer.setColor("rgb(0, 0, 0, 0.5)"),t.forEach((t,n)=>{let o=SPTensors.link([e.tran.pos,t],[2,2]);var r=0;s.forEach(t=>{if(t.id!=e.id){var n=posRadToRect(t.tran.pos,t.rig.rad),s=SPMath.rectToPolygon(n);SPMath.polygoneLineIntersection(o,s).forEach(t=>{var n=1-SPMath.distance(e.tran.pos,t)/e.eyes.radius;n>r&&(r=n)})}}),e.eyes.output.push(r),r>0&&renderer.drawLine(e.tran.pos,t)})}},MouseFollowerSystem.prototype=Object.create(System.prototype),MouseFollowerSystem.prototype.update=function(e){for(let e of this.getEntities())e.tran.pos=mouseListener.m.copy(),chunkSystem.getObjectsInRect(SPTensors.sub(e.tran.pos,e.rig.rad),SPTensors.mult(e.rig.rad,2)).forEach(e=>{e.mat.color="red"})},AvoiderSystem.prototype=Object.create(System.prototype),AvoiderSystem.prototype.update=function(e){for(let e of this.getEntities())if(e.eyeOutput){let t=SPTensors.vector(e.eyeOutput).reshape([1,e.eyeCount]),n=e.dnn.forward(t);e.rot+=n.x/10,e.vel=SPMath.getUnitVector(e.rot).mult(5*n.y)}},WorldFoldingSystem.prototype=Object.create(System.prototype),WorldFoldingSystem.prototype.update=function(e){for(entity of this.getEntities())SPMath.rectContains(this.bounds,entity.tran.pos)||(entity.tran.pos.x=SPMath.posmodRange(entity.tran.pos.x,this.bounds.x,this.bounds.x+this.bounds.width),entity.tran.pos.y=SPMath.posmodRange(entity.tran.pos.y,this.bounds.y,this.bounds.y+this.bounds.height),this.onObjectPorted&&this.onObjectPorted(entity))},EvolutionSystem.prototype=Object.create(System.prototype),Object.defineProperty(EvolutionSystem.prototype,"period",{get:function(){return this.timer.length},set:function(e){return this.timer.length=e,this.timer.lap(),this.timer.length}}),EvolutionSystem.prototype.update=function(e){if(this.timer.isDone()){var t=Array.from(this.getEntities());for(let e of this.spiecesTypes){var n=t.filter(t=>t.evolution.spieces==e);n.sort((e,t)=>t.evolution.fitness-e.evolution.fitness),this.spieces[e].onGenerationEnds(n)}this.timer.lap()}else for(let e of this.getEntities())e.fitness=this.spieces[e.evolution.spieces].fitnessFunction(e)},CollisionSystem.prototype=Object.create(System.prototype),CollisionSystem.prototype.update=function(){for(let n of this.getEntities()){var e=entityGetBounds(n),t=this.chunkSystem.getObjectsInRect(e.pos,e.dims);for(let e of t)n.id!=e.id&&this.onCollision(n,e)}},DraggingSystem.prototype=Object.create(System.prototype),DraggingSystem.prototype.update=function(e){let t=this.mouseListener.pressedButtons[this.button];!this.dragging&&t&&(this.dragging=!0,this.dragStart=this.mouseListener.m.copy()),this.dragging&&t&&this.renderer.drawRect(SPMath.getRect(this.dragStart,this.mouseListener.m)),this.dragging&&!t&&(this.onDragFinished&&this.onDragFinished(SPMath.getRect(this.dragStart,this.mouseListener.m)),this.dragging=!1)},Renderer2D.prototype.setColor=function(e){this.ctx.fillStyle=e,this.ctx.strokeStyle=e},Renderer2D.prototype.drawLine=function(e,t){this.ctx.beginPath(),this.ctx.moveTo(e.x,e.y),this.ctx.lineTo(t.x,t.y),this.ctx.stroke()},Renderer2D.prototype.rectPath=function(e,t){void 0===t?(this.ctx.beginPath(),this.ctx.rect(e.x,e.y,e.width,e.height)):(this.ctx.beginPath(),this.ctx.rect(e.x,e.y,t.x,t.y))},Renderer2D.prototype.drawRect=function(e,t){this.rectPath(e,t),this.ctx.stroke()},Renderer2D.prototype.fillRect=function(e,t){this.rectPath(e,t),this.ctx.fill()},Renderer2D.prototype.circlePath=function(e,t,n=0,o=360){this.ctx.beginPath(),this.ctx.arc(e.x,e.y,t,n,o)},Renderer2D.prototype.drawCircle=function(e,t,n=0,o=360){this.circlePath(e,t,n,o),this.ctx.stroke()},Renderer2D.prototype.fillCircle=function(e,t,n=0,o=360){this.circlePath(e,t,n,o),this.ctx.fill()},Renderer2D.prototype.polygonPath=function(e){this.ctx.beginPath();var t=e.subTensor([0]);this.ctx.moveTo(t.x,t.y);let n=e.shape[0];for(var o=1;o<n;o++){var s=e.subTensor([o]);this.ctx.lineTo(s.x,s.y)}this.ctx.closePath()},Renderer2D.prototype.drawPolygon=function(e){this.polygonPath(e),this.ctx.stroke()},Renderer2D.prototype.fillPolygon=function(e){this.polygonPath(e),this.ctx.fill()},Canvas.prototype.fullScreen=function(){return this.resize(window.innerWidth,window.innerHeight),this},Canvas.prototype.resize=function(e,t){return this.width=e,this.height=t,this.canvas.width=e,this.canvas.height=t,this},Canvas.prototype.renderBackground=function(){this.ctx.beginPath(),this.ctx.rect(0,0,this.canvas.width,this.canvas.height),this.ctx.fillStyle="white",this.ctx.fill()},Canvas.prototype.clear=function(){this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this.renderBackground()},MouseListener.prototype.initListener=function(){document.onmousedown=(e=>{this.pressedButtons[e.button]=!0,this.onUpdate()}),document.onmouseup=(e=>{this.pressedButtons[e.button]=!1,this.onUpdate()}),document.onmousemove=(e=>{this.m.x=e.clientX,this.m.y=e.clientY,this.onUpdate()})},dnn.prototype.toString=function(){return"WEIGHTS\n"+this.weights.toString()+"BIASES\n"+this.biases.toString()},dnn.prototype.vectorize=function(){return SPTensors.concat([this.weights,this.biases],[this.weights.size+this.biases.size])},dnn.prototype.forward=function(e){for(var t=e,n=0;n<this.size;n++)t=SPTensors.dot(t,this.weights,[],[n]).add(this.biases.subTensor([n])).apply(SPMath.sigmoid);return t},dnn.prototype.mutate=function(){var e=new dnn(this.inputSize,this.hLayerSize,this.hLayerNumber,this.outputSize);return e.weights=SPTensors.add(this.weights,SPTensors.randomLike(this.weights,-.25,.25)),e.biases=SPTensors.add(this.biases,SPTensors.randomLike(this.biases,-.25,.25)),e};var coordinator=new Coordinator,canvas=new Canvas("spool-root");canvas.fullScreen();var screenRect=SPTensors.vector([0,0,canvas.width,canvas.height]),renderer=new Renderer2D(canvas),mouseListener=new MouseListener;mouseListener.initListener(),clock=new BrowserClock(e=>{canvas.clear(),coordinator.update(e)}),periodicLogger=new PeriodicLogger(clock);var renderingSystem=new RenderingSystem(coordinator,renderer);coordinator.addSystem(renderingSystem);var velocitySystem=new VelocitySystem(coordinator);coordinator.addSystem(velocitySystem);var chunkSystem=new ChunkSystem(coordinator);coordinator.addSystem(chunkSystem);var eyeSystem=new EyeSystem(coordinator,chunkSystem);coordinator.addSystem(eyeSystem);var worldFoldingSystem=new WorldFoldingSystem(coordinator,screenRect);function onCollision(e,t){"hunter"==e.meta.type&&"food"==t.meta.type&&(e.evolution.fitness+=10,coordinator.remove(t))}coordinator.addSystem(worldFoldingSystem);var collisionSystem=new CollisionSystem(coordinator,chunkSystem,onCollision);function fitnessFunction(e){if(!e.evolution.dead){e.evolution.LTFound.apply((t,n)=>Math.min(t,e.tran.pos.get(n))),e.evolution.RBFound.apply((t,n)=>Math.max(t,e.tran.pos.get(n)));var t=SPTensors.sub(e.evolution.RBFound,e.evolution.LTFound);renderer.setColor("black"),renderer.drawLine(e.tran.pos,e.evolution.LTFound),renderer.drawLine(e.tran.pos,e.evolution.RBFound),renderer.drawLine(e.evolution.RBFound,e.evolution.LTFound),e.fitness=t.getValues().reduce((e,t)=>e*t)*e}}function onGenerationEnds(e){if(0!=e.length){var t=e.slice(0,4);coordinator.removeAll(),spawnFood();for(var n=0;n<BOID_COUNT;n++)spawnHunter(t[n%4].genome.genes)}}coordinator.addSystem(collisionSystem);var evolutionSystem=new EvolutionSystem(coordinator,{hunter:{fitnessFunction:fitnessFunction,onGenerationEnds:onGenerationEnds}}).addTo(coordinator);evolutionSystem.period=1e4;const BoidComponent=defineComponent("hunter",(e,t,n)=>({avoidence:e,cohesion:t,alignment:n})),huntersSystem=new(defineSystem(["tran","hunter","dnn"],[],function(e){for(let n of this.getEntities())if(null!=n.eyes.output){var t=n.dnn.network.forward(SPTensors.vector(n.eyes.output).reshape([1,20]));n.tran.rot+=(t.x-.5)*e,n.mov.vel=SPMath.unitVector(n.tran.rot).mult(3)}}))(coordinator).addTo(coordinator),boidPolygon=SPTensors.tensor([3,2],[-1,-1,-1,1,1,0]),BOID_COUNT=20,spawnHunter=(e=null)=>{var t=constructObject(new Transform([SPMath.randRange(0,canvas.width),SPMath.randRange(0,canvas.height)]),new Movement([0,0],[0,0]),new RigidBody([8,5],"polygon",boidPolygon),new Meta("hunter"),new Eyes(20,100,.1,["food"]),new DNNComponent(20,1,15,1,e),new Material("black"),new EvolutionComponent("hunter"));t.addComponent("hunter",{energy:0}),t.evolution.LTFound=t.tran.pos,t.evolution.RBFound=t.tran.pos,new Genome(t.dnn.network.vectorize().getValues()).addTo(t),t.addTo(coordinator)};for(let e of SPMath.range(0,BOID_COUNT))spawnHunter();const spawnFood=()=>{for(let e of SPMath.range(0,200))constructObject(new Transform([SPMath.randRange(0,canvas.width),SPMath.randRange(0,canvas.height)]),new Movement([0,0],[0,0]),new RigidBody([5,5],"circle"),new Meta("food"),new Material("red")).addTo(coordinator)};spawnFood(),clock.start();