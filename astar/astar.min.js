function assert(t,e){if(!t)throw new Error(e)}function arraysEqual(t,e){if(t===e)return!0;if(null==t||null==e)return!1;if(t.length!==e.length)return!1;for(var n=0;n<t.length;++n)if(t[n]!==e[n])return!1;return!0}function ABList(t,e){this.allow=t?new Set(t):null,this.block=e?new Set(e):null}function Heap(t){this.arr=[],this.size=0,this.comparator=t}function Node(t,e){this.gid=t,Object.assign(this,e)}function Graph(){this.nodes=[],this.connections=[]}function reconstructPath(t,e,n){for(var o=n,s=[];o&&o!=e;)s.push(o),o=t[o];return s.push(e),s.reverse(),s}function aStar(t,e,n,o){opened=new Heap((t,e)=>f[t.gid]-f[e.gid]),openedSet=new Set;var s=t.get(e),r=t.get(n);for(f={[e]:o(s,r)},g={[e]:0},cameFrom={},opened.add(s),openedSet.add(e);opened.size>0;){var i=opened.pop();if(openedSet.delete(i.gid),i.gid==n)return reconstructPath(cameFrom,e,n);for(var a=0;a<t.connections[i.gid].length;a++){var h=t.connections[i.gid][a];let e=t.nodes[h[0]],n=h[1],s=g[i.gid]+n;e.gid in g&&!(s<g[e.gid])||(cameFrom[e.gid]=i.gid,g[e.gid]=s,f[e.gid]=s+o(e,r),e.gid in openedSet||(opened.add(e),openedSet.add(e.gid)))}}return null}ABList.prototype.allowed=function(t){return(!this.block||!this.block.has(t))&&(!this.allow||this.allow.has(t))},Heap.prototype.pop=function(){if(0==this.size)throw"Heap is already empty";var t=this.arr[0];return this.arr[0]=this.arr[this.size-1],this.size--,this.heapDown(),t},Heap.prototype.add=function(t){this.size<this.arr.length?this.arr[this.size]=t:this.arr.push(t),this.size++,this.heapUp()},Heap.prototype.getParent=function(t){return Math.floor((t-1)/2)},Heap.prototype.getLChild=function(t){return Math.floor(2*t+1)},Heap.prototype.getRChild=function(t){return Math.floor(2*t+2)},Heap.prototype.hasParent=function(t){return 0!=t},Heap.prototype.hasLChild=function(t){return 2*t+1<this.size},Heap.prototype.hasRChild=function(t){return 2*t+2<this.size},Heap.prototype.heapUp=function(){for(var t=this.size-1,e=this.getParent(t);this.hasParent(t)&&this.comparator(this.arr[e],this.arr[t])>0;)this.swap(t,e),t=this.getParent(t),e=this.getParent(t)},Heap.prototype.heapDown=function(){for(var t=0;this.hasLChild(t);){var e=this.getLChild(t);if(this.hasRChild(t)&&this.comparator(this.arr[e],this.arr[this.getRChild(t)])>0&&(e=this.getRChild(t)),this.comparator(e,this.arr[t])>0)break;this.swap(e,t),t=e}},Heap.prototype.swap=function(t,e){let n=this.arr[t];this.arr[t]=this.arr[e],this.arr[e]=n},Graph.prototype.get=function(t){return this.nodes[t]},Graph.prototype.addNode=function(t){let e=new Node(this.nodes.length,t);return this.nodes.push(e),this.connections[e.gid]=[],e.gid},Graph.prototype.connect=function(t,e,n=1){t in this.connections||(this.connections[t]=[]),e in this.connections||(this.connections[e]=[]),this.connections[t].push([e,n]),this.connections[e].push([t,n])},Graph.prototype.getNeighbours=function(t){return this.connections[t.gid].map(t=>[this.nodes[t[0]],t[1]])};const SPMath={polarPoint:(t,e,n)=>SPTensors.vector([t.x+e*Math.cos(n),t.y+e*Math.sin(n)]),polarPoints:(t,e,n=1,o=0,s=0)=>{for(var r=[],i=0;i<t;i++){var a=SPMath.polarPoint(e,n,(i-(t-1)/2)*s+o);r.push(a)}return r},rotatePoint:(t,e,n)=>{var o=Math.sin(n),s=Math.cos(n),r=SPTensors.sub(t,e);return SPTensors.vector([r.x*s+r.y*o+e.x,r.x*o-r.y*s+e.y])},rotatePoints:(t,e,n)=>t.map(t=>rotatePoint(t,e,n)),rotatePolygon:(t,e,n)=>{let o=t.copy(),s=o.shape[0];for(let t=0;t<s;t++){var r=o.subTensor([t]),i=SPMath.rotatePoint(r,e,n);o.set(2*t,i.x),o.set(2*t+1,i.y)}return o},transformPoints:(t,e)=>t.map(t=>SPTensors.add(t,e)),distance:function(t,e){return Math.sqrt(Math.pow(t.x-e.x,2)+Math.pow(t.y-e.y,2))},angleDistance:function(t,e){var n=(e-t)%(2*Math.PI);return n>0?n>Math.PI?-(2*Math.PI-n):n:n<-Math.PI?-(-2*Math.PI-n):n},point:function(t,e){return SPTensors.vector([t,e])},rect:function(t,e,n,o){return SPTensors.vector([t,e,n,o])},getRect:function(t,e){var n=Math.min(t.x,e.x),o=Math.min(t.y,e.y),s=Math.abs(t.x-e.x),r=Math.abs(t.y-e.y);return SPTensors.vector([n,o,s,r])},rectToPolygon:function(t){return SPTensors.tensor([4,2],[t.x,t.y,t.x+t.width,t.y,t.x+t.width,t.y+t.height,t.x,t.y+t.height])},rectContains:(t,e)=>t.x<e.x&&e.x<t.x+t.width&&t.y<e.y&&e.y<t.y+t.height,rectCollision:(t,e)=>{let n=SPTensors.vector([t.x-e.width/2,t.y-e.height/2,t.width+e.width,t.height+e.height]),o=SPTensors.vector([e.x+e.width/2,e.y+e.height/2]);return SPMath.rectContains(n,o)},lineIntersection:(t,e)=>{var n=t.x,o=t.xx,s=t.y,r=t.yy,i=e.x,a=e.xx,h=e.y,p=e.yy,c=(n-o)*(h-p)-(s-r)*(i-a);if(0==c)return null;var l=((n*r-s*o)*(i-a)-(n-o)*(i*p-h*a))/c,d=((n*r-s*o)*(h-p)-(s-r)*(i*p-h*a))/c;return SPMath.inRange(l,n,o,2)&&SPMath.inRange(l,i,a,2)&&SPMath.inRange(d,s,r,2)&&SPMath.inRange(d,h,p,2)?SPTensors.vector([l,d]):null},polygoneLineIntersection:(t,e)=>{for(var n=e.shape[0],o=[],s=0;s<e.shape[0];s++){var r=e.subTensor([s]),i=e.subTensor([(s+1)%n]),a=SPTensors.link([r,i],[2,2]),h=SPMath.lineIntersection(t,a);h&&o.push(h)}return o},unitVector:t=>SPTensors.vector([Math.cos(t),Math.sin(t)]),angleFromVec:t=>Math.atan2(t.y,t.x),range:function*(t=0,e=100,n=1){let o=0;for(let s=t;s<e;s+=n)o++,yield s;return o},inRange:(t,e,n,o=0)=>{if(e<n)var s=e,r=n;else s=n,r=e;return s-o<=t&&t<=r+o},clamp:(t,e,n)=>Math.max(Math.min(t,n),e),randRange:(t,e)=>Math.random()*(e-t)+t,randPointInRect:t=>SPTensors.vector([t.x+SPMath.randRange(0,t.width),t.y+SPMath.randRange(0,t.height)]),randPointInRadius:(t,e)=>{var n=SPMath.randRange(0,2*Math.PI),o=SPMath.randRange(0,e);return console.log(n,o),SPMath.polarPoint(t,o,n)},sigmoid:t=>1/(1+Math.exp(-t)),posmod:(t,e)=>(t%e+e)%e,posmodRange:(t,e,n)=>e+SPMath.posmod(t-e,n-e)},basicAliases={x:0,y:1,z:2,w:3,xx:2,yy:3,a:0,b:1,c:2,d:3,width:2,height:3};function TensorBase(t){this.shape=t,this.size=SPTensors.getSize(t),this.dimension=SPTensors.getDimensions(t)}function Tensor(t,e=null,n=(()=>0)){if(TensorBase.call(this,t),this.type="fixed",this.levelSizes=SPTensors.getLevelSizes(t),e){if(e.length!=this.size)throw new Error(`The size of values (${e.length}) doesn't match the shape of the tensor (${t})`);this.values=e}else this.values=Array.from({length:this.size},n)}function VariableTensor(t,e,n=(()=>0)){if(TensorBase.call(this,t),this.type="variable",this.indexes=SPTensors.getIndexesMap(t)[0],e){if(e.length!=this.size)throw new Error(`The size of values (${e.length}) doesn't match the shape of the tensor (${t})`);this.values=e}else this.values=Array.from({length:this.size},n)}TensorBase.prototype.getIndex=function(t){return this.getIndexAndShape(t).index},TensorBase.prototype.getValue=function(t){"number"==typeof t&&(t=[t]);const e=this.getIndex(t);return this.get(e)},TensorBase.prototype.getValues=function(){res=[];for(var t=0;t<this.size;t++)res.push(this.get(t));return res},TensorBase.prototype.T=function(){if(2!=this.dimension)throw`You can only transpose 2-d tensor, not ${this.dimension}-d`;var t=[this.shape[1],this.shape[0]],e=new SubTensor(self,t);return e.get=(t=>{var e=Math.floor(t/this.shape[0]),n=t%this.shape[0];return this.get(n*this.shape[1]+e)}),e},TensorBase.prototype.copy=function(t=((t,e)=>t)){return SPTensors.copy(this,t)},TensorBase.prototype.apply=function(t=((t,e)=>t)){return SPTensors.apply(this,t)},TensorBase.prototype.add=function(t){return"number"==typeof t?this.apply(e=>e+t):this.apply((e,n)=>e+t.get(n))},TensorBase.prototype.sub=function(t){return"number"==typeof t?this.apply(e=>e-t):this.apply((e,n)=>e-t.get(n))},TensorBase.prototype.mult=function(t){return"number"==typeof t?this.apply(e=>e*t):this.apply((e,n)=>e*t.get(n))},TensorBase.prototype.div=function(t){return"number"==typeof t?this.apply(e=>e/t):this.apply((e,n)=>e/t.get(n))},TensorBase.prototype.toString=function(){return SPTensors.toString(this)},TensorBase.prototype.reshape=function(t){if(SPTensors.getSize(t)!=this.size)throw new Error(`You can't reshape ${this.size} values into ${t.toString()}`);return this.shape=t,this.dimension=SPTensors.getDimensions(t),this},TensorBase.prototype.subTensor=function(t){if(this.shape.length-t.length<0)throw`${t.length} coords for ${n.length} array`;let{index:e,shape:n}=this.getIndexAndShape(t);return new SubTensor(this,n,e,e+SPTensors.getSize(this.shape))},Object.keys(basicAliases).forEach(function(t){Object.defineProperty(TensorBase.prototype,t,{get:function(){return this.get(basicAliases[t])},set:function(e){return this.set(basicAliases[t],e)}})}),Tensor.prototype=Object.create(TensorBase.prototype),Tensor.prototype.get=function(t){return this.values[t]},Tensor.prototype.getValues=function(){return this.values},Tensor.prototype.set=function(t,e){return this.values[t]=e,this.values[t]},Tensor.prototype.getIndexAndShape=function(t){return SPTensors.getIndexAndShape(this.shape,t,this.levelSizes)},VariableTensor.prototype=Object.create(TensorBase.prototype),VariableTensor.prototype.get=function(t){return this.values[t]},VariableTensor.prototype.set=function(t,e){return this.values[t]=e},VariableTensor.prototype.getIndexAndShape=function(t){return SPTensors.getVariableIndexAndShape(this.shape,t,this.indexes)},VariableTensor.prototype.subTensor=function(t){let{index:e,shape:n}=this.getIndexAndShape(t);return new SubTensor(this,n,e,e+SPTensors.getSize(this.shape))},VariableTensor.prototype.toString=function(){for(var t="",e=0;e<this.shape.length;e++)t+=this.subTensor([e]).toString()+"\n";return t};const isVariable=t=>t.length>0&&t[0].constructor===Array;function SubTensor(t,e,n=null,o=null){TensorBase.call(this,e),this.parent=t,this.start=n,this.end=o,this.type="sub",null===this.start&&(this.start=0),null===this.end&&(this.end=SPTensors.getSize(e)),isVariable(e)?(this.indexes=SPTensors.getIndexesMap(this.shape)[0],this.getIndexAndShape=VariableTensor.prototype.getVariableIndexAndShape):(this.levelSizes=SPTensors.getLevelSizes(this.shape),this.getIndexAndShape=Tensor.prototype.getVariableIndexAndShape)}function LinkTensor(t,e){TensorBase.call(this,e),this.sizes=t.map(t=>t.size),this.tensors=t,this.tensorsNumber=t.length,this.levelSizes=SPTensors.getLevelSizes(e),this.type="link"}SubTensor.prototype=Object.create(TensorBase.prototype),SubTensor.prototype.get=function(t){return this.parent.get(t+this.start)},SubTensor.prototype.set=function(t,e){return this.parent.set(t+this.start,e)},SubTensor.prototype.subTensor=function(t){if(this.shape.length-t.length<0)throw`${t.length} coords for ${n.length} array`;let{index:e,shape:n}=this.getIndex(t);var o=SPTensors.getSize(n);return new SubTensor(this.parent,n,e+start,e+start+o)},SubTensor.prototype.toString=function(){return new Tensor(this.shape,null,(t,e)=>this.get(e)).toString()},LinkTensor.prototype=Object.create(TensorBase.prototype),LinkTensor.prototype.getRelevantTensor=function(t){for(var e=0,n=0;n+this.sizes[e]<=t;)if(e+=1,n+=this.sizes[e],assert(e<this.tensorsNumber,"Index out of range"))return;return{ten:this.tensors[e],off:t-n}},LinkTensor.prototype.get=function(t){let{ten:e,off:n}=this.getRelevantTensor(t);return e.get(n)},LinkTensor.prototype.set=function(t,e){let{ten:n,off:o}=this.getRelevantTensor(t);return n.set(o)},LinkTensor.prototype.getIndexAndShape=function(t){return SPTensors.getIndexAndShape(this.shape,t,this.levelSizes)};var operations=["apply",""];const SPTensors={apply:(t,e=((t,e)=>t))=>{assert(t.set&&t.get,"Not a valid tensor");for(var n=0;n<t.size;n++)t.set(n,e(t.get(n),n));return t},copy:(t,e=(t=>t))=>{assert(t.shape&&t.get,"Not a valid tensor");for(var n=t.getValues(),o=[],s=0;s<n.length;s++)o.push(e(n[s],s));return new(SPTensors.constructorForShape(t.shape))(t.shape,o)},tensor:(t,e,n)=>(assert(t),new(SPTensors.constructorForShape(t))(t,e,n)),vector:t=>new Tensor([t.length],t),const:(t,e)=>SPTensors.tensor(t,null,()=>{}),zeros:t=>SPTensors.const(t),ones:t=>SPTensors.const(t,1),constLike:(t,e=0)=>SPTensors.copy(t,()=>e),zerosLike:t=>SPTensors.constLike(a),onesLike:t=>SPTensors.constLike(a,1),random:(t,e=0,n=1)=>new(SPTensors.constructorForShape(t))(t,null,()=>SPMath.randRange(e,n)),randomIn:t=>{for(var e=[],n=t.getValues(),o=0;o<size;o++)e.push(SPMath.randRange(0,n[o]));return SPTensors.tensor(t.shape,e)},randomLike:(t,e=0,n=1)=>SPTensors.copy(t,()=>SPMath.randRange(e,n)),range:(t,e=1)=>new(SPTensors.constructorForShape(t))(t,null,(t,n)=>n*e),elementWiseOperation:(t,e,n,o=!1)=>{var s=t.getValues();if(o)return SPTensors.tensor(t.shape,s.map((t,o)=>n(t,e.get(o%e.size))));assert(arraysEqual(t.shape,e.shape),`The shapes of the tensors don't match: ${t.shape} != ${e.shape}`);for(var r=e.getValues(),i=[],a=0;a<s.length;a++)i.push(n(s[a],r[a]));return SPTensors.tensor(t.shape,i)},add:(t,e,n=!1)=>"number"==typeof e?SPTensors.copy(t,t=>t+e):SPTensors.elementWiseOperation(t,e,(t,e)=>t+e,n),sub:(t,e,n=!1)=>"number"==typeof e?SPTensors.copy(t,t=>t-e):SPTensors.elementWiseOperation(t,e,(t,e)=>t-e,n),mult:(t,e,n=!1)=>"number"==typeof e?SPTensors.copy(t,t=>t*e):SPTensors.elementWiseOperation(t,e,(t,e)=>t*e,n),div:(t,e,n=!1)=>"number"==typeof e?SPTensors.copy(t,t=>t*e):SPTensors.elementWiseOperation(t,e,(t,e)=>t/e,n),dot:(t,e,n=[],o=[])=>{if(2!=t.dimension&&2!=e.dimension)throw new Error(`Dot product supports only 2-d tensor dot your (${t.dimension}-d . ${e.dimension}-d)`);aValues=t.values,bValues=e.values;let s=t.getIndexAndShape(n),r=s.index,i=s.shape;var a=i[0],h=i[1];let p=e.getIndexAndShape(o),c=p.index,l=p.shape;var d=l[0],u=l[1];if(h!=d)throw`Shapes of the tensors are not compatible for dot ${i} ${l}`;for(var y=[a,u],f=[],m=0;m<a;m++)for(var g=0;g<u;g++){for(var S=0,v=0;v<h;v++)S+=aValues[r+m*h+v]*bValues[c+v*u+g];f.push(S)}return new Tensor(y,f)},abs:t=>{if(0==t.size)return 0;for(var e=0,n=0;n<t.size;n++)e+=Math.pow(t.getValue(n),2);return Math.sqrt(e)},concat:(t,e)=>{let n=t.map(t=>t.getValues());return n=n.flat(1),void 0===e?new VariableTensor(t.map(t=>t.shape),[].concat(...t.map(t=>t.values))):new Tensor(e,n)},link:(t,e)=>new LinkTensor(t,e),constructorForShape:t=>{var e=Tensor;return t.length>0&&t[0].constructor===Array&&(e=VariableTensor),e},getIndexAndShape:(t,e,n=null)=>{var o=0;n||(n=SPTensors.getLevelSizes(t)),e.forEach((e,s)=>{if(!SPMath.inRange(e,0,t[s]))throw new Error(`${e} at in depth ${s} is out of range shape - [${t}]`);o+=e*n[1+s]});var s=t.slice(e.length);return{index:o,shape:s}},getVariableIndexAndShape:(t,e,n=null)=>{null===n&&(n=SPTensors.getIndexesMap(s)[0]);for(var o=n,r=t,i={index:o[0],shape:r},a=0;a<e.length;a++){var h=e[a];if(o=o[h],r=r[h],o.constructor!==Array)return(i=SPTensors.getIndexAndShape(r,e.slice(a+1))).index+=o,i;i={index:o[0],shape:r}}return i},getLevelSizes:t=>{for(var e=[1],n=1,o=t.length,s=0;s<o;s++)n*=t[o-s-1],e.push(n);return e.reverse(),e},getSize:t=>0==t.length?1:t[0].constructor===Array?t.map(t=>SPTensors.getSize(t)).reduce((t,e)=>t+e):t.reduce((t,e)=>t*e),getIndexesMap:(t,e=0)=>[t.map(t=>{if(t[0].constructor===Array){var n=SPTensors.getIndexesMap(t,e);return e+=n[1],n[0]}return index=e,e+=t.reduce((t,e)=>t*e),index}),e],getDimensions:t=>t.length,toFixedSize:(t,e=6)=>{for(var n=t.toString();(n.length+1)%e!=0;)n+=" ";return n},toString:(t,e=0,n=0,o="")=>{var s="",r=t.shape.length-n;if(1==r){s+=o;for(var i=0;i<t.shape[t.shape.length-1];i++){var a=6,h=", ";t.dimension<2&&(a=1),i==t.shape[t.shape.length-1]-1&&(a=1,h=""),s+=SPTensors.toFixedSize(t.get(i+e)+h,a)}}else{for(2!=r&&(s+=o+"[\n"),i=0;i<t.shape[n];i++){var p=e+i*t.shape.slice(n+1).reduce((t,e)=>t*e),c=2==r&&0==i?o+"[ ":o+"  ",l=2==r&&i==t.shape[n]-1?"":"\n";s+=SPTensors.toString(t,p,n+1,c)+l}s+=2!=r?o+"]":" ]"}return 1==t.dimension?`[${s}]`:s}};try{modules.export={SPTensors:SPTensors,SPMath:SPMath}}catch(t){"undefined"==typeof module?console.log("Modules are not present, you are probably on client, make sure this script is included before the files that require it"):console.error(t)}function Coordinator(){this.entities=new Array(2e4),this.systems=[],this.currentId=0,this.returnedIdStack=[],this.usedIds=new Set}function Entity(){this.id=-1,this.signature=new Set}function Component(t,e){this.name=t,this.values=e}function defineComponent(t,e){let n=function(...n){Component.call(this,t,e(...n))};return n.prototype=Object.create(Component.prototype),n}function constructObject(...t){let e=new Entity;return t.forEach(t=>{t.addTo(e)}),e}function System(t,e){t||console.warn(`Your system with signature:${e.toString()} has invalid coordinator: ${t}`),this.coordinator=t,this.signature=e?new Set(e):null,this.entities=new Set}function defineSystem(t,e,n=(()=>({}))){let o=function(e,...o){System.call(this,e,t);var s=n(...o);assert("object"==typeof s,"Invalid system constructor, constructor needs to return object"),Object.assign(this,s)};return(o.prototype=Object.create(System.prototype)).update=e,o}function Clock(t,e){this.frameTime=1e3/t,this.onTick=e,this.offset=0}function IntervalClock(t,e){this.onTick=t,this.frameTime=1e3/e,this.lastFrameTime=Date.now(),this.tickCounter=0}function BrowserClock(t){this.onTick=t,this.frameTime=1e3/60,this.lastFrameTime=0,this.tickCounter=0}function SimpleTimer(t=0){this.start=Date.now(),this.length=t}function PeriodicLogger(t){this.broswerClock=t}Coordinator.prototype.addSystem=function(t){this.systems.push(t)},Coordinator.prototype.add=function(t){var e;e=this.returnedIdStack.length>0?this.returnedIdStack.pop():this.currentId++,t.id=e,this.usedIds.add(e),this.entities[e]=t,this.systems.forEach(e=>{e.add(t)})},Coordinator.prototype.remove=function(t){this.entities[t.id]=null,this.returnedIdStack.push(t.id),this.currentId,this.usedIds.delete(t.id),this.systems.forEach(e=>{e.remove(t)})},Coordinator.prototype.removeId=function(t){this.remove(this.entities[t])},Coordinator.prototype.removeAll=function(){for(;this.usedIds.size>0;)this.removeId(this.usedIds.values().next().value)},Coordinator.prototype.update=function(t){this.systems.forEach(e=>{e.update(t)})},Entity.prototype.addComponent=function(t,e){return this[t]=e,this.signature.add(t),this},Entity.prototype.addTo=function(t){return t.add(this),this},Component.prototype.addTo=function(t){t.addComponent(this.name,this.values)},System.prototype.add=function(t){if(this.signature){for(let e of this.signature)if(!t.signature.has(e))return;this.entities.add(t.id)}},System.prototype.remove=function(t){this.entities.delete(t.id)},System.prototype.getEntities=function*(){for(let t of this.entities)yield this.coordinator.entities[t]},System.prototype.addTo=function(t){return t.addSystem(this),this},System.prototype.update=function(){},Clock.prototype.start=function(){this.lastMillisTimer=Date.now(),this.lastMillis=Date.now(),this.lastFrameTime=Date.now(),this.loop()},Clock.prototype.loop=function(){let t=Date.now();if(t-this.lastFrameTime>=this.frameTime-this.offset){var e=t-this.lastFrameTime;this.onTick(e/this.frameTime),this.lastFrameTime=t,(e=Date.now()-this.lastMillisTimer)>=1e3?(console.log("FPS:"+this.frameCounter),this.frameCounter=0,this.lastMillisTimer=Date.now()):this.frameCounter+=1,this.offset=Date.now()-t}setTimeout(()=>{this.loop()})},IntervalClock.prototype.start=function(){this.lastFrameTime=Date.now(),setInterval(()=>{this.update()},this.frameTime)},IntervalClock.prototype.update=function(){let t=Date.now(),e=t-this.lastFrameTime;console.log(this),this.onTick(e),this.tickCounter=(this.tickCounter+1)%this.frequency,this.lastFrameTime=t},BrowserClock.prototype.start=function(){window.requestAnimationFrame(t=>{this.update(t)})},BrowserClock.prototype.update=function(t){let e=t-this.lastFrameTime;this.onTick(e/this.frameTime),this.lastFrameTime=t,this.tickCounter=(this.tickCounter+1)%60,window.requestAnimationFrame(t=>{this.update(t)})},SimpleTimer.prototype.delta=function(){return Date.now()-this.start},SimpleTimer.prototype.isDone=function(){return this.delta()>=this.length},SimpleTimer.prototype.lap=function(){return this.start=Date.now(),this.start},PeriodicLogger.prototype.log=function(...t){this.broswerClock.tickCounter%60==0&&console.log(...t)};const Transform=defineComponent("tran",t=>({pos:SPTensors.vector(t),rot:0})),Movement=defineComponent("mov",(t=[0,0],e=[0,0])=>({acc:SPTensors.vector(e),vel:SPTensors.vector(t)})),RigidBody=defineComponent("rig",(t,e="aabb",n=null)=>({rad:SPTensors.vector(t),shape:e,polygon:n?n.copy((e,n)=>e*t[n%2]):null})),Meta=defineComponent("meta",t=>({type:t})),DNNComponent=defineComponent("dnn",(t,e,n,o,s=null)=>({network:new dnn(t,n,e,o,s)})),Genome=defineComponent("genome",t=>({genes:t})),EvolutionComponent=defineComponent("evolution",t=>({spieces:t,dead:!1,fitness:0})),MouseFollow=defineComponent("mfollow",()=>({})),Material=defineComponent("mat",t=>({color:t})),Eyes=defineComponent("eyes",(t,e,n,o=null,s=null)=>({count:t,radius:e,output:null,angle:n,types:new ABList(o,s)}));function posRadToBounds(t,e){return{pos:SPTensors.vector([t.x-e.x,t.y-e.y]),dims:SPTensors.mult(e,2)}}function posRadToRect(t,e){return SPTensors.vector([t.x-e.x,t.y-e.y,2*e.x,2*e.y])}function entityGetBounds(t){return posRadToBounds(t.tran.pos,t.rig.rad)}function ChunkSystem(t){System.call(this,t,["tran","rig","meta"]),this.map={},this.chunkSize=250}function VelocitySystem(t){System.call(this,t,["tran","mov"])}function RenderingSystem(t,e){System.call(this,t,["tran","rig","mat"]),this.renderer=e}function EyeSystem(t,e){System.call(this,t,["tran","meta","eyes"]),this.chunkSystem=e}function MouseFollowerSystem(t,e){System.call(this,t,["tran","mfollow"]),this.mouseListener=e}function AvoiderSystem(t){System.call(this,t,["rigidbody","eye","dnn"])}function WorldFoldingSystem(t,e,n){System.call(this,t,["tran"]),this.onObjectPorted=n,this.bounds=e}function onObjectPorted(t){"boid"==t.objectType&&boidResetFitness(t)}function EvolutionSystem(t,e){System.call(this,t,["genome","evolution"]),this.spieces=e,this.spiecesTypes=Object.keys(e),this.timer=new SimpleTimer(5e3)}function CollisionSystem(t,e,n){System.call(this,t,["tran","rig"]),this.chunkSystem=e,this.onCollision=n}function DraggingSystem(t,e,n){System.call(this,t),this.mouseListener=e,this.renderer=n,this.button=0,this.dragging=!1,this.dragStart=!1}function Renderer2D(t){this.canvas=t,this.ctx=t.ctx}function Canvas(t=null){this.canvas=document.createElement("CANVAS"),this.width=this.canvas.width,this.height=this.canvas.height,this.canvas.oncontextmenu=function(t){t.preventDefault()},this.ctx=this.canvas.getContext("2d"),null===t?document.body.appendChild(this.canvas):document.getElementById(t).appendChild(this.canvas)}function MouseListener(t){this.activeTypes=["mousedown","mouseup"],this.pressedButtons=Array(3).fill(!1),this.m=SPTensors.vector([0,0]),this.dm=SPTensors.vector([0,0]),this.target=t,this.onUpdate=(()=>{})}function Camera(t,e=[0,0],n=0,o=[1,1]){this.screenSize=SPTensors.vector(t),this.pos=SPTensors.vector(e),this.rot=n,this.scale=SPTensors.vector(o)}function DevUI(t,e){this.root=document.createElement("div"),this.root.className="spool-devui-root",this.root.style.position="absolute",this.root.style.bottom="0px",this.root.style.left="0px",this.root.style.padding="1em",this.root.style.width="250px",this.stateContainer=e,this.stateListeners={},document.getElementById(t).appendChild(this.root)}ChunkSystem.prototype=Object.create(System.prototype),ChunkSystem.prototype.update=function(t){this.map={};for(let t of this.getEntities()){let{pos:o,dims:s}=entityGetBounds(t),{a:r,b:i}=this.getChunkBoundsCoords(o,s);for(var e=r.y;e<=i.y;e++)for(var n=r.x;n<=i.x;n++)void 0===this.map[`${n}-${e}`]&&(this.map[`${n}-${e}`]=new Set),this.map[`${n}-${e}`].add(t.id)}},ChunkSystem.prototype.remove=function(t){this.entities.delete(t.id);let{pos:e,dims:n}=posRadToBounds(t.tran.pos,t.rig.rad),{a:o,b:s}=this.getChunkBoundsCoords(e,n);for(var r=o.y;r<=s.y;r++)for(var i=o.x;i<=s.x;i++)void 0!==this.map[`${i}-${r}`]&&this.map[`${i}-${r}`].delete(t.id)},ChunkSystem.prototype.getChunkBoundsCoords=function(t,e){return{a:SPTensors.copy(t,t=>Math.floor(t/this.chunkSize)),b:SPTensors.copy(SPTensors.add(t,e),t=>Math.floor(t/this.chunkSize))}},ChunkSystem.prototype.getObjectsInRect=function(t,e,n){let o=new Set,{a:s,b:r}=this.getChunkBoundsCoords(t,e),i=SPTensors.link([t,e],[4]);for(var a=s.y;a<=r.y;a++)for(var h=s.x;h<=r.x;h++)void 0!==this.map[`${h}-${a}`]&&this.map[`${h}-${a}`].forEach(t=>{if(this.coordinator.entities[t]){var e=this.coordinator.entities[t];if(!n||n(e)){var s=posRadToBounds(e.tran.pos,e.rig.rad),r=SPTensors.link([s.pos,s.dims],[4]);SPMath.rectCollision(i,r)&&o.add(e)}}});return o},VelocitySystem.prototype=Object.create(System.prototype),VelocitySystem.prototype.update=function(t){for(let e of this.getEntities())e.tran.pos.add(SPTensors.mult(e.mov.vel,t)),e.mov.vel.add(SPTensors.mult(e.mov.acc,t))},RenderingSystem.prototype=Object.create(System.prototype),RenderingSystem.prototype.update=function(t){for(let t of this.getEntities()){this.renderer.setColor(t.mat.color);let e=t.tran.pos,n=t.rig.rad;if(this.transformer&&(e=this.transformer.transformPoint(e),n=this.transformer.transformScale(n)),"aabb"==t.rig.shape)this.renderer.drawRect(SPTensors.sub(e,n),SPTensors.mult(n,2));else if("circle"==t.rig.shape)this.renderer.fillCircle(e,n.x);else if("polygon"==t.rig.shape){let n=SPMath.rotatePolygon(t.rig.polygon,SPTensors.vector([0,0]),t.tran.rot);this.renderer.fillPolygon(SPTensors.add(n,e,!0))}else assert(!1,`${t.rig.shape} is not supported by RenderingSystem`)}},EyeSystem.prototype=Object.create(System.prototype),EyeSystem.prototype.update=function(t){for(let t of this.getEntities()){var e=[],n=t.tran.pos.copy(),o=t.tran.pos.copy();(e=SPMath.polarPoints(t.eyes.count,t.tran.pos,t.eyes.radius,t.tran.rot,t.eyes.angle)).forEach(t=>{(!n.x||t.x<n.x)&&(n.x=t.x),(!n.y||t.y<n.y)&&(n.y=t.y),(!o.x||t.x>o.x)&&(o.x=t.x),(!o.y||t.y>o.y)&&(o.y=t.y)});var s=this.chunkSystem.getObjectsInRect(n,SPTensors.sub(o,n),e=>t.eyes.types.allowed(e.meta.type));t.eyes.output=[],renderer.setColor("rgb(0, 0, 0, 0.5)"),e.forEach((e,n)=>{let o=SPTensors.link([t.tran.pos,e],[2,2]);var r=0;s.forEach(e=>{if(e.id!=t.id){var n=posRadToRect(e.tran.pos,e.rig.rad),s=SPMath.rectToPolygon(n);SPMath.polygoneLineIntersection(o,s).forEach(e=>{var n=1-SPMath.distance(t.tran.pos,e)/t.eyes.radius;n>r&&(r=n)})}}),t.eyes.output.push(r),r>0&&renderer.drawLine(t.tran.pos,e)})}},MouseFollowerSystem.prototype=Object.create(System.prototype),MouseFollowerSystem.prototype.update=function(t){for(let t of this.getEntities())t.tran.pos=mouseListener.m.copy(),chunkSystem.getObjectsInRect(SPTensors.sub(t.tran.pos,t.rig.rad),SPTensors.mult(t.rig.rad,2)).forEach(t=>{t.mat.color="red"})},AvoiderSystem.prototype=Object.create(System.prototype),AvoiderSystem.prototype.update=function(t){for(let t of this.getEntities())if(t.eyeOutput){let e=SPTensors.vector(t.eyeOutput).reshape([1,t.eyeCount]),n=t.dnn.forward(e);t.rot+=n.x/10,t.vel=SPMath.getUnitVector(t.rot).mult(5*n.y)}},WorldFoldingSystem.prototype=Object.create(System.prototype),WorldFoldingSystem.prototype.update=function(t){for(entity of this.getEntities())SPMath.rectContains(this.bounds,entity.tran.pos)||(entity.tran.pos.x=SPMath.posmodRange(entity.tran.pos.x,this.bounds.x,this.bounds.x+this.bounds.width),entity.tran.pos.y=SPMath.posmodRange(entity.tran.pos.y,this.bounds.y,this.bounds.y+this.bounds.height),this.onObjectPorted&&this.onObjectPorted(entity))},EvolutionSystem.prototype=Object.create(System.prototype),Object.defineProperty(EvolutionSystem.prototype,"period",{get:function(){return this.timer.length},set:function(t){return this.timer.length=t,this.timer.lap(),this.timer.length}}),EvolutionSystem.prototype.update=function(t){if(this.timer.isDone()){var e=Array.from(this.getEntities());for(let t of this.spiecesTypes){var n=e.filter(e=>e.evolution.spieces==t);n.sort((t,e)=>e.evolution.fitness-t.evolution.fitness),this.spieces[t].onGenerationEnds(n)}this.timer.lap()}else for(let t of this.getEntities())t.fitness=this.spieces[t.evolution.spieces].fitnessFunction(t)},CollisionSystem.prototype=Object.create(System.prototype),CollisionSystem.prototype.update=function(){for(let n of this.getEntities()){var t=entityGetBounds(n),e=this.chunkSystem.getObjectsInRect(t.pos,t.dims);for(let t of e)n.id!=t.id&&this.onCollision(n,t)}},DraggingSystem.prototype=Object.create(System.prototype),DraggingSystem.prototype.update=function(t){let e=this.mouseListener.pressedButtons[this.button];!this.dragging&&e&&(this.dragging=!0,this.dragStart=this.mouseListener.m.copy()),this.dragging&&e&&this.renderer.drawRect(SPMath.getRect(this.dragStart,this.mouseListener.m)),this.dragging&&!e&&(this.onDragFinished&&this.onDragFinished(SPMath.getRect(this.dragStart,this.mouseListener.m)),this.dragging=!1)},Renderer2D.prototype.setColor=function(t){this.ctx.fillStyle=t,this.ctx.strokeStyle=t},Renderer2D.prototype.drawLine=function(t,e){this.ctx.beginPath(),this.ctx.moveTo(t.x,t.y),this.ctx.lineTo(e.x,e.y),this.ctx.stroke()},Renderer2D.prototype.rectPath=function(t,e){void 0===e?(this.ctx.beginPath(),this.ctx.rect(t.x,t.y,t.width,t.height)):(this.ctx.beginPath(),this.ctx.rect(t.x,t.y,e.x,e.y))},Renderer2D.prototype.drawRect=function(t,e){this.rectPath(t,e),this.ctx.stroke()},Renderer2D.prototype.fillRect=function(t,e){this.rectPath(t,e),this.ctx.fill()},Renderer2D.prototype.circlePath=function(t,e,n=0,o=360){this.ctx.beginPath(),this.ctx.arc(t.x,t.y,e,n,o)},Renderer2D.prototype.drawCircle=function(t,e,n=0,o=360){this.circlePath(t,e,n,o),this.ctx.stroke()},Renderer2D.prototype.fillCircle=function(t,e,n=0,o=360){this.circlePath(t,e,n,o),this.ctx.fill()},Renderer2D.prototype.polygonPath=function(t,e=!0){this.ctx.beginPath();var n=t.subTensor([0]);this.ctx.moveTo(n.x,n.y);let o=t.shape[0];for(var s=1;s<o;s++){var r=t.subTensor([s]);this.ctx.lineTo(r.x,r.y)}e&&this.ctx.closePath()},Renderer2D.prototype.drawPolygon=function(t,e=!0){this.polygonPath(t,e),this.ctx.stroke()},Renderer2D.prototype.fillPolygon=function(t){this.polygonPath(t),this.ctx.fill()},Renderer2D.prototype.drawText=function(t,e){this.ctx.fillText(t,e.x,e.y)},Renderer2D.prototype.drawFunction=function(t,e,n,o,s){for(var r=[],i=null,a=null,h=e;h<n;h+=o){var p=t(h);(!i||p<i)&&(i=p),(!a||p>a)&&(a=p),r.push([h,p])}var c=[],l=r.length,d=s.width/(l-1),u=a-i;for(h=0;h<l;h++){var y=r[h],f=s.x+d*h;p=s.y+(1-(y[1]-i)/u)*s.height,c.push(f),c.push(p)}if(SPMath.inRange(0,i,a)){var m=s.y+(1-(0-i)/u)*s.height;this.drawLine(SPMath.point(s.x,m),SPMath.point(s.x+s.width,m))}this.drawPolygon(new Tensor([l,2],c),!1),this.drawText(a.toFixed(2),SPMath.point(s.x+s.width,s.y)),this.drawText(i.toFixed(2),SPMath.point(s.x+s.width,s.y+s.height)),this.drawText(e.toFixed(2),SPMath.point(s.x,s.y+s.height+20)),this.drawText(n.toFixed(2),SPMath.point(s.x+s.width,s.y+s.height+20))},Canvas.prototype.fullScreen=function(){return this.resize(window.innerWidth,window.innerHeight),this},Canvas.prototype.resize=function(t,e){return this.width=t,this.height=e,this.canvas.width=t,this.canvas.height=e,this},Canvas.prototype.renderBackground=function(){this.ctx.beginPath(),this.ctx.rect(0,0,this.canvas.width,this.canvas.height),this.ctx.fillStyle="white",this.ctx.fill()},Canvas.prototype.clear=function(){this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this.renderBackground()},MouseListener.prototype.initListener=function(){return this.target.onmousedown=(t=>{this.pressedButtons[t.button]=!0,this.onUpdate(t)}),this.target.onmouseup=(t=>{this.pressedButtons[t.button]=!1,this.onUpdate(t)}),this.target.onmousemove=(t=>{let e=this.m.x,n=this.m.y;this.m.x=t.clientX,this.m.y=t.clientY,this.dm.x=this.m.x-e,this.dm.y=this.m.y-n,this.onUpdate(t)}),this},Camera.prototype.transformPoint=function(t){var e=Math.sin(this.rot),n=Math.cos(this.rot);let{x:o,y:s}=t;var r=this.scale.x*((o-this.pos.x)*n-(-s+this.pos.y)*e)+this.screenSize.x/2,i=this.scale.y*((o-this.pos.x)*e+(-s+this.pos.y)*n)+this.screenSize.y/2;return SPTensors.vector([r,i])},Camera.prototype.inverseTransformPoint=function(t){var e=Math.sin(this.rot),n=Math.cos(this.rot);let{x:o,y:s}=t;var r=this.pos.y-(-e*(o/this.scale.x-this.screenSize.x/2)+n*(s/this.scale.y-this.screenSize.y/2)),i=n*(o/this.scale.x-this.screenSize.x/2)+e*(s/this.scale.y-this.screenSize.y/2)+this.pos.x;return SPTensors.vector([i,r])},Camera.prototype.transformScale=function(t){return SPTensors.mult(t,this.scale)},DevUI.prototype.refresh=function(){for(const t of Object.keys(this.stateListeners))this.stateListeners[t](this.stateContainer[t])},DevUI.prototype.addRange=function(t,e=0,n=5,o=1,s){void 0===s?s=this.stateContainer[t]:this.stateContainer[t]=s;let r=document.createElement("div");r.className="spool-devui-range",r.style.paddingBottom="0.3em",r.style.paddingTop="0.3em";let i=document.createElement("p");i.innerHTML=t+": "+s,this.stateListeners[t]=(e=>{i.innerHTML=t+": "+e,a.value=e}),i.style.margin="0px",r.appendChild(i);let a=document.createElement("input");a.type="range",a.min=e,a.max=n,a.step=o,a.value=s,a.className="spool-devui-range-input",a.style.width="100%",a.oninput=(e=>{i.innerHTML=t+": "+e.target.value,this.stateContainer[t]=e.target.value,e.preventDefault()}),r.appendChild(a),this.root.appendChild(r)},DevUI.prototype.addButton=function(t,e){let n=document.createElement("div");n.style.paddingTop="0.3em",n.style.paddingBottom="0.3em";var o=document.createElement("button");o.innerHTML=t,o.style.width="100%",o.onclick=e,o.style.borderRadius="10px",n.appendChild(o),this.root.appendChild(n)};let coordinator=new Coordinator,browserClock=new BrowserClock(function(t){canvas.clear(),coordinator.update(t)},1),periodicLogger=new PeriodicLogger(browserClock),PATH=[],canvas=new Canvas("spool-root");canvas.fullScreen();let canvasRect=SPTensors.vector([-canvas.width/2,-canvas.height/2,canvas.width,canvas.height]),renderer=new Renderer2D(canvas),camera=new Camera([canvas.width,canvas.height]),renderingSystem=new RenderingSystem(coordinator,renderer);renderingSystem.addTo(coordinator),renderingSystem.transformer=camera;const mouseListener=new MouseListener(canvas.canvas);mouseListener.initListener();const TravelerComponent=defineComponent("traveler",t=>{}),TowerComponent=defineComponent("tower",()=>({}));function travellingUpdate(t){for(let t of this.getEntities());}const TravellingSystem=defineSystem(["tran","meta","traveler"],travellingUpdate),travellingSystem=new TravellingSystem(coordinator);travellingSystem.addTo(coordinator);const aStarH=(t,e)=>SPTensors.abs(SPTensors.sub(t.tran.pos,e.tran.pos));function towerUpdate(t){var e=null,n=null,o=camera.inverseTransformPoint(mouseListener.m);for(let t of this.getEntities()){for(var s=t,r=0;r<graph.connections[s.gid].length;r++){var i=graph.connections[s.gid][r],a=graph.nodes[i[0]];renderer.setColor("#11111105"),renderer.drawLine(camera.transformPoint(s.tran.pos),camera.transformPoint(a.tran.pos))}let h=SPMath.distance(s.tran.pos,o);(!e||h<n)&&(e=s,n=h)}if(renderer.setColor("red"),renderer.fillCircle(camera.transformPoint(e.tran.pos),10),renderer.fillCircle(camera.transformPoint(graph.nodes[0].tran.pos),10),PATH=aStar(graph,0,e.gid,aStarH))for(var h=0;h<PATH.length-1;h++){s=graph.nodes[PATH[h]],a=graph.nodes[PATH[h+1]];renderer.drawLine(camera.transformPoint(s.tran.pos),camera.transformPoint(a.tran.pos))}}const TowerSystem=defineSystem(["tran","meta","tower"],towerUpdate),towerSystem=new TowerSystem(coordinator);towerSystem.addTo(coordinator);var graph=new Graph;const boidPolygon=SPTensors.tensor([3,2],[-1,-1,-1,1,1,0]),traveler=function(){constructObject(new Transform(SPMath.randPointInRect(canvasRect).values),new RigidBody([8,5],"polygon",boidPolygon),new Meta("traveler"),new Material("blue"),new TravelerComponent(3)).addTo(coordinator)};var TOWER_COUNT=300;function spawnTowers(){var t=[];const e=function(e){let n=constructObject(new Transform(SPMath.randPointInRect(canvasRect).values),new RigidBody([5,5],"circle"),new Material(e),new Meta("tower"),new TowerComponent);n.addTo(coordinator),n.gid=graph.addNode(n),t.push(n),n.addTo(coordinator)};for(var n=0;n<TOWER_COUNT;n++)e("transparent");for(n=0;n<t.length;n++)for(var o=0;o<t.length;o++)n!=o&&(distance=aStarH(t[n],t[o]),distance<150&&graph.connect(n,o,distance))}spawnTowers(),browserClock.start();